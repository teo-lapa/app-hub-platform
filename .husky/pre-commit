#!/bin/sh
# ğŸš¨ PRE-COMMIT HOOK - Verifica conformitÃ  ODOO_AUTH_SYSTEM.md

echo "ğŸ” Verificando conformitÃ  ODOO_AUTH_SYSTEM.md..."

# Cerca credenziali hardcoded
echo "ğŸ” Controllo credenziali hardcoded..."

# Lista di pattern pericolosi
DANGEROUS_PATTERNS=(
  "paul@lapa.ch"
  "lapa201180"
  "FALLBACK_LOGIN"
  "FALLBACK_PASSWORD"
  "|| 'admin'"
  "|| \"admin\""
  "password.*=.*['\"].*['\"]"
)

FOUND_ISSUES=0

for pattern in "${DANGEROUS_PATTERNS[@]}"; do
  if git diff --cached --name-only | xargs grep -l "$pattern" 2>/dev/null; then
    echo "âŒ ERRORE: Trovata credenziale hardcoded: $pattern"
    FOUND_ISSUES=1
  fi
done

# Verifica uso di odoo-client.ts deprecato in nuovi file
echo "ğŸ” Controllo uso di lib/odoo-client.ts deprecato..."
NEW_FILES=$(git diff --cached --name-only --diff-filter=A | grep "\.ts$\|\.tsx$")

for file in $NEW_FILES; do
  if grep -q "from.*odoo-client" "$file" 2>/dev/null; then
    echo "âŒ ERRORE: $file usa odoo-client.ts DEPRECATO"
    echo "   Usa invece: import { getOdooSession, callOdoo } from '@/lib/odoo-auth'"
    FOUND_ISSUES=1
  fi
done

# Verifica che nuove API route controllino i cookie
API_FILES=$(git diff --cached --name-only --diff-filter=A | grep "app/api/.*route\.ts$")

for file in $API_FILES; do
  if ! grep -q "cookies()" "$file" 2>/dev/null; then
    echo "âš ï¸  WARNING: $file potrebbe non controllare i cookie utente"
    echo "   Verifica che usi getOdooSession(cookies().toString())"
  fi
done

if [ $FOUND_ISSUES -eq 1 ]; then
  echo ""
  echo "ğŸš¨ğŸš¨ğŸš¨ COMMIT BLOCCATO ğŸš¨ğŸš¨ğŸš¨"
  echo ""
  echo "Il tuo codice viola le regole di ODOO_AUTH_SYSTEM.md"
  echo ""
  echo "REGOLE:"
  echo "  âŒ NESSUNA credenziale hardcoded"
  echo "  âŒ NESSUN uso di odoo-client.ts"
  echo "  âœ… Usa getOdooSession() e callOdoo()"
  echo "  âœ… Verifica cookie odoo_session_id"
  echo "  âœ… Ritorna 401 se utente non loggato"
  echo ""
  echo "Vedi: app-hub-platform/ODOO_AUTH_SYSTEM.md"
  echo ""
  exit 1
fi

echo "âœ… Verifica completata - Codice conforme!"
exit 0
