<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catalogo Venditori - App Completa</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            min-height: 100vh;
        }

        /* Header principale con stato connessione */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .connection-status {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #ff4757;
            transition: background-color 0.3s ease;
        }

        .status-dot.connected {
            background-color: #2ed573;
        }

        /* Controlli principali */
        .main-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1rem;
        }

        .category-filters {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 0.6rem 1.2rem;
            border: 2px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.1);
            color: white;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            font-weight: 500;
            min-height: 44px;
        }

        .filter-btn:hover, .filter-btn.active {
            background: rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.6);
            transform: translateY(-1px);
        }

        .search-container {
            position: relative;
            flex: 1;
            min-width: 250px;
        }

        .search-input {
            width: 100%;
            padding: 0.8rem 1.2rem;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            background: rgba(255,255,255,0.9);
            transition: all 0.3s ease;
            min-height: 44px;
        }

        .search-input:focus {
            outline: none;
            background: white;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }

        .search-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            margin-top: 5px;
        }

        .search-dropdown.show {
            display: block;
        }

        .search-item {
            padding: 1rem;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: all 0.2s ease;
            color: #333;
        }

        .search-item:hover {
            background: #e3f2fd;
            color: #1976d2;
        }

        .search-item:last-child {
            border-bottom: none;
        }

        /* Toggles avanzati */
        .advanced-filters {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .toggle-switch {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 15px;
            background: rgba(255,255,255,0.1);
            transition: all 0.3s ease;
        }

        .toggle-switch:hover {
            background: rgba(255,255,255,0.2);
        }

        .toggle-switch input {
            display: none;
        }

        .toggle-slider {
            width: 40px;
            height: 20px;
            background: rgba(255,255,255,0.3);
            border-radius: 20px;
            position: relative;
            transition: all 0.3s ease;
        }

        .toggle-slider::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .toggle-switch input:checked + .toggle-slider {
            background: #2ed573;
        }

        .toggle-switch input:checked + .toggle-slider::after {
            transform: translateX(20px);
        }

        /* Cliente selezionato */
        .selected-client {
            background: rgba(255,255,255,0.15);
            border-radius: 15px;
            padding: 1rem;
            margin-top: 1rem;
            display: none;
            backdrop-filter: blur(10px);
        }

        .selected-client.active {
            display: block;
        }

        .client-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .client-details {
            flex: 1;
        }

        .client-name {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 0.3rem;
        }

        .client-meta {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .client-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .client-btn {
            padding: 0.5rem 1rem;
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            min-height: 44px;
        }

        .client-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-1px);
        }

        /* AI Assistant Panel */
        .ai-panel {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 300px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            z-index: 200;
            display: none;
            max-height: 70vh;
            overflow: hidden;
        }

        .ai-panel.show {
            display: flex;
            flex-direction: column;
        }

        .ai-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ai-chat {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            max-height: 300px;
        }

        .ai-input-area {
            padding: 1rem;
            border-top: 1px solid #eee;
        }

        .ai-input {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid #ddd;
            border-radius: 15px;
            resize: none;
            min-height: 80px;
        }

        .ai-suggestions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
            flex-wrap: wrap;
        }

        .ai-chip {
            padding: 0.3rem 0.8rem;
            background: #e3f2fd;
            color: #1976d2;
            border-radius: 15px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .ai-chip:hover {
            background: #1976d2;
            color: white;
        }

        /* Toggle AI Assistant */
        .ai-toggle {
            position: fixed;
            right: 20px;
            bottom: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            z-index: 150;
            transition: all 0.3s ease;
            color: white;
            font-size: 1.5rem;
        }

        .ai-toggle:hover {
            transform: scale(1.1);
        }

        /* Main content */
        .main-content {
            padding: 1.5rem;
            max-width: 1600px;
            margin: 0 auto;
        }

        /* Grid prodotti */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .product-card {
            background: white;
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            position: relative;
            cursor: pointer;
            overflow: hidden;
        }

        .product-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

        .product-image {
            width: 100%;
            height: 180px;
            background: #f8f9fa;
            border-radius: 15px;
            margin-bottom: 1rem;
            position: relative;
            overflow: hidden;
        }

        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 15px;
        }

        .product-image.no-image {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            color: #ddd;
        }

        /* Badge e indicatori */
        .product-badges {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .badge {
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-align: center;
            min-width: 60px;
        }

        .badge.category {
            background: #3498db;
            color: white;
        }

        .badge.trend {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            color: white;
            animation: pulse 2s infinite;
        }

        .badge.offer {
            background: linear-gradient(45deg, #f39c12, #e67e22);
            color: white;
        }

        .badge.bestseller {
            background: linear-gradient(45deg, #9b59b6, #8e44ad);
            color: white;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .product-info {
            flex: 1;
        }

        .product-name {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: #2c3e50;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .product-description {
            color: #7f8c8d;
            font-size: 0.9rem;
            margin-bottom: 1rem;
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .product-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.8rem;
            margin-bottom: 1rem;
        }

        .detail-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 0.8rem;
            text-align: center;
        }

        .detail-label {
            font-size: 0.8rem;
            color: #6c757d;
            margin-bottom: 0.3rem;
            font-weight: 500;
        }

        .detail-value {
            font-weight: 700;
            font-size: 1rem;
        }

        .detail-value.price {
            color: #27ae60;
            font-size: 1.2rem;
        }

        .detail-value.stock {
            color: #e74c3c;
        }

        .detail-value.stock.in-stock {
            color: #27ae60;
        }

        .detail-value.stock.warning {
            color: #f39c12;
        }

        /* Availability indicator */
        .availability-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .availability-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e74c3c;
        }

        .availability-dot.available {
            background: #27ae60;
        }

        .availability-dot.warning {
            background: #f39c12;
        }

        /* Cronologia cliente */
        .client-history {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border-radius: 15px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: none;
        }

        .client-history.show {
            display: block;
        }

        .history-title {
            font-weight: 600;
            color: #1976d2;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .history-item {
            font-size: 0.85rem;
            color: #424242;
            margin-bottom: 0.3rem;
        }

        /* Azioni prodotto */
        .product-actions {
            display: flex;
            gap: 0.8rem;
        }

        .action-btn {
            flex: 1;
            padding: 0.8rem 1rem;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            min-height: 44px;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #e67e22;
            transform: translateY(-2px);
        }

        /* Carrello floating */
        .cart-summary {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: white;
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            min-width: 300px;
            max-width: 400px;
            z-index: 100;
            display: none;
            max-height: 60vh;
            overflow: hidden;
        }

        .cart-summary.show {
            display: flex;
            flex-direction: column;
        }

        .cart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #eee;
        }

        .cart-title {
            font-size: 1.2rem;
            font-weight: 700;
        }

        .cart-count {
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .cart-items {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 1rem;
            max-height: 200px;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .cart-item:last-child {
            border-bottom: none;
        }

        .cart-item-info {
            flex: 1;
        }

        .cart-item-name {
            font-weight: 600;
            margin-bottom: 0.3rem;
            font-size: 0.9rem;
        }

        .cart-item-details {
            font-size: 0.8rem;
            color: #666;
        }

        .cart-item-price {
            font-weight: 700;
            color: #27ae60;
        }

        .cart-total {
            border-top: 2px solid #eee;
            padding-top: 1rem;
            margin-bottom: 1rem;
        }

        .cart-total-line {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .cart-total-line.final {
            font-size: 1.2rem;
            font-weight: 700;
            color: #2c3e50;
            border-top: 1px solid #ddd;
            padding-top: 0.5rem;
        }

        .cart-actions {
            display: flex;
            gap: 0.8rem;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 25px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #eee;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2c3e50;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: #999;
            transition: color 0.3s ease;
        }

        .close-btn:hover {
            color: #e74c3c;
        }

        /* Loading states */
        .loading {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
            font-size: 1.1rem;
        }

        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Notifiche toast */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 15px;
            color: white;
            font-weight: 600;
            z-index: 10000;
            max-width: 350px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast.success {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
        }

        .toast.error {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .toast.warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }

        .toast.info {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                gap: 1.2rem;
            }

            .ai-panel {
                width: 280px;
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 1rem 0.75rem;
            }

            .main-controls {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }

            .category-filters {
                justify-content: center;
                gap: 0.5rem;
            }

            .filter-btn {
                padding: 0.7rem 1rem;
                font-size: 0.85rem;
            }

            .search-container {
                min-width: auto;
            }

            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
                gap: 1rem;
                padding: 0 0.5rem;
            }

            .product-card {
                padding: 1rem;
            }

            .product-image {
                height: 150px;
            }

            .main-content {
                padding: 1rem;
            }

            .cart-summary {
                bottom: 10px;
                left: 10px;
                right: 10px;
                min-width: auto;
                max-width: none;
            }

            .ai-panel {
                right: 10px;
                left: 10px;
                width: auto;
                top: 20px;
                transform: none;
                max-height: calc(100vh - 40px);
            }

            .ai-toggle {
                right: 15px;
                bottom: 15px;
            }

            .modal-content {
                margin: 1rem;
                width: calc(100% - 2rem);
                padding: 1.5rem;
            }
        }

        @media (max-width: 480px) {
            .products-grid {
                grid-template-columns: 1fr;
                gap: 0.8rem;
            }

            .filter-btn {
                flex: 1;
                min-width: calc(50% - 0.25rem);
                text-align: center;
            }

            .product-details {
                grid-template-columns: 1fr;
            }

            .product-actions {
                flex-direction: column;
                gap: 0.5rem;
            }

            .cart-actions {
                flex-direction: column;
            }
        }

        /* Miglioramenti accessibilità */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Focus indicators */
        button:focus, input:focus, .product-card:focus {
            outline: 3px solid #3498db;
            outline-offset: 2px;
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .product-card {
                border: 2px solid #333;
            }

            .filter-btn {
                border-color: rgba(255,255,255,0.8);
            }
        }
    </style>


    
    <div class="header">
        
        <div class="connection-status">
            <div class="status-indicator">
                <div class="status-dot" id="connectionDot"></div>
                <span id="connectionStatus">Connessione in corso...</span>
            </div>
            <div style="font-weight: 700; font-size: 1.1rem;">🛍️ Catalogo Venditori</div>
        </div>

        
        <div class="main-controls">
            
            <div class="category-filters">
                <button class="filter-btn active" data-category="all">Tutti</button>
                <button class="filter-btn" data-category="frigo" data-category-id="6">❄️ Frigo</button>
                <button class="filter-btn" data-category="secco" data-category-ids="8,10">📦 Secco</button>
                <button class="filter-btn" data-category="surgelati" data-category-id="11">🧊 Surgelati</button>
                <button class="filter-btn" data-category="nonfood" data-category-id="19">🧽 Non-Food</button>
            </div>

            
            <div class="search-container">
                <input type="text" class="search-input" id="productSearch" placeholder="🔍 Cerca prodotti per nome...">
                <div class="search-dropdown" id="productDropdown"></div>
            </div>

            
            <div class="search-container">
                <input type="text" class="search-input" id="clientSearch" placeholder="👤 Cerca e seleziona cliente...">
                <div class="search-dropdown" id="clientDropdown"></div>
            </div>
        </div>

        
        <div class="advanced-filters">
            <label class="toggle-switch">
                <input type="checkbox" id="toggleAvailable">
                <div class="toggle-slider"></div>
                <span>Solo Disponibili</span>
            </label>
            <label class="toggle-switch">
                <input type="checkbox" id="toggleOffers">
                <div class="toggle-slider"></div>
                <span>In Offerta</span>
            </label>
            <label class="toggle-switch">
                <input type="checkbox" id="toggleBestsellers">
                <div class="toggle-slider"></div>
                <span>Best Seller</span>
            </label>
            <label class="toggle-switch">
                <input type="checkbox" id="toggleTrending">
                <div class="toggle-slider"></div>
                <span>Trend</span>
            </label>
        </div>

        
        <div class="selected-client" id="selectedClient">
            <div class="client-info">
                <div class="client-details">
                    <div class="client-name" id="clientName"></div>
                    <div class="client-meta" id="clientMeta"></div>
                </div>
                <div class="client-actions">
                    <button class="client-btn" id="showClientProducts">📋 Prodotti Acquistati</button>
                    <button class="client-btn" id="showClientHistory">📊 Cronologia</button>
                    <button class="client-btn" id="createOrder">📝 Nuovo Ordine</button>
                    <button class="client-btn" onclick="clearClient()">❌ Rimuovi</button>
                </div>
            </div>
        </div>
    </div>

    
    <div class="main-content">
        
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding: 1rem; background: white; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
            <div>
                <span id="productsCount">0</span> prodotti trovati
                <span id="currentFilter" style="color: #666; margin-left: 1rem;"></span>
            </div>
            <div style="display: flex; gap: 1rem; align-items: center;">
                <button id="loadMoreBtn" class="action-btn btn-primary" style="display: none;">
                    Carica Altri (100)
                </button>
                <button id="refreshBtn" class="action-btn btn-warning" onclick="refreshProducts()">
                    🔄 Aggiorna
                </button>
            </div>
        </div>

        
        <div id="productsContainer" class="products-grid">
            <div class="loading">
                <div class="loading-spinner"></div>
                Caricamento catalogo prodotti da Odoo...
            </div>
        </div>

        
        <div style="text-align: center; margin: 2rem 0; display: none;" id="loadMoreContainer">
            <div style="color: #666; margin-bottom: 1rem;">
                Prodotti caricati: <span id="loadedCount">0</span>
            </div>
        </div>
    </div>

    
    <div class="cart-summary" id="cartSummary">
        <div class="cart-header">
            <h3 class="cart-title">🛒 Carrello</h3>
            <div class="cart-count" id="cartCount">0</div>
        </div>
        <div class="cart-items" id="cartItems"></div>
        <div class="cart-total" id="cartTotal"></div>
        <div class="cart-actions">
            <button class="action-btn btn-warning" onclick="clearCart()">Svuota</button>
            <button class="action-btn btn-success" onclick="finalizeOrder()">Conferma Ordine</button>
        </div>
    </div>

    
    <div class="ai-toggle" id="aiToggle" onclick="toggleAI()">
        🤖
    </div>

    
    <div class="ai-panel" id="aiPanel">
        <div class="ai-header">
            <h3>🤖 Assistente IA</h3>
            <button onclick="toggleAI()" style="background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer;">✕</button>
        </div>
        <div class="ai-chat" id="aiChat">
            <div style="text-align: center; color: #666; padding: 2rem;">
                Ciao! Sono il tuo assistente per il catalogo. Posso aiutarti a:
                <ul style="text-align: left; margin-top: 1rem;">
                    <li>Trovare prodotti</li>
                    <li>Suggerire alternative</li>
                    <li>Verificare prezzi e disponibilità</li>
                    <li>Creare ordini</li>
                    <li>Mostrare cronologia acquisti</li>
                </ul>
            </div>
        </div>
        <div class="ai-input-area">
            <textarea class="ai-input" id="aiInput" placeholder="Scrivi qui la tua richiesta..."></textarea>
            <div class="ai-suggestions">
                <div class="ai-chip" onclick="sendAIMessage('Mostrami i prodotti più venduti')">🔥 Top Prodotti</div>
                <div class="ai-chip" onclick="sendAIMessage('Trova alternative al prodotto esaurito')">🔄 Alternative</div>
                <div class="ai-chip" onclick="sendAIMessage('Crea ordine da cronologia cliente')">📋 Da Cronologia</div>
                <div class="ai-chip" onclick="sendAIMessage('Mostrami le offerte del giorno')">💰 Offerte</div>
            </div>
            <button onclick="sendAIMessage()" style="width: 100%; margin-top: 0.8rem;" class="action-btn btn-primary">Invia</button>
        </div>
    </div>

    
    <div class="modal" id="productModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalProductName">Dettagli Prodotto</h2>
                <button class="close-btn" onclick="closeModal()">×</button>
            </div>
            <div id="modalContent">
                
            </div>
        </div>
    </div>

    
    <div class="modal" id="orderModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">📋 Gestione Ordine</h2>
                <button class="close-btn" onclick="closeOrderModal()">×</button>
            </div>
            <div id="orderModalContent">
                
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // CONFIGURAZIONE E STATO APPLICAZIONE
        // ========================================

        const CONFIG = {
            PRODUCTS_PER_LOAD: 100,
            SEARCH_DEBOUNCE: 800,  // Aumentato per ridurre chiamate Odoo
            CLIENT_SEARCH_DEBOUNCE: 300,
            STOCK_THRESHOLDS: {
                HIGH: 20,
                LOW: 5
            },
            TREND_THRESHOLD: 50,
            MAX_SEARCH_RESULTS: 50,
            GEMINI_API_KEY: 'AIzaSyBuHNSxFt4Ua-5ZNj7s5vo5yVTXqcfbKN8',
            GEMINI_API_URL: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent'
        };

        let appState = {
            isConnected: false,
            currentClient: null,
            currentOrder: [],
            products: [],
            filteredProducts: [],
            clients: [],
            currentCategory: 'all',
            currentFilters: {
                available: false,
                offers: false,
                bestsellers: false,
                trending: false
            },
            productsLoaded: 0,
            totalProducts: 0,
            isLoadingMore: false,
            searchTerm: '',
            aiHistory: [],
            userLang: 'it_IT' // Lingua dell'utente
        };

        // ========================================
        // FUNZIONI RPC ODOO
        // ========================================

        function formatDateForOdoo(date = new Date()) {
            // Converte una data JavaScript nel formato richiesto da Odoo: YYYY-MM-DD HH:MM:SS
            return date.getFullYear() + '-' +
                   String(date.getMonth() + 1).padStart(2, '0') + '-' +
                   String(date.getDate()).padStart(2, '0') + ' ' +
                   String(date.getHours()).padStart(2, '0') + ':' +
                   String(date.getMinutes()).padStart(2, '0') + ':' +
                   String(date.getSeconds()).padStart(2, '0');
        }

        function csrf() {
            console.log('🔍 Ricerca token CSRF...');

            // 1. Prova dai cookies
            const cookies = document.cookie.split('; ');
            const csrfCookie = cookies.find(x => x.startsWith('csrf_token='));
            if (csrfCookie) {
                const token = csrfCookie.split('=')[1];
                console.log('✅ Token CSRF trovato nei cookies:', token.substring(0, 10) + '...');
                return token;
            }

            // 2. Prova dall'oggetto window.odoo
            if (window.odoo && window.odoo.csrf_token) {
                console.log('✅ Token CSRF trovato in window.odoo');
                return window.odoo.csrf_token;
            }

            // 3. Prova da meta tag
            const metaTag = document.querySelector('meta[name="csrf-token"]');
            if (metaTag && metaTag.content) {
                console.log('✅ Token CSRF trovato in meta tag');
                return metaTag.content;
            }

            // 4. Se in iframe, prova dal parent (con gestione errori)
            if (window.parent !== window) {
                try {
                    const parentCookies = window.parent.document.cookie;
                    const parentCsrf = parentCookies.split('; ').find(x => x.startsWith('csrf_token='));
                    if (parentCsrf) {
                        console.log('✅ Token CSRF trovato nel parent');
                        return parentCsrf.split('=')[1];
                    }

                    // Prova anche nell'oggetto parent
                    if (window.parent.odoo && window.parent.odoo.csrf_token) {
                        console.log('✅ Token CSRF trovato in parent.odoo');
                        return window.parent.odoo.csrf_token;
                    }
                } catch (e) {
                    console.log('⚠️ Non posso accedere al parent:', e.message);
                }
            }

            // 5. Prova da sessionStorage/localStorage
            const storedToken = sessionStorage.getItem('csrf_token') || localStorage.getItem('csrf_token');
            if (storedToken) {
                console.log('✅ Token CSRF trovato in storage');
                return storedToken;
            }

            console.log('❌ Token CSRF non trovato in nessuna location');
            return null;
        }

        async function rpc(model, method, args = [], kwargs = {}) {
            const headers = {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrf()
            };

            // Aggiungi contesto lingua se non già presente
            if (!kwargs.context) {
                kwargs.context = {};
            }
            if (!kwargs.context.lang) {
                kwargs.context.lang = appState.userLang;
            }

            const body = {
                jsonrpc: '2.0',
                method: 'call',
                params: {
                    model: model,
                    method: method,
                    args: args,
                    kwargs: kwargs
                },
                id: Math.floor(Math.random() * 1000000000)
            };

            try {
                const response = await fetch('/web/dataset/call_kw', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(body)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (data.error) {
                    console.error('Errore Odoo:', data.error);
                    throw new Error(data.error.data.message || data.error.message);
                }

                return data.result;
            } catch (error) {
                console.error('Errore RPC:', error);
                throw error;
            }
        }

        async function searchRead(model, domain = [], fields = [], limit = 100, offset = 0) {
            return await rpc(model, 'search_read', [domain, fields, offset, limit]);
        }

        async function create(model, values) {
            try {
                const result = await rpc(model, 'create', [values]);
                console.log(`✅ Record creato in ${model}:`, result);
                return result;
            } catch (error) {
                console.error(`❌ Errore creazione ${model}:`, error);
                throw error;
            }
        }

        // ========================================
        // INIZIALIZZAZIONE
        // ========================================

        // Inizializzazione sicura per evitare conflitti con Owl
        function safeInitialize() {
            try {
                initializeApp();
                setupEventListeners();
            } catch (error) {
                console.error('Errore inizializzazione catalogo:', error);
            }
        }

        // Usa un timer per inizializzare dopo che Owl ha finito
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', safeInitialize);
        } else {
            // Se il DOM è già carico, aspetta un po' per Owl
            setTimeout(safeInitialize, 100);
        }

        async function initializeApp() {
            updateConnectionStatus(false);
            showNotification('🔄 Inizializzazione in corso...', 'info');

            try {
                await checkConnection();
                await getUserLanguage();
                // Dopo aver ottenuto la lingua, carica i dati con il contesto corretto
                await Promise.all([
                    loadProducts(),
                    loadClients()
                ]);
                updateConnectionStatus(true);
                showNotification('✅ Catalogo caricato con successo!', 'success');
            } catch (error) {
                console.error('Errore inizializzazione:', error);
                updateConnectionStatus(false);
                showNotification('⚠️ Modalità demo attivata - connessione Odoo non disponibile', 'warning');

                // Carica dati demo
                loadDemoData();
                updateConnectionStatus(false, true); // true = modalità demo

                // Mostra messaggio informativo
                setTimeout(() => {
                    showNotification('📝 Stai usando dati di esempio. Per connessione reale, assicurati di essere loggato in Odoo.', 'info');
                }, 2000);
            }
        }

        function setupEventListeners() {
            // Filtri categoria con debounce per evitare richieste multiple
            let categoryClickTimeout;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // Previeni click multipli
                    if (categoryClickTimeout) {
                        clearTimeout(categoryClickTimeout);
                    }

                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    appState.currentCategory = this.dataset.category;
                    console.log(`🔘 PULSANTE CLICCATO: ${this.textContent} → categoria="${appState.currentCategory}"`);
                    updateCurrentFilter();

                    // Debounce di 300ms per evitare richieste multiple
                    categoryClickTimeout = setTimeout(() => {
                        loadProducts(0, CONFIG.PRODUCTS_PER_LOAD, false, appState.currentCategory);
                    }, 300);
                });
            });

            // Ricerca prodotti con debounce
            let searchTimeout;
            document.getElementById('productSearch').addEventListener('input', function() {
                appState.searchTerm = this.value;
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    if (this.value.length >= 3) {
                        searchProductsInOdoo(this.value);
                    } else {
                        applyFilters();
                    }
                }, CONFIG.SEARCH_DEBOUNCE);
            });

            // Ricerca clienti
            let clientSearchTimeout;
            document.getElementById('clientSearch').addEventListener('input', function() {
                clearTimeout(clientSearchTimeout);
                clientSearchTimeout = setTimeout(() => {
                    searchClients(this.value);
                }, CONFIG.CLIENT_SEARCH_DEBOUNCE);
            });

            // Toggle filters
            ['Available', 'Offers', 'Bestsellers', 'Trending'].forEach(filter => {
                document.getElementById(`toggle${filter}`).addEventListener('change', function() {
                    appState.currentFilters[filter.toLowerCase()] = this.checked;
                    updateCurrentFilter();
                    applyFilters();
                });
            });

            // Azioni cliente
            document.getElementById('showClientProducts').addEventListener('click', showClientProducts);
            document.getElementById('showClientHistory').addEventListener('click', showClientHistory);
            document.getElementById('createOrder').addEventListener('click', createNewOrder);

            // Carica altri prodotti
            document.getElementById('loadMoreBtn').addEventListener('click', loadMoreProducts);

            // AI Assistant
            document.getElementById('aiInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendAIMessage();
                }
            });

            // Chiudi dropdown quando si clicca fuori
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.search-container')) {
                    hideAllDropdowns();
                }
            });
        }

        // ========================================
        // DATI DEMO
        // ========================================

        function loadDemoData() {
            console.log('🎭 Caricamento dati demo...');

            // Dati demo prodotti
            appState.products = [
                {
                    id: 1,
                    name: "Mozzarella di Bufala DOP 250g",
                    description: "Mozzarella di bufala campana DOP, gusto autentico e cremoso",
                    price: 8.50,
                    cost: 6.20,
                    stock: 45,
                    virtualStock: 48,
                    category: 'frigo',
                    badges: ['trend'],
                    image: null,
                    uom: "kg",
                    productTmplId: 101,
                    lastPurchase: "2024-01-15",
                    lastQuantity: 12,
                    availability: 'available'
                },
                {
                    id: 2,
                    name: "Pasta Barilla Penne Rigate 500g",
                    description: "Pasta di semola di grano duro, formato penne rigate",
                    price: 1.80,
                    cost: 1.20,
                    stock: 120,
                    virtualStock: 115,
                    category: 'secco',
                    badges: ['bestseller'],
                    image: null,
                    uom: "kg",
                    productTmplId: 102,
                    lastPurchase: null,
                    lastQuantity: 0,
                    availability: 'available'
                },
                {
                    id: 3,
                    name: "Gelato Häagen-Dazs Vaniglia 460ml",
                    description: "Gelato premium alla vaniglia del Madagascar",
                    price: 6.90,
                    cost: 4.50,
                    stock: 8,
                    virtualStock: 8,
                    category: 'surgelati',
                    badges: ['offer'],
                    image: null,
                    uom: "l",
                    productTmplId: 103,
                    lastPurchase: "2024-01-10",
                    lastQuantity: 6,
                    availability: 'warning'
                },
                {
                    id: 4,
                    name: "Olio Extravergine di Oliva 1L",
                    description: "Olio extravergine di oliva italiano, prima spremitura a freddo",
                    price: 12.50,
                    cost: 9.80,
                    stock: 0,
                    virtualStock: 5,
                    category: 'secco',
                    badges: [],
                    image: null,
                    uom: "l",
                    productTmplId: 104,
                    lastPurchase: "2023-12-20",
                    lastQuantity: 3,
                    availability: 'unavailable'
                },
                {
                    id: 5,
                    name: "Detergente Pavimenti Ajax 1L",
                    description: "Detergente per pavimenti, profumo lavanda",
                    price: 3.20,
                    cost: 2.10,
                    stock: 25,
                    virtualStock: 22,
                    category: 'nonfood',
                    badges: [],
                    image: null,
                    uom: "l",
                    productTmplId: 105,
                    lastPurchase: null,
                    lastQuantity: 0,
                    availability: 'available'
                },
                {
                    id: 6,
                    name: "Prosciutto San Daniele 18 mesi 100g",
                    description: "Prosciutto San Daniele DOP stagionato 18 mesi",
                    price: 15.80,
                    cost: 12.50,
                    stock: 32,
                    virtualStock: 30,
                    category: 'frigo',
                    badges: ['trend', 'offer'],
                    image: null,
                    uom: "kg",
                    productTmplId: 106,
                    lastPurchase: "2024-01-18",
                    lastQuantity: 8,
                    availability: 'available'
                },
                {
                    id: 7,
                    name: "Caffè Lavazza Qualità Oro 250g",
                    description: "Miscela di caffè arabica e robusta, tostatura media",
                    price: 4.90,
                    cost: 3.60,
                    stock: 85,
                    virtualStock: 80,
                    category: 'secco',
                    badges: ['bestseller'],
                    image: null,
                    uom: "kg",
                    productTmplId: 107,
                    lastPurchase: "2024-01-12",
                    lastQuantity: 15,
                    availability: 'available'
                },
                {
                    id: 8,
                    name: "Pizza Margherita Surgelata 350g",
                    description: "Pizza margherita surgelata con mozzarella e pomodoro",
                    price: 3.50,
                    cost: 2.30,
                    stock: 4,
                    virtualStock: 8,
                    category: 'surgelati',
                    badges: [],
                    image: null,
                    uom: "pz",
                    productTmplId: 108,
                    lastPurchase: null,
                    lastQuantity: 0,
                    availability: 'warning'
                }
            ];

            // Dati demo clienti
            appState.clients = [
                {
                    id: 201,
                    name: "Ristorante Da Mario",
                    address: "Via Roma 123, Milano",
                    phone: "+39 02 1234567",
                    email: "info@damario.it",
                    commercialPartnerId: 201
                },
                {
                    id: 202,
                    name: "Pizzeria Napoletana",
                    address: "Corso Buenos Aires 45, Milano",
                    phone: "+39 02 7654321",
                    email: "ordini@pizzerianapoli.it",
                    commercialPartnerId: 202
                },
                {
                    id: 203,
                    name: "Bar Centrale",
                    address: "Piazza Duomo 1, Milano",
                    phone: "+39 02 9876543",
                    email: "bar@centrale.it",
                    commercialPartnerId: 203
                },
                {
                    id: 204,
                    name: "Supermercato Fresh",
                    address: "Via Torino 89, Milano",
                    phone: "+39 02 5432109",
                    email: "acquisti@fresh.it",
                    commercialPartnerId: 204
                }
            ];

            appState.productsLoaded = appState.products.length;
            updateProductsCount();
            applyFilters();

            showNotification('🎭 Dati demo caricati - ' + appState.products.length + ' prodotti', 'info');
        }

        // ========================================
        // CONNESSIONE E CARICAMENTO DATI
        // ========================================

        // Mappa delle categorie madri per includere categorie figlie
        const PARENT_CATEGORIES = {
            6: 'frigo',     // Frigo
            8: 'secco',     // Secco
            10: 'secco',    // Secco 2 (unito con Secco)
            11: 'surgelati', // Pingu = Surgelati
            19: 'nonfood'   // Non Food
        };

        // Cache delle categorie caricate
        let categoriesCache = new Map();

        // Cache per prodotti per categoria per evitare troppe richieste
        const productsCache = {
            all: null,
            frigo: null,
            secco: null,
            surgelati: null,
            nonfood: null,
            timestamp: {}
        };

        const CACHE_DURATION = 5 * 60 * 1000; // 5 minuti

        // Cache per ricerche prodotti per evitare chiamate duplicate
        const searchCache = new Map();
        const SEARCH_CACHE_DURATION = 2 * 60 * 1000; // 2 minuti

        // Pulizia periodica della cache di ricerca
        setInterval(() => {
            const now = Date.now();
            for (const [key, value] of searchCache.entries()) {
                if (now - value.timestamp > SEARCH_CACHE_DURATION) {
                    searchCache.delete(key);
                }
            }
        }, 60000); // Pulisci ogni minuto

        async function getAllChildCategories(parentIds) {
            try {
                // Carica TUTTE le categorie e poi mappa in base al nome del percorso
                console.log('📂 Caricamento di TUTTE le categorie...');

                const allCategories = await searchRead(
                    'product.category',
                    [], // Carica tutte le categorie
                    ['id', 'name', 'parent_id'],
                    10000 // Limite molto alto per caricare tutte le categorie
                );

                console.log(`🏷️ TOTALE categorie (madri + figlie): ${allCategories.length}`);

                // Aggiorna la cache delle categorie
                categoriesCache.clear();
                allCategories.forEach(cat => {
                    let parentCategory = 'secco'; // default

                    // Determina la categoria madre per ogni categoria
                    if (PARENT_CATEGORIES[cat.id]) {
                        // È una categoria madre diretta
                        parentCategory = PARENT_CATEGORIES[cat.id];
                    } else {
                        // È una categoria figlia, trova la madre tramite nome
                        const categoryName = cat.name.toLowerCase();
                        if (categoryName.includes('frigo')) {
                            parentCategory = 'frigo';
                        } else if (categoryName.includes('secco 2')) {
                            parentCategory = 'secco'; // Unito con secco
                        } else if (categoryName.includes('secco')) {
                            parentCategory = 'secco';
                        } else if (categoryName.includes('pingu')) {
                            parentCategory = 'surgelati';
                        } else if (categoryName.includes('non food')) {
                            parentCategory = 'nonfood';
                        }
                    }

                    categoriesCache.set(cat.id, parentCategory);

                    // Debug per categorie importanti
                    if (PARENT_CATEGORIES[cat.id]) {
                        console.log(`🏷️ Categoria madre: ${cat.name} (ID: ${cat.id}) → ${parentCategory}`);
                    }
                });

                // Statistiche per debug
                const stats = {};
                categoriesCache.forEach(category => {
                    stats[category] = (stats[category] || 0) + 1;
                });
                console.log('📊 Categorie per tipo:', stats);

                return allCategories.map(cat => cat.id);
            } catch (error) {
                console.error('❌ Errore caricamento categorie:', error);
                return parentIds; // Fallback alle categorie madri
            }
        }

        function findParentCategory(categId, allCategories) {
            // Risale la gerarchia per trovare la categoria madre
            if (PARENT_CATEGORIES[categId]) {
                return PARENT_CATEGORIES[categId];
            }

            const category = allCategories.find(cat => cat.id === categId);
            if (category) {
                // Prova anche a controllare il nome della categoria
                const categoryName = category.name.toLowerCase();
                if (categoryName.startsWith('frigo') || categoryName.includes('frigo')) {
                    return 'frigo';
                } else if (categoryName.startsWith('secco /') || categoryName.includes('secco /')) {
                    return 'secco';
                } else if (categoryName.startsWith('secco 2') || categoryName.includes('secco 2')) {
                    return 'secco'; // Unito con secco
                } else if (categoryName.startsWith('pingu') || categoryName.includes('pingu')) {
                    return 'surgelati';
                } else if (categoryName.startsWith('non food') || categoryName.includes('non food')) {
                    return 'nonfood';
                }

                // Se ha un parent, risali la gerarchia
                if (category.parent_id) {
                    return findParentCategory(category.parent_id[0], allCategories);
                }
            }
            return 'secco'; // default
        }

        function findCategoryForProduct(categId) {
            const cached = categoriesCache.get(categId);
            if (cached) {
                return cached;
            }

            // Se non è in cache, prova a fare una ricerca diretta del nome categoria
            // (questo è un fallback per categorie molto profonde)
            console.log(`⚠️ Categoria ID ${categId} non trovata in cache, uso fallback 'secco'`);
            return 'secco';
        }

        async function checkConnection() {
            const token = csrf();
            if (!token) {
                // Se non c'è token, prova una connessione diretta
                console.log('⚠️ Token CSRF non trovato, provo connessione alternativa...');
                try {
                    // Test di connessione minimale - prova a caricare un singolo record
                    await searchRead('res.users', [['id', '=', 1]], ['name'], 1);
                    appState.isConnected = true;
                    console.log('✅ Connesso a Odoo (metodo alternativo)');
                    return true;
                } catch (error) {
                    console.error('Connessione alternativa fallita:', error);
                    throw new Error('Token CSRF non trovato e connessione alternativa fallita');
                }
            }

            try {
                // Prima prova con session info
                const response = await fetch('/web/session/get_session_info', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': token
                    }
                });

                if (response.ok) {
                    const sessionInfo = await response.json();
                    appState.isConnected = true;
                    console.log('✅ Connesso a Odoo:', sessionInfo);
                    return true;
                }
            } catch (error) {
                console.warn('Session info non disponibile, provo metodo alternativo:', error);
            }

            // Se session info non funziona, prova con una chiamata RPC diretta
            try {
                console.log('🔄 Provo connessione RPC diretta...');
                await searchRead('res.users', [['id', '=', 1]], ['name'], 1);
                appState.isConnected = true;
                console.log('✅ Connesso a Odoo (RPC diretto)');
                return true;
            } catch (error) {
                console.error('Errore connessione RPC:', error);
                throw new Error('Impossibile connettersi a Odoo: ' + error.message);
            }
        }

        async function getUserLanguage() {
            try {
                console.log('🌐 Caricamento lingua utente corrente...');
                // Usa l'utente corrente tramite chiamata diretta
                const userInfo = await rpc('res.users', 'read', [false], {
                    fields: ['lang'],
                    context: {lang: false} // Non applicare filtro lingua per ottenere il valore originale
                });
                if (userInfo && userInfo.length > 0 && userInfo[0].lang) {
                    appState.userLang = userInfo[0].lang;
                    console.log(`✅ Lingua utente impostata: ${appState.userLang}`);
                } else {
                    // Fallback: prova a ottenere la lingua dalla sessione
                    try {
                        const sessionInfo = await fetch('/web/session/get_session_info', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': csrf()
                            }
                        });
                        if (sessionInfo.ok) {
                            const session = await sessionInfo.json();
                            if (session.result && session.result.user_context && session.result.user_context.lang) {
                                appState.userLang = session.result.user_context.lang;
                                console.log(`✅ Lingua utente dalla sessione: ${appState.userLang}`);
                                return;
                            }
                        }
                    } catch (sessionError) {
                        console.warn('⚠️ Errore caricamento lingua da sessione:', sessionError);
                    }
                    console.log('⚠️ Lingua utente non trovata, uso default: it_IT');
                    appState.userLang = 'it_IT';
                }
            } catch (error) {
                console.warn('⚠️ Errore caricamento lingua utente, uso default:', error);
                appState.userLang = 'it_IT';
            }
        }

        function updateConnectionStatus(connected, demoMode = false) {
            const dot = document.getElementById('connectionDot');
            const status = document.getElementById('connectionStatus');

            if (connected) {
                dot.classList.add('connected');
                status.textContent = '✅ Connesso a Odoo';
                appState.isConnected = true;
            } else if (demoMode) {
                dot.classList.remove('connected');
                dot.style.backgroundColor = '#f39c12'; // Arancione per demo
                status.textContent = '🎭 Modalità Demo';
                appState.isConnected = false;
            } else {
                dot.classList.remove('connected');
                dot.style.backgroundColor = '#ff4757'; // Rosso per errore
                status.textContent = '❌ Disconnesso';
                appState.isConnected = false;
            }
        }

        async function loadProducts(offset = 0, limit = CONFIG.PRODUCTS_PER_LOAD, append = false, categoryFilter = null) {
            try {
                const cacheKey = categoryFilter || 'all';
                const now = Date.now();

                // Controlla cache
                if (productsCache[cacheKey] && productsCache.timestamp[cacheKey]) {
                    const cacheAge = now - productsCache.timestamp[cacheKey];
                    if (cacheAge < CACHE_DURATION && !append) {
                        console.log(`💾 Uso cache per categoria: ${cacheKey} (età: ${Math.round(cacheAge/1000)}s)`);
                        appState.products = productsCache[cacheKey];
                        appState.productsLoaded = appState.products.length;
                        updateProductsCount();
                        applyFilters();
                        return;
                    }
                }

                if (!append) {
                    console.log(`🔄 Caricamento prodotti da Odoo per categoria: ${cacheKey}...`);
                    document.getElementById('productsContainer').innerHTML = `
                        <div class="loading">
                            <div class="loading-spinner"></div>
                            Caricamento catalogo prodotti...
                        </div>
                    `;
                }

                // Costruisci i filtri per Odoo
                const domain = [
                    ['sale_ok', '=', true],
                    ['active', '=', true]
                ];

                // Aggiungi filtro categoria se specificato
                if (categoryFilter && categoryFilter !== 'all') {
                    console.log(`🏷️ Filtro categoria: ${categoryFilter}`);

                    // Mappa le categorie ai nomi reali in Odoo
                    let odooFilterName = categoryFilter;
                    if (categoryFilter === 'surgelati') {
                        odooFilterName = 'Pingu'; // Come specificato dall'utente
                    } else if (categoryFilter === 'nonfood') {
                        odooFilterName = 'Non Food'; // Con spazio
                    }

                    console.log(`🏷️ Filtro Odoo: ['categ_id', 'ilike', '${odooFilterName}']`);
                    domain.push(['categ_id', 'ilike', odooFilterName]);
                }

                const products = await searchRead(
                    'product.product',
                    domain,
                    [
                        'id', 'name', 'uom_id',
                        'list_price', 'standard_price', 'qty_available', 'virtual_available',
                        'categ_id', 'product_tmpl_id', 'image_1920', 'description_sale'
                    ],
                    limit,
                    offset
                );

                console.log(`✅ Caricati ${products.length} prodotti (${offset + 1}-${offset + products.length})`);

                if (!append && products.length > 0) {
                    const allCategories = [...new Set(products.map(p => p.categ_id ? p.categ_id[1] : 'Senza categoria'))];
                    console.log('🏷️ Categorie trovate:', allCategories);
                }

                const formattedProducts = products.map(formatProduct);

                if (append) {
                    const existingIds = new Set(appState.products.map(p => p.id));
                    const newProducts = formattedProducts.filter(p => !existingIds.has(p.id));
                    appState.products = [...appState.products, ...newProducts];
                } else {
                    // Preserva cronologia cliente esistente quando carichi nuovi prodotti
                    const existingHistory = {};
                    if (appState.products) {
                        appState.products.forEach(product => {
                            if (product.lastPurchase) {
                                existingHistory[product.id] = {
                                    lastPurchase: product.lastPurchase,
                                    lastQuantity: product.lastQuantity,
                                    totalOrders: product.totalOrders
                                };
                            }
                        });
                    }

                    appState.products = formattedProducts;

                    // Ripristina cronologia sui nuovi prodotti
                    appState.products.forEach(product => {
                        const history = existingHistory[product.id];
                        if (history) {
                            product.lastPurchase = history.lastPurchase;
                            product.lastQuantity = history.lastQuantity;
                            product.totalOrders = history.totalOrders;
                        }
                    });

                    console.log(`🔄 Cronologia preservata per ${Object.keys(existingHistory).length} prodotti`);
                }

                // Salva in cache se non è append
                if (!append) {
                    productsCache[cacheKey] = [...appState.products]; // copia dei prodotti
                    productsCache.timestamp[cacheKey] = now;
                    console.log(`💾 Cache aggiornata per categoria: ${cacheKey}`);
                }

                appState.productsLoaded = appState.products.length;
                updateProductsCount();
                applyFilters();

                // Mostra pulsante carica altri se ci sono ancora prodotti
                if (products.length === limit) {
                    document.getElementById('loadMoreBtn').style.display = 'inline-block';
                }

            } catch (error) {
                console.error('❌ Errore caricamento prodotti:', error);
                showNotification('Errore caricamento prodotti: ' + error.message, 'error');

                if (!append) {
                    document.getElementById('productsContainer').innerHTML = `
                        <div class="loading" style="color: #e74c3c;">
                            ❌ Errore caricamento prodotti<br>
                            <small>${error.message}</small>
                        </div>
                    `;
                }
            }
        }

        function formatProduct(product) {
            // Usa direttamente il nome della categoria da Odoo
            let category = 'all';
            if (product.categ_id && product.categ_id[1]) {
                const categName = product.categ_id[1].toLowerCase();

                // Mappa semplice basata sul nome della categoria
                if (categName.includes('frigo')) {
                    category = 'frigo';
                } else if (categName.includes('secco')) {
                    category = 'secco';
                } else if (categName.includes('surgel') || categName.includes('pingu')) {
                    category = 'surgelati';
                } else if (categName.includes('non') && categName.includes('food')) {
                    category = 'nonfood';
                } else {
                    category = 'secco'; // default
                }
            }

            // Determina badges
            const badges = [];
            if (product.qty_available > CONFIG.TREND_THRESHOLD) {
                badges.push('trend');
            }
            if (product.list_price < product.standard_price * 0.9) {
                badges.push('offer');
            }

            // Log per verificare traduzione (solo per i primi 3 prodotti)
            if (product.id <= 3 && product.description_sale) {
                console.log(`🌐 Prodotto ${product.name} - Descrizione (${appState.userLang}): ${product.description_sale.substring(0, 50)}...`);
            }

            return {
                id: product.id,
                name: product.name || 'Prodotto senza nome',
                description: product.description_sale || '',
                price: product.list_price || 0,
                cost: product.standard_price || 0,
                stock: product.qty_available || 0,
                virtualStock: product.virtual_available || 0,
                category: category,
                badges: badges,
                image: product.image_1920,
                uom: product.uom_id ? product.uom_id[1] : 'pz',
                productTmplId: product.product_tmpl_id ? product.product_tmpl_id[0] : null,
                lastPurchase: null,
                lastQuantity: 0,
                availability: getAvailabilityStatus(product.qty_available || 0)
            };
        }

        function getAvailabilityStatus(stock) {
            if (stock > CONFIG.STOCK_THRESHOLDS.HIGH) return 'available';
            if (stock > CONFIG.STOCK_THRESHOLDS.LOW) return 'warning';
            return 'unavailable';
        }

        async function loadClients() {
            try {
                console.log('🔄 Caricamento clienti da Odoo...');

                let clients = await searchRead(
                    'res.partner',
                    [['customer_rank', '>', 0]],
                    ['id', 'name', 'street', 'city', 'phone', 'mobile', 'email', 'commercial_partner_id'],
                    500
                );

                if (clients.length < 50) {
                    console.log('🔍 Caricamento clienti aggiuntivi...');
                    const additionalClients = await searchRead(
                        'res.partner',
                        [
                            ['active', '=', true],
                            '|',
                            ['is_company', '=', true],
                            ['parent_id', '!=', false]
                        ],
                        ['id', 'name', 'street', 'city', 'phone', 'mobile', 'email', 'commercial_partner_id'],
                        1000
                    );
                    clients = [...clients, ...additionalClients];

                    // Rimuovi duplicati
                    const unique = clients.filter((client, index, arr) =>
                        arr.findIndex(c => c.id === client.id) === index
                    );
                    clients = unique;
                }

                console.log(`✅ Caricati ${clients.length} clienti`);

                appState.clients = clients.map(client => ({
                    id: client.id,
                    name: client.name,
                    address: [client.street, client.city].filter(Boolean).join(', '),
                    phone: client.phone || client.mobile,
                    email: client.email,
                    commercialPartnerId: client.commercial_partner_id ? client.commercial_partner_id[0] : client.id
                }));

            } catch (error) {
                console.error('❌ Errore caricamento clienti:', error);
                showNotification('Errore caricamento clienti: ' + error.message, 'error');
                appState.clients = [];
            }
        }

        async function loadMoreProducts() {
            if (appState.isLoadingMore) return;

            appState.isLoadingMore = true;
            const btn = document.getElementById('loadMoreBtn');
            const originalText = btn.textContent;

            btn.textContent = '⏳ Caricamento...';
            btn.disabled = true;

            try {
                await loadProducts(appState.productsLoaded, CONFIG.PRODUCTS_PER_LOAD, true);
                showNotification(`✅ Caricati altri prodotti! Totale: ${appState.productsLoaded}`, 'success');
            } catch (error) {
                showNotification('❌ Errore caricamento prodotti aggiuntivi', 'error');
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
                appState.isLoadingMore = false;
            }
        }

        // ========================================
        // RICERCA E FILTRI
        // ========================================

        async function searchProductsInOdoo(searchTerm) {
            try {
                // Controlla cache prima di fare la chiamata
                const cacheKey = searchTerm.toLowerCase();
                const cached = searchCache.get(cacheKey);
                const now = Date.now();

                if (cached && (now - cached.timestamp) < SEARCH_CACHE_DURATION) {
                    console.log(`💾 Usando cache per ricerca: "${searchTerm}"`);
                    appState.filteredProducts = cached.results;
                    renderProducts();
                    updateProductsCount();
                    showNotification(`🔍 Trovati ${cached.results.length} prodotti (cache)`, 'info');
                    return;
                }

                console.log(`🔍 Ricerca in Odoo: "${searchTerm}"`);

                // Mostra indicatore di caricamento
                showNotification('🔍 Ricerca in corso...', 'info');

                const foundProducts = await searchRead(
                    'product.product',
                    [
                        ['sale_ok', '=', true],
                        ['active', '=', true],
                        '|',
                        ['name', 'ilike', searchTerm],
                        ['description_sale', 'ilike', searchTerm]
                    ],
                    [
                        'id', 'name', 'uom_id',
                        'list_price', 'standard_price', 'qty_available', 'virtual_available',
                        'categ_id', 'product_tmpl_id', 'image_1920', 'description_sale'
                    ],
                    CONFIG.MAX_SEARCH_RESULTS
                );

                console.log(`✅ Trovati ${foundProducts.length} prodotti`);

                if (foundProducts.length > 0) {
                    const formattedProducts = foundProducts.map(formatProduct);
                    appState.filteredProducts = formattedProducts;

                    // Salva in cache per ricerche future
                    searchCache.set(cacheKey, {
                        results: formattedProducts,
                        timestamp: now
                    });

                    renderProducts();
                    updateProductsCount();
                    showNotification(`🔍 Trovati ${foundProducts.length} prodotti`, 'info');
                } else {
                    appState.filteredProducts = [];
                    renderProducts();
                    updateProductsCount();
                    showNotification('❌ Nessun prodotto trovato', 'warning');
                }

            } catch (error) {
                console.error('❌ Errore ricerca:', error);
                showNotification('Errore nella ricerca: ' + error.message, 'error');
                applyFilters(); // Fallback alla ricerca locale
            }
        }

        function applyFilters() {
            const searchTerm = appState.searchTerm.toLowerCase();
            const filters = appState.currentFilters;

            // Log ridotto per performance
            if (searchTerm) {
                console.log(`🔍 Filtro ricerca: "${searchTerm}"`);
            }

            appState.filteredProducts = appState.products.filter(product => {
                // Filtro ricerca
                const matchesSearch = !searchTerm ||
                    product.name.toLowerCase().includes(searchTerm) ||
                    (product.description && product.description.toLowerCase().includes(searchTerm));

                // Filtri avanzati
                const matchesAvailable = !filters.available || product.stock > 0;
                const matchesOffers = !filters.offers || product.badges.includes('offer');
                const matchesBestsellers = !filters.bestsellers || product.badges.includes('bestseller');
                const matchesTrending = !filters.trending || product.badges.includes('trend');

                return matchesSearch && matchesAvailable && matchesOffers &&
                       matchesBestsellers && matchesTrending;
            });

            // Log ridotto: solo se importante
            renderProducts();
            updateProductsCount();
        }

        function updateCurrentFilter() {
            const filterEl = document.getElementById('currentFilter');
            const filters = [];

            if (appState.currentCategory !== 'all') {
                filters.push(`Categoria: ${appState.currentCategory}`);
            }

            Object.entries(appState.currentFilters).forEach(([key, value]) => {
                if (value) {
                    filters.push(key.charAt(0).toUpperCase() + key.slice(1));
                }
            });

            if (appState.searchTerm) {
                filters.push(`Ricerca: "${appState.searchTerm}"`);
            }

            filterEl.textContent = filters.length > 0 ? `(${filters.join(', ')})` : '';
        }

        async function searchClients(searchTerm) {
            const dropdown = document.getElementById('clientDropdown');

            if (searchTerm.length < 2) {
                hideAllDropdowns();
                return;
            }

            // Ricerca locale prima
            const localMatches = appState.clients.filter(client =>
                client.name.toLowerCase().includes(searchTerm.toLowerCase())
            );

            if (localMatches.length > 0) {
                showClientSuggestions(localMatches.slice(0, 20));
                return;
            }

            // Ricerca in Odoo se non trova localmente
            try {
                console.log(`🔍 Ricerca clienti in Odoo: "${searchTerm}"`);

                const matchingClients = await searchRead(
                    'res.partner',
                    [['name', 'ilike', searchTerm]],
                    ['id', 'name', 'street', 'city', 'phone', 'mobile', 'email', 'parent_id', 'is_company'],
                    50
                );

                const clientsFormatted = matchingClients.map(client => ({
                    id: client.id,
                    name: client.name,
                    address: [client.street, client.city].filter(Boolean).join(', '),
                    phone: client.phone || client.mobile,
                    email: client.email,
                    isCompany: client.is_company,
                    parentId: client.parent_id ? client.parent_id[0] : null,
                    displayName: client.parent_id && !client.is_company ?
                        `${client.name} (${client.parent_id[1]})` : client.name
                }));

                console.log(`✅ Trovati ${clientsFormatted.length} clienti`);
                showClientSuggestions(clientsFormatted);

            } catch (error) {
                console.error('❌ Errore ricerca clienti:', error);
                showClientSuggestions([]);
            }
        }

        function showClientSuggestions(clients) {
            const dropdown = document.getElementById('clientDropdown');

            if (clients.length === 0) {
                dropdown.innerHTML = '<div class="search-item">❌ Nessun cliente trovato</div>';
                dropdown.classList.add('show');
                return;
            }

            const clientsHTML = clients.map(client => `
                <div class="search-item" onclick="selectClient(${client.id}, '${client.name.replace(/'/g, "\\'")}', '${(client.address || '').replace(/'/g, "\\'")}')">
                    <div style="font-weight: 600;">${client.displayName || client.name}</div>
                    ${client.address ? `<div style="font-size: 0.8rem; color: #666;">${client.address}</div>` : ''}
                    <div style="font-size: 0.7rem; color: #999;">
                        ${client.isCompany === false ? '👤 Contatto' : client.isCompany === true ? '🏢 Azienda' : ''}
                    </div>
                </div>
            `).join('');

            dropdown.innerHTML = clientsHTML;
            dropdown.classList.add('show');
        }

        function hideAllDropdowns() {
            document.getElementById('clientDropdown').classList.remove('show');
            document.getElementById('productDropdown').classList.remove('show');
        }

        // ========================================
        // GESTIONE CLIENTE
        // ========================================

        async function selectClient(clientId, clientName, clientAddress = '') {
            try {
                // Trova o crea oggetto cliente
                let client = appState.clients.find(c => c.id === clientId);
                if (!client) {
                    client = {
                        id: clientId,
                        name: clientName,
                        address: clientAddress,
                        phone: '',
                        email: ''
                    };
                    appState.clients.push(client);
                }

                appState.currentClient = client;

                // Aggiorna UI
                const selectedClientEl = document.getElementById('selectedClient');
                const clientNameEl = document.getElementById('clientName');
                const clientMetaEl = document.getElementById('clientMeta');

                if (selectedClientEl) selectedClientEl.classList.add('active');
                if (clientNameEl) clientNameEl.textContent = client.name;
                if (clientMetaEl) clientMetaEl.textContent = client.address || 'Nessun indirizzo';
                document.getElementById('clientSearch').value = client.name;

                hideAllDropdowns();

                // Carica cronologia acquisti (solo se connesso a Odoo)
                if (appState.isConnected) {
                    await loadClientPurchaseHistory(clientId);
                    // TODO: riattivare listino prezzi quando sistema
                    // await loadClientPricelistAndRefreshProducts(clientId);
                } else {
                    // In modalità demo, simula cronologia per alcuni prodotti
                    simulateDemoClientHistory(clientId);
                }

                applyFilters(); // Re-render per mostrare cronologia
                showNotification(`✅ Cliente selezionato: ${client.name}`, 'success');

            } catch (error) {
                console.error('❌ Errore selezione cliente:', error);
                showNotification('Errore selezione cliente: ' + error.message, 'error');
            }
        }

        async function loadClientPricelistAndRefreshProducts(clientId) {
            try {
                console.log(`💰 Caricamento listino prezzi per cliente ${clientId}...`);

                // Cerca il listino del cliente
                const partnerData = await searchRead(
                    'res.partner',
                    [['id', '=', clientId]],
                    ['property_product_pricelist']
                );

                if (partnerData.length === 0) {
                    console.log('⚠️ Cliente non trovato per listino prezzi');
                    return;
                }

                const pricelistId = partnerData[0].property_product_pricelist ?
                    partnerData[0].property_product_pricelist[0] : null;

                if (!pricelistId) {
                    console.log('⚠️ Nessun listino specifico per questo cliente, userò prezzi standard');
                    return;
                }

                console.log(`📋 Listino trovato: ${pricelistId}`);

                // Aggiorna i prezzi di tutti i prodotti con il listino cliente
                for (const product of appState.products) {
                    try {
                        const priceData = await rpc('/web/dataset/call_kw', {
                            model: 'product.pricelist',
                            method: 'get_product_price',
                            args: [pricelistId, product.id, 1], // qty = 1
                            kwargs: {
                                partner_id: clientId,
                                date: false,
                                uom_id: false
                            }
                        });

                        if (priceData && typeof priceData === 'number') {
                            product.clientPrice = priceData;
                            product.originalPrice = product.price; // Salva il prezzo originale
                            product.price = priceData; // Aggiorna il prezzo visualizzato
                            console.log(`💰 Prezzo aggiornato per ${product.name}: CHF ${priceData}`);
                        }
                    } catch (priceError) {
                        console.warn(`⚠️ Errore nel caricamento prezzo per prodotto ${product.id}:`, priceError);
                    }
                }

                // Ricarica la visualizzazione prodotti con i nuovi prezzi
                applyFilters();
                showNotification(`💰 Prezzi aggiornati con listino cliente`, 'success');

            } catch (error) {
                console.error('❌ Errore caricamento listino cliente:', error);
                showNotification('⚠️ Errore caricamento listino prezzi', 'warning');
            }
        }

        async function calculateRealVAT(orderItems, clientId) {
            try {
                console.log('💰 Calcolando IVA reale da Odoo...');

                let totalTax = 0;

                for (const item of orderItems) {
                    try {
                        // Cerca le tasse del prodotto
                        const productData = await searchRead(
                            'product.product',
                            [['id', '=', item.product.id]],
                            ['taxes_id']
                        );

                        if (productData.length > 0 && productData[0].taxes_id.length > 0) {
                            const taxIds = productData[0].taxes_id;

                            // Carica i dettagli delle tasse
                            const taxData = await searchRead(
                                'account.tax',
                                [['id', 'in', taxIds]],
                                ['amount', 'amount_type']
                            );

                            // Calcola tassa per questo prodotto
                            let productTax = 0;
                            const productSubtotal = item.price * item.quantity;

                            for (const tax of taxData) {
                                if (tax.amount_type === 'percent') {
                                    productTax += productSubtotal * (tax.amount / 100);
                                } else if (tax.amount_type === 'fixed') {
                                    productTax += tax.amount * item.quantity;
                                }
                            }

                            totalTax += productTax;
                            console.log(`💰 Tassa per ${item.product.name}: CHF ${productTax.toFixed(2)}`);
                        } else {
                            // Fallback: usa IVA standard 8% se non trova tasse specifiche
                            const fallbackTax = (item.price * item.quantity) * 0.08;
                            totalTax += fallbackTax;
                            console.log(`⚠️ Nessuna tassa specifica per ${item.product.name}, uso 8%`);
                        }
                    } catch (itemError) {
                        console.warn(`⚠️ Errore calcolo tassa per prodotto ${item.product.id}:`, itemError);
                        // Fallback per errori specifici del prodotto
                        const fallbackTax = (item.price * item.quantity) * 0.08;
                        totalTax += fallbackTax;
                    }
                }

                console.log(`💰 IVA totale calcolata: CHF ${totalTax.toFixed(2)}`);
                return totalTax;

            } catch (error) {
                console.error('❌ Errore calcolo IVA reale:', error);
                // Fallback totale: calcola 8% su tutto l'ordine
                const subtotal = orderItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                return subtotal * 0.08;
            }
        }

        function simulateDemoClientHistory(clientId) {
            // Simula cronologia acquisti per modalità demo
            const historyMap = {
                201: [1, 6, 7], // Ristorante Da Mario: mozzarella, prosciutto, caffè
                202: [2, 8],    // Pizzeria: pasta, pizza
                203: [7],       // Bar: caffè
                204: [1, 2, 3, 5] // Supermercato: vari prodotti
            };

            const productIds = historyMap[clientId] || [];

            appState.products.forEach(product => {
                if (productIds.includes(product.id)) {
                    // Aggiungi cronologia fittizia
                    product.lastPurchase = "2024-01-" + (Math.floor(Math.random() * 20) + 1).toString().padStart(2, '0');
                    product.lastQuantity = Math.floor(Math.random() * 20) + 5;
                    product.totalOrders = Math.floor(Math.random() * 10) + 1;
                } else {
                    product.lastPurchase = null;
                    product.lastQuantity = 0;
                    product.totalOrders = 0;
                }
            });

            console.log(`🎭 Demo: simulata cronologia per cliente ${clientId}`);
        }

        async function loadClientPurchaseHistory(clientId) {
            try {
                console.log(`🔄 Caricamento cronologia cliente ${clientId}...`);

                // Torna alla strategia originale che funzionava: prima gli ordini, poi le righe
                const orders = await searchRead(
                    'sale.order',
                    [
                        ['partner_id', '=', clientId],
                        ['state', 'in', ['sale', 'done']]
                    ],
                    ['id', 'name', 'date_order'],
                    200  // Prendi più ordini per più prodotti
                );

                console.log(`📋 Ordini trovati: ${orders.length}`);
                if (orders.length === 0) {
                    console.log('Nessun ordine trovato per questo cliente');
                    return;
                }

                const orderIds = orders.map(o => o.id);
                console.log(`📋 Order IDs:`, orderIds.slice(0, 5));

                const orderLines = await searchRead(
                    'sale.order.line',
                    [['order_id', 'in', orderIds]],
                    ['product_id', 'product_uom_qty', 'order_id'],
                    1000  // Limite righe aumentato per più prodotti
                );

                console.log(`📋 Righe ordine trovate: ${orderLines.length}`);
                if (orderLines.length > 0) {
                    console.log(`📋 Prima riga esempio:`, orderLines[0]);
                }

                if (orderLines.length === 0) {
                    console.log('Nessuna riga ordine trovata');
                    return;
                }

                // Aggrega per prodotto
                const productHistory = {};
                orderLines.forEach(line => {
                    const productId = line.product_id[0];
                    const orderId = line.order_id[0];
                    const order = orders.find(o => o.id === orderId);

                    if (!productHistory[productId]) {
                        productHistory[productId] = {
                            totalQuantity: 0,
                            lastOrderDate: null,
                            orderCount: 0
                        };
                    }

                    productHistory[productId].totalQuantity += line.product_uom_qty || 0;
                    productHistory[productId].orderCount += 1;

                    if (order && order.date_order) {
                        const orderDate = new Date(order.date_order);
                        if (!productHistory[productId].lastOrderDate || orderDate > productHistory[productId].lastOrderDate) {
                            productHistory[productId].lastOrderDate = orderDate;
                        }
                    }
                });

                // Aggiorna prodotti con cronologia
                appState.products.forEach(product => {
                    const history = productHistory[product.id];
                    if (history) {
                        product.lastPurchase = history.lastOrderDate ? history.lastOrderDate.toLocaleDateString('it-IT') : null;
                        product.lastQuantity = Math.round(history.totalQuantity / history.orderCount);
                        product.totalOrders = history.orderCount;
                    } else {
                        product.lastPurchase = null;
                        product.lastQuantity = 0;
                        product.totalOrders = 0;
                    }
                });

                console.log(`✅ Cronologia caricata: ${Object.keys(productHistory).length} prodotti univoci da ${orders.length} ordini con ${orderLines.length} righe`);

            } catch (error) {
                console.error('❌ Errore cronologia:', error);
                showNotification('Errore caricamento cronologia', 'warning');
            }
        }

        function clearClient() {
            appState.currentClient = null;
            appState.currentOrder = [];
            document.getElementById('selectedClient').classList.remove('active');
            document.getElementById('clientSearch').value = '';

            // Reset cronologia prodotti
            appState.products.forEach(product => {
                product.lastPurchase = null;
                product.lastQuantity = 0;
                product.totalOrders = 0;
            });

            updateCartSummary();
            applyFilters();
            showNotification('Cliente rimosso', 'info');
        }

        function showClientProducts() {
            if (!appState.currentClient) return;

            console.log(`🔍 DEBUG: Filtraggio prodotti acquistati per cliente ${appState.currentClient.name}`);
            console.log(`📦 Prodotti totali disponibili: ${appState.products.length}`);

            const productsWithHistory = appState.products.filter(product => product.lastPurchase);
            console.log(`📋 Prodotti con cronologia: ${productsWithHistory.length}`);

            if (productsWithHistory.length > 0) {
                console.log(`📋 Primi 3 prodotti con cronologia:`, productsWithHistory.slice(0, 3).map(p => ({
                    name: p.name,
                    lastPurchase: p.lastPurchase,
                    lastQuantity: p.lastQuantity
                })));
            }

            appState.filteredProducts = productsWithHistory;
            renderProducts();
            updateProductsCount();
            showNotification(`Prodotti acquistati da ${appState.currentClient.name}`, 'info');
        }

        async function showClientHistory() {
            if (!appState.currentClient) return;

            showNotification('📊 Caricamento statistiche cliente...', 'info');

            try {
                // Se connesso a Odoo, carica dati reali
                if (appState.isConnected) {
                    await loadClientStatistics(appState.currentClient.id);
                }

                // Calcola statistiche
                const stats = calculateClientStatistics();

                // Mostra modal con statistiche
                showClientStatisticsModal(stats);

            } catch (error) {
                console.error('Errore caricamento statistiche:', error);
                showNotification('⚠️ Errore caricamento statistiche', 'error');
            }
        }

        async function loadClientStatistics(clientId) {
            try {
                console.log(`📊 Caricamento statistiche per cliente ${clientId}...`);
                // La funzione loadClientPurchaseHistory() già carica i dati necessari
                await loadClientPurchaseHistory(clientId);
                console.log('✅ Statistiche cliente caricate da Odoo');
            } catch (error) {
                console.error('⚠️ Errore caricamento statistiche da Odoo:', error);
                // Fallback ai dati demo se Odoo non è disponibile
            }
        }

        function calculateClientStatistics() {
            const clientProducts = appState.products.filter(p => p.lastPurchase);

            // Calcola statistiche base
            const totalOrders = clientProducts.reduce((sum, p) => sum + (p.totalOrders || 0), 0);
            const totalQuantity = clientProducts.reduce((sum, p) => sum + (p.lastQuantity || 0), 0);
            const totalValue = clientProducts.reduce((sum, p) => sum + (p.price * (p.lastQuantity || 0)), 0);

            // Trova prodotti più acquistati
            const topProducts = clientProducts
                .filter(p => p.totalOrders > 0)
                .sort((a, b) => (b.totalOrders || 0) - (a.totalOrders || 0))
                .slice(0, 5);

            // Analisi per categoria
            const categoryStats = {};
            clientProducts.forEach(p => {
                if (!categoryStats[p.category]) {
                    categoryStats[p.category] = { count: 0, value: 0, quantity: 0 };
                }
                categoryStats[p.category].count += p.totalOrders || 0;
                categoryStats[p.category].value += p.price * (p.lastQuantity || 0);
                categoryStats[p.category].quantity += p.lastQuantity || 0;
            });

            // Ordina categorie per valore
            const topCategories = Object.entries(categoryStats)
                .sort((a, b) => b[1].value - a[1].value)
                .slice(0, 3);

            // Calcola ultima attività
            const lastActivity = clientProducts
                .filter(p => p.lastPurchase && p.lastPurchase !== 'undefined' && p.lastPurchase !== 'null')
                .map(p => {
                    try {
                        // Se è già in formato italiano, prova a parsarla
                        if (p.lastPurchase.includes('/')) {
                            const parts = p.lastPurchase.split('/');
                            if (parts.length === 3) {
                                return new Date(`${parts[2]}-${parts[1]}-${parts[0]}`);
                            }
                        }
                        return new Date(p.lastPurchase);
                    } catch (e) {
                        console.warn('Data non valida:', p.lastPurchase);
                        return null;
                    }
                })
                .filter(d => d && !isNaN(d.getTime()))
                .sort((a, b) => b - a)[0];

            return {
                totalProducts: clientProducts.length,
                totalOrders,
                totalQuantity,
                totalValue,
                averageOrderValue: totalOrders > 0 ? totalValue / totalOrders : 0,
                topProducts,
                topCategories,
                lastActivity: lastActivity && !isNaN(lastActivity.getTime()) ? lastActivity.toLocaleDateString('it-IT') : 'Mai'
            };
        }

        function showClientStatisticsModal(stats) {
            const modal = document.getElementById('productModal');
            const modalContent = document.querySelector('#productModal .modal-content');

            modalContent.innerHTML = `
                <div class="modal-header">
                    <h2 class="modal-title">📊 Statistiche Cliente: ${appState.currentClient.name}</h2>
                    <button class="close-btn" onclick="forceCloseModal()">&times;</button>
                </div>

                <div style="padding: 2rem; max-height: 70vh; overflow-y: auto;">
                    <!-- Riepilogo generale -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                        <div style="background: #e3f2fd; padding: 1.5rem; border-radius: 15px; text-align: center;">
                            <div style="font-size: 2rem; color: #1976d2; font-weight: bold;">${stats.totalProducts}</div>
                            <div style="color: #666; font-size: 0.9rem;">Prodotti Distinti</div>
                        </div>
                        <div style="background: #f3e5f5; padding: 1.5rem; border-radius: 15px; text-align: center;">
                            <div style="font-size: 2rem; color: #8e44ad; font-weight: bold;">${stats.totalOrders}</div>
                            <div style="color: #666; font-size: 0.9rem;">Ordini Totali</div>
                        </div>
                        <div style="background: #e8f5e8; padding: 1.5rem; border-radius: 15px; text-align: center;">
                            <div style="font-size: 2rem; color: #27ae60; font-weight: bold;">CHF ${stats.totalValue.toFixed(2)}</div>
                            <div style="color: #666; font-size: 0.9rem;">Valore Totale</div>
                        </div>
                        <div style="background: #fff3e0; padding: 1.5rem; border-radius: 15px; text-align: center;">
                            <div style="font-size: 2rem; color: #f57c00; font-weight: bold;">CHF ${stats.averageOrderValue.toFixed(2)}</div>
                            <div style="color: #666; font-size: 0.9rem;">Valore Medio Ordine</div>
                        </div>
                    </div>

                    <!-- Ultima attività -->
                    <div style="background: #fafafa; padding: 1.5rem; border-radius: 15px; margin-bottom: 2rem;">
                        <h4 style="margin-bottom: 1rem; color: #333;">📅 Ultima Attività</h4>
                        <p style="font-size: 1.1rem; color: #666;">Ultimo acquisto: <strong>${stats.lastActivity}</strong></p>
                    </div>

                    ${stats.topProducts.length > 0 ? `
                    <div style="background: #fff; padding: 1.5rem; border-radius: 15px; margin-bottom: 2rem; border: 1px solid #eee;">
                        <h4 style="margin-bottom: 1rem; color: #333;">🏆 Top 5 Prodotti Acquistati</h4>
                        ${stats.topProducts.map((product, index) => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.8rem 0; border-bottom: ${index < stats.topProducts.length - 1 ? '1px solid #f0f0f0' : 'none'};">
                                <div>
                                    <strong>${product.name}</strong>
                                    <div style="font-size: 0.85rem; color: #666;">CHF ${product.price.toFixed(2)} / ${(product.uom || 'pz').replace(/[^a-zA-Z0-9.]/g, '')}</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-weight: bold; color: #27ae60;">${product.totalOrders} ordini</div>
                                    <div style="font-size: 0.85rem; color: #666;">${product.lastQuantity} ${(product.uom || 'pz').replace(/[^a-zA-Z0-9.]/g, '')}/ordine</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}

                    ${stats.topCategories.length > 0 ? `
                    <div style="background: #fff; padding: 1.5rem; border-radius: 15px; border: 1px solid #eee;">
                        <h4 style="margin-bottom: 1rem; color: #333;">📂 Categorie Preferite</h4>
                        ${stats.topCategories.map((category, index) => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.8rem 0; border-bottom: ${index < stats.topCategories.length - 1 ? '1px solid #f0f0f0' : 'none'};">
                                <div>
                                    <strong>${getCategoryIcon(category[0])} ${category[0].toUpperCase()}</strong>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-weight: bold; color: #27ae60;">CHF ${category[1].value.toFixed(2)}</div>
                                    <div style="font-size: 0.85rem; color: #666;">${category[1].count} ordini • ${category[1].quantity} unità</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}

                    <div style="display: flex; gap: 1rem; margin-top: 2rem; justify-content: center;">
                        <button class="action-btn btn-primary" onclick="showClientProducts(); closeModal();">📋 Mostra Prodotti</button>
                        <button class="action-btn btn-success" onclick="createOrderFromHistory()">🛒 Ordine da Cronologia</button>
                        <button class="action-btn btn-secondary" onclick="forceCloseModal()">❌ Chiudi</button>
                    </div>
                </div>
            `;

            modal.style.display = 'flex';

            // Aggiunge event listener per chiusura con click esterno
            modal.onclick = function(e) {
                if (e.target === modal) {
                    forceCloseModal();
                }
            };
        }

        function forceCloseModal() {
            console.log('🔧 Chiusura forzata modal...');
            const modal = document.getElementById('productModal');
            if (modal) {
                modal.style.display = 'none';
                modal.onclick = null; // Rimuovi event listener
                console.log('✅ Modal chiuso forzatamente');
            }

            // Assicurati che anche il modal ordini sia chiuso
            const orderModal = document.getElementById('orderModal');
            if (orderModal) {
                orderModal.style.display = 'none';
            }
        }

        function createOrderFromHistory() {
            if (!appState.currentClient) return;

            // Trova i 3 prodotti più acquistati
            const topProducts = appState.products
                .filter(p => p.lastPurchase && p.totalOrders > 0)
                .sort((a, b) => (b.totalOrders || 0) - (a.totalOrders || 0))
                .slice(0, 3);

            if (topProducts.length === 0) {
                showNotification('⚠️ Nessun prodotto nella cronologia acquisti', 'warning');
                return;
            }

            // Aggiungi al carrello con quantità medie
            topProducts.forEach(product => {
                const existingItem = appState.currentOrder.find(item => item.product.id === product.id);
                if (existingItem) {
                    existingItem.quantity += product.lastQuantity || 1;
                } else {
                    appState.currentOrder.push({
                        product: product,
                        quantity: product.lastQuantity || 1,
                        price: product.price
                    });
                }
            });

            updateCartSummary();
            closeModal();
            showNotification(`✅ Aggiunto ${topProducts.length} prodotti da cronologia!`, 'success');
        }

        // ========================================
        // RENDERING PRODOTTI
        // ========================================

        function renderProducts() {
            const container = document.getElementById('productsContainer');

            if (appState.filteredProducts.length === 0) {
                container.innerHTML = `
                    <div class="loading">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">📦</div>
                        <h3>Nessun prodotto trovato</h3>
                        <p>Prova a modificare i filtri o la ricerca</p>
                    </div>
                `;
                return;
            }

            const productsHTML = appState.filteredProducts.map(renderProductCard).join('');
            container.innerHTML = productsHTML;
        }

        function renderProductCard(product) {
            const badgesHTML = product.badges.map(badge => {
                const badgeText = {
                    'trend': '🔥 Trend',
                    'offer': '💰 Offerta',
                    'bestseller': '⭐ Best Seller'
                };
                return `<div class="badge ${badge}">${badgeText[badge]}</div>`;
            }).join('');

            return `
                <div class="product-card" onclick="showProductDetails(${product.id})" tabindex="0">
                    <div class="product-image ${!product.image ? 'no-image' : ''}">
                        ${product.image ?
                            `<img src="data:image/png;base64,${product.image}" alt="${product.name}" loading="lazy" />` :
                            '<div>📦</div>'
                        }
                        <div class="product-badges">
                            <div class="badge category">${getCategoryIcon(product.category)} ${product.category.toUpperCase()}</div>
                            ${badgesHTML}
                        </div>
                    </div>

                    <div class="product-info">
                        <div class="product-name">${product.name}</div>
                        ${product.description ? `<div class="product-description">${product.description}</div>` : ''}

                        <div class="availability-indicator">
                            <div class="availability-dot ${product.availability}"></div>
                            <span style="font-size: 0.9rem; font-weight: 500;">
                                ${getAvailabilityText(product.availability, product.stock)}
                            </span>
                        </div>

                        <div class="product-details">
                            <div class="detail-item">
                                <div class="detail-label">Prezzo</div>
                                <div class="detail-value price">CHF ${product.price.toFixed(2)} / ${product.uom || 'pz'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Giacenza</div>
                                <div class="detail-value stock ${product.stock > CONFIG.STOCK_THRESHOLDS.LOW ? 'in-stock' : product.stock > 0 ? 'warning' : ''}">${Math.round(product.stock)}</div>
                            </div>
                        </div>

                        ${appState.currentClient && product.lastPurchase ? `
                            <div class="client-history show">
                                <div class="history-title">📋 Cronologia Cliente</div>
                                <div class="history-item">Ultimo acquisto: ${product.lastPurchase}</div>
                                <div class="history-item">Quantità media: ${product.lastQuantity}</div>
                                <div class="history-item">Ordini totali: ${product.totalOrders}</div>
                            </div>
                        ` : ''}

                        <div class="product-actions">
                            <button class="action-btn btn-primary" onclick="event.stopPropagation(); showProductDetails(${product.id})">
                                📋 Dettagli
                            </button>
                            ${appState.currentClient ? `
                                <button class="action-btn btn-success" onclick="event.stopPropagation(); addToCart(${product.id})">
                                    🛒 Aggiungi
                                </button>
                            ` : `
                                <button class="action-btn btn-warning" onclick="event.stopPropagation(); alert('Seleziona prima un cliente')">
                                    👤 Cliente
                                </button>
                            `}
                        </div>
                    </div>
                </div>
            `;
        }

        function getCategoryIcon(category) {
            const icons = {
                'frigo': '❄️',
                'secco': '📦',
                'secco2': '📋',
                'surgelati': '🧊',
                'nonfood': '🧽'
            };
            return icons[category] || '📦';
        }

        function getAvailabilityText(status, stock) {
            switch (status) {
                case 'available': return `Disponibile (${Math.round(stock)})`;
                case 'warning': return `Scorte limitate (${Math.round(stock)})`;
                case 'unavailable': return 'Non disponibile';
                default: return 'Verifica disponibilità';
            }
        }

        function updateProductsCount() {
            const productsCountEl = document.getElementById('productsCount');
            const loadedCountEl = document.getElementById('loadedCount');

            if (productsCountEl) productsCountEl.textContent = appState.filteredProducts.length;
            if (loadedCountEl) loadedCountEl.textContent = appState.productsLoaded;

            if (appState.productsLoaded > 0) {
                document.getElementById('loadMoreContainer').style.display = 'block';
            }
        }

        // ========================================
        // GESTIONE CARRELLO
        // ========================================

        function addToCart(productId) {
            if (!appState.currentClient) {
                showNotification('⚠️ Seleziona prima un cliente', 'warning');
                return;
            }

            const product = appState.products.find(p => p.id === productId) ||
                            appState.filteredProducts.find(p => p.id === productId);

            if (!product) {
                showNotification('❌ Prodotto non trovato', 'error');
                return;
            }

            const existingItem = appState.currentOrder.find(item => item.productId === productId);
            if (existingItem) {
                existingItem.quantity += 1;
                showNotification(`➕ Quantità aumentata: ${product.name}`, 'success');
            } else {
                appState.currentOrder.push({
                    productId: productId,
                    product: product,
                    quantity: 1,
                    price: product.price
                });
                showNotification(`✅ Aggiunto al carrello: ${product.name}`, 'success');
            }

            updateCartSummary();
        }

        function updateCartSummary() {
            const summary = document.getElementById('cartSummary');
            const count = document.getElementById('cartCount');
            const items = document.getElementById('cartItems');
            const total = document.getElementById('cartTotal');

            if (appState.currentOrder.length === 0) {
                summary.classList.remove('show');
                return;
            }

            summary.classList.add('show');
            count.textContent = appState.currentOrder.length;

            // Render items
            const itemsHTML = appState.currentOrder.map((item, index) => `
                <div class="cart-item">
                    <div class="cart-item-info">
                        <div class="cart-item-name">${item.product.name}</div>
                        <div class="cart-item-details">
                            ${item.quantity} x CHF ${item.price.toFixed(2)}
                        </div>
                    </div>
                    <div class="cart-item-price">CHF ${(item.price * item.quantity).toFixed(2)}</div>
                    <button onclick="removeFromCart(${index})" style="background: none; border: none; color: #e74c3c; cursor: pointer; font-size: 1.2rem; margin-left: 0.5rem;">×</button>
                </div>
            `).join('');

            items.innerHTML = itemsHTML;

            // Calcola totali
            const subtotal = appState.currentOrder.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            // Calcola IVA - usa fallback immediato e poi aggiorna async
            let tax = subtotal * 0.08; // Fallback immediato

            // Calcola IVA reale in background se possibile
            if (appState.isConnected && appState.currentClient) {
                calculateRealVAT(appState.currentOrder, appState.currentClient.id)
                    .then(realTax => {
                        // Aggiorna solo il totale quando arriva l'IVA reale
                        const newGrandTotal = subtotal + realTax;
                        const totalEl = document.getElementById('cartTotal');
                        if (totalEl) {
                            totalEl.innerHTML = `
                                <div class="cart-total-line">
                                    <span>Subtotale:</span>
                                    <span>CHF ${subtotal.toFixed(2)}</span>
                                </div>
                                <div class="cart-total-line">
                                    <span>IVA:</span>
                                    <span>CHF ${realTax.toFixed(2)}</span>
                                </div>
                                <div class="cart-total-line final">
                                    <span>Totale:</span>
                                    <span>CHF ${newGrandTotal.toFixed(2)}</span>
                                </div>
                            `;
                        }
                    })
                    .catch(error => {
                        console.warn('Errore calcolo IVA reale:', error);
                        // Mantieni il fallback già calcolato
                    });
            }
            const grandTotal = subtotal + tax;

            total.innerHTML = `
                <div class="cart-total-line">
                    <span>Subtotale:</span>
                    <span>CHF ${subtotal.toFixed(2)}</span>
                </div>
                <div class="cart-total-line">
                    <span>IVA (8%):</span>
                    <span>CHF ${tax.toFixed(2)}</span>
                </div>
                <div class="cart-total-line final">
                    <span>Totale:</span>
                    <span>CHF ${grandTotal.toFixed(2)}</span>
                </div>
            `;
        }

        function removeFromCart(index) {
            const item = appState.currentOrder[index];
            appState.currentOrder.splice(index, 1);
            updateCartSummary();
            showNotification(`🗑️ Rimosso dal carrello: ${item.product.name}`, 'info');
        }

        function clearCart() {
            appState.currentOrder = [];
            updateCartSummary();
            showNotification('🗑️ Carrello svuotato', 'info');
        }

        function createNewOrder() {
            clearCart();
            showNotification('📝 Nuovo ordine creato', 'info');
        }

        // ========================================
        // GESTIONE ORDINI
        // ========================================

        async function finalizeOrder() {
            if (appState.currentOrder.length === 0) {
                showNotification('⚠️ Carrello vuoto', 'warning');
                return;
            }

            if (!appState.currentClient) {
                showNotification('⚠️ Seleziona un cliente', 'warning');
                return;
            }

            await showOrderModal();
        }

        async function showOrderModal() {
            if (appState.currentOrder.length === 0) {
                document.getElementById('orderModalContent').innerHTML = `
                    <div style="text-align: center; padding: 3rem;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">🛒</div>
                        <h3>Carrello vuoto</h3>
                        <p style="color: #666; margin-top: 1rem;">Aggiungi alcuni prodotti per creare un ordine</p>
                    </div>
                `;
            } else {
                const subtotal = appState.currentOrder.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                // Calcola IVA reale
                let tax = 0;
                if (appState.isConnected && appState.currentClient) {
                    tax = await calculateRealVAT(appState.currentOrder, appState.currentClient.id);
                } else {
                    tax = subtotal * 0.08; // Demo fallback
                }
                const total = subtotal + tax;

                // Data di default: domani
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                const defaultDeliveryDate = tomorrow.toISOString().split('T')[0];

                const orderHTML = `
                    <div style="margin-bottom: 2rem; padding: 1.5rem; background: #f8f9fa; border-radius: 15px;">
                        <h4>👤 Cliente</h4>
                        <div style="margin-top: 0.5rem;">
                            <strong>${appState.currentClient.name}</strong><br>
                            <small style="color: #666;">${appState.currentClient.address || 'Nessun indirizzo'}</small>
                        </div>
                    </div>

                    <div style="margin-bottom: 2rem; padding: 1.5rem; background: #e8f5e8; border-radius: 15px; border-left: 4px solid #27ae60;">
                        <h4 style="color: #27ae60; margin-bottom: 1rem;">📅 Data di Consegna <span style="color: #e74c3c;">*</span></h4>
                        <input type="date" id="deliveryDate" style="width: 100%; padding: 0.8rem; border: 2px solid #27ae60; border-radius: 10px; font-size: 1rem; background: white;" value="${defaultDeliveryDate}" min="${new Date().toISOString().split('T')[0]}" required>
                        <small style="color: #27ae60; font-weight: 500; margin-top: 0.5rem; display: block;">Campo obbligatorio - Seleziona la data di consegna richiesta</small>
                    </div>

                    <div style="margin-bottom: 2rem; padding: 1.5rem; background: #fff3cd; border-radius: 15px; border-left: 4px solid #f39c12;">
                        <h4 style="color: #856404; margin-bottom: 1rem;">📝 Note per l'Ordine</h4>
                        <textarea id="orderNotes" placeholder="Inserisci eventuali note o richieste speciali per questo ordine..." style="width: 100%; padding: 0.8rem; border: 2px solid #f39c12; border-radius: 10px; font-size: 1rem; background: white; resize: vertical; min-height: 80px; font-family: inherit;"></textarea>
                        <small style="color: #856404; font-weight: 500; margin-top: 0.5rem; display: block;">Opzionale - Note per preparazione, consegna o richieste speciali</small>
                    </div>

                    <div style="margin-bottom: 2rem;">
                        <h4>🛒 Prodotti nell'ordine (${appState.currentOrder.length} articoli)</h4>
                        <div style="margin-top: 1rem; max-height: 200px; overflow-y: auto; border: 1px solid #eee; border-radius: 10px;">
                            ${appState.currentOrder.map(item => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: white; border-bottom: 1px solid #f0f0f0;">
                                    <div style="flex: 1;">
                                        <strong>${item.product.name}</strong>
                                        <div style="font-size: 0.9rem; color: #666; margin-top: 0.3rem;">Quantità: ${item.quantity}</div>
                                    </div>
                                    <div style="text-align: right; margin-left: 1rem;">
                                        <div><strong>${item.quantity} ${item.product.uom || 'pz'}</strong></div>
                                        <div style="color: #27ae60; font-weight: 600;">CHF ${(item.price * item.quantity).toFixed(2)}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div style="border-top: 2px solid #dee2e6; padding-top: 1.5rem; margin-bottom: 2rem; background: #f8f9fa; padding: 1.5rem; border-radius: 10px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span>Subtotale:</span>
                            <span>CHF ${subtotal.toFixed(2)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; color: #666;">
                            <span>IVA (8%):</span>
                            <span>CHF ${tax.toFixed(2)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 1.4rem; font-weight: bold; color: #2c3e50; border-top: 2px solid #27ae60; padding-top: 0.8rem; margin-top: 0.8rem;">
                            <span>Totale Ordine:</span>
                            <span style="color: #27ae60;">CHF ${total.toFixed(2)}</span>
                        </div>
                    </div>

                    <div style="display: flex; gap: 1rem;">
                        <button class="action-btn btn-primary" onclick="saveOrderDraft()" style="flex: 1;">
                            💾 Salva Bozza
                        </button>
                        <button class="action-btn btn-success" onclick="validateAndConfirmOrder()" style="flex: 1;">
                            ✅ Conferma Ordine
                        </button>
                    </div>
                `;

                document.getElementById('orderModalContent').innerHTML = orderHTML;

                // Focus sulla data di consegna e setup event listeners
                setTimeout(() => {
                    const deliveryInput = document.getElementById('deliveryDate');
                    const notesInput = document.getElementById('orderNotes');

                    if (deliveryInput) {
                        deliveryInput.focus();

                        // Reset colore bordo quando l'utente modifica
                        deliveryInput.addEventListener('input', function() {
                            this.style.borderColor = '#27ae60';
                        });

                        // Mostra reminder se lascia vuoto
                        deliveryInput.addEventListener('blur', function() {
                            if (!this.value) {
                                this.style.borderColor = '#e74c3c';
                                showNotification('⚠️ Ricorda: la data di consegna è obbligatoria', 'warning');
                            }
                        });
                    }

                    // Conta caratteri nelle note
                    if (notesInput) {
                        notesInput.addEventListener('input', function() {
                            const charCount = this.value.length;
                            if (charCount > 500) {
                                this.style.borderColor = '#e74c3c';
                                showNotification('⚠️ Note troppo lunghe (max 500 caratteri)', 'warning');
                            } else {
                                this.style.borderColor = '#f39c12';
                            }
                        });
                    }
                }, 100);
            }

            document.getElementById('orderModal').classList.add('show');
        }

        function validateAndConfirmOrder() {
            // Validazione data di consegna obbligatoria
            const deliveryDateInput = document.getElementById('deliveryDate');
            if (!deliveryDateInput || !deliveryDateInput.value) {
                showNotification('❌ La data di consegna è obbligatoria!', 'error');
                if (deliveryDateInput) {
                    deliveryDateInput.style.borderColor = '#e74c3c';
                    deliveryDateInput.focus();
                }
                return;
            }

            // Validazione data non nel passato
            const selectedDate = new Date(deliveryDateInput.value);
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            if (selectedDate < today) {
                showNotification('❌ La data di consegna non può essere nel passato!', 'error');
                deliveryDateInput.style.borderColor = '#e74c3c';
                deliveryDateInput.focus();
                return;
            }

            // Salva i dati nel carrello prima di confermare
            appState.currentOrder.deliveryDate = deliveryDateInput.value;
            appState.currentOrder.notes = document.getElementById('orderNotes').value || '';

            console.log('📅 Data consegna selezionata:', deliveryDateInput.value);
            console.log('📝 Note ordine:', appState.currentOrder.notes || '(nessuna nota)');

            // Procedi con la conferma dell'ordine
            confirmOrder();
        }

        function saveOrderDraft() {
            // Salva anche data e note per la bozza
            const deliveryDateInput = document.getElementById('deliveryDate');
            const orderNotesInput = document.getElementById('orderNotes');

            if (deliveryDateInput) {
                appState.currentOrder.deliveryDate = deliveryDateInput.value;
            }
            if (orderNotesInput) {
                appState.currentOrder.notes = orderNotesInput.value || '';
            }

            showNotification('💾 Bozza salvata con data e note (feature simulata)', 'success');
            closeOrderModal();
        }

        async function confirmOrder() {
            // Validazioni preliminari
            if (!appState.currentClient) {
                showNotification('⚠️ Seleziona un cliente prima di confermare l\'ordine', 'warning');
                return;
            }

            if (appState.currentOrder.length === 0) {
                showNotification('⚠️ Aggiungi almeno un prodotto al carrello', 'warning');
                return;
            }

            // Validazione ID cliente
            if (!appState.currentClient.id || isNaN(appState.currentClient.id)) {
                showNotification('❌ ID cliente non valido: ' + appState.currentClient.id, 'error');
                return;
            }

            // Validazione prodotti nel carrello
            const invalidProducts = appState.currentOrder.filter(item =>
                !item.productId || !item.quantity || item.quantity <= 0 || !item.price
            );

            if (invalidProducts.length > 0) {
                showNotification(`❌ Trovati ${invalidProducts.length} prodotti con dati non validi nel carrello`, 'error');
                console.error('Prodotti non validi:', invalidProducts);
                return;
            }

            try {
                showNotification('🔄 Creazione ordine in corso...', 'info');
                console.log('📋 Inizio creazione ordine per cliente:', appState.currentClient.name, '(ID:', appState.currentClient.id, ')');

                if (appState.isConnected) {
                    // Modalità reale - crea ordine in Odoo
                    const now = new Date();

                    // Prepara solo le note utente (se presenti)
                    let htmlNote = '';

                    if (appState.currentOrder.notes) {
                        // Solo il messaggio dell'utente, pulito
                        htmlNote = appState.currentOrder.notes.replace(/\n/g, '<br>');
                        console.log('📝 Note utente (solo messaggio):', appState.currentOrder.notes);
                    }

                    // Info di sistema vanno nel campo note principale (per debug)
                    let systemInfo = `Ordine da App Catalogo Venditori - ${now.toLocaleDateString('it-IT')} ${now.toLocaleTimeString('it-IT')}`;
                    if (appState.currentOrder.deliveryDate) {
                        const deliveryDateFormatted = new Date(appState.currentOrder.deliveryDate).toLocaleDateString('it-IT');
                        systemInfo += ` | Consegna: ${deliveryDateFormatted}`;
                    }

                    const orderData = {
                        partner_id: appState.currentClient.id,
                        date_order: formatDateForOdoo(now),
                        state: 'draft'
                    };

                    // USA il campo internal_note per la tab "Note" separata
                    if (htmlNote) {
                        orderData.internal_note = htmlNote;
                        console.log('📝 Note impostate nel campo internal_note (tab Note separata)');
                    }

                    // Info di sistema nel riferimento ordine cliente (campo che sappiamo esiste)
                    orderData.client_order_ref = systemInfo;

                    // Se c'è una data di consegna, prova ad aggiungerla come campo specifico
                    if (appState.currentOrder.deliveryDate) {
                        // Converti data consegna nel formato Odoo
                        const deliveryDate = new Date(appState.currentOrder.deliveryDate + 'T12:00:00');
                        orderData.commitment_date = formatDateForOdoo(deliveryDate);
                        console.log('📅 Data consegna formattata per Odoo:', orderData.commitment_date);
                    }

                    console.log('📅 Data ordine formattata per Odoo:', orderData.date_order);
                    console.log('📋 Note interne impostate:', orderData.internal_note || '(nessuna nota)');
                    if (appState.currentOrder.deliveryDate) {
                        console.log('📅 Data consegna:', appState.currentOrder.deliveryDate);
                    }

                    const orderId = await create('sale.order', orderData);
                    console.log(`✅ Ordine creato con ID: ${orderId}`);

                    // Crea righe ordine
                    let lineCount = 0;
                    for (const item of appState.currentOrder) {
                        try {
                            const lineData = {
                                order_id: orderId,
                                product_id: item.productId,
                                product_uom_qty: item.quantity,
                                price_unit: item.price,
                                name: item.product.name
                            };

                            await create('sale.order.line', lineData);
                            lineCount++;
                            console.log(`✅ Riga ${lineCount} creata per: ${item.product.name}`);
                        } catch (lineError) {
                            console.error(`❌ Errore creazione riga per ${item.product.name}:`, lineError);
                            showNotification(`⚠️ Errore riga prodotto: ${item.product.name}`, 'warning');
                        }
                    }

                    if (lineCount > 0) {
                        showNotification(`🎉 Ordine #${orderId} creato con ${lineCount} righe!`, 'success');
                    } else {
                        showNotification(`⚠️ Ordine #${orderId} creato ma senza righe valide`, 'warning');
                    }
                } else {
                    // Modalità demo - simula creazione ordine
                    const demoOrderId = 'DEMO-' + Date.now().toString().slice(-6);
                    console.log(`🎭 Demo: simulata creazione ordine ${demoOrderId}`);

                    // Simula delay di creazione
                    await new Promise(resolve => setTimeout(resolve, 1500));

                    showNotification(`🎭 Ordine demo #${demoOrderId} simulato con successo!`, 'success');
                    showNotification('💡 In modalità reale, questo ordine sarebbe stato creato in Odoo', 'info');
                }

                // Reset carrello
                appState.currentOrder = [];
                updateCartSummary();
                closeOrderModal();

            } catch (error) {
                console.error('❌ Errore creazione ordine:', error);
                showNotification('❌ Errore creazione ordine: ' + error.message, 'error');
            }
        }

        // ========================================
        // MODAL E DETTAGLI PRODOTTO
        // ========================================

        function showProductDetails(productId) {
            const product = appState.products.find(p => p.id === productId) ||
                            appState.filteredProducts.find(p => p.id === productId);

            if (!product) {
                showNotification('❌ Prodotto non trovato', 'error');
                return;
            }

            // Ripristina la struttura originale del modal se necessario
            const modal = document.getElementById('productModal');
            const modalContent = document.querySelector('#productModal .modal-content');

            // Se la struttura non è quella corretta, ricreala
            if (!document.getElementById('modalProductName')) {
                modalContent.innerHTML = `
                    <div class="modal-header">
                        <h2 class="modal-title" id="modalProductName">${product.name}</h2>
                        <button class="close-btn" onclick="closeModal()">&times;</button>
                    </div>
                    <div id="modalContent">
                        <!-- Contenuto dinamico -->
                    </div>
                `;
            } else {
                document.getElementById('modalProductName').textContent = product.name;
            }

            const productDetailsContent = `
                <div style="text-align: center; margin-bottom: 2rem;">
                    <div style="width: 300px; height: 300px; background: #f8f9fa; border-radius: 20px; margin: 0 auto; overflow: hidden; box-shadow: 0 5px 20px rgba(0,0,0,0.1);">
                        ${product.image ?
                            `<img src="data:image/png;base64,${product.image}" alt="${product.name}" style="width: 100%; height: 100%; object-fit: cover;" />` :
                            `<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 4rem; color: #ddd;">📦</div>`
                        }
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
                    <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 15px;">
                        <h4 style="margin-bottom: 1rem; color: #2c3e50;">📊 Informazioni Base</h4>
                        <div style="margin-bottom: 0.8rem;"><strong>Categoria:</strong> ${getCategoryIcon(product.category)} ${product.category.toUpperCase()}</div>
                        <div style="margin-bottom: 0.8rem;"><strong>Unità di Misura:</strong> ${product.uom || 'pz'}</div>
                        <div><strong>Template ID:</strong> ${product.productTmplId || 'N/A'}</div>
                    </div>

                    <div style="background: #e3f2fd; padding: 1.5rem; border-radius: 15px;">
                        <h4 style="margin-bottom: 1rem; color: #1976d2;">💰 Prezzi e Disponibilità</h4>
                        <div style="margin-bottom: 0.8rem;"><strong>Prezzo vendita:</strong> <span style="color: #27ae60; font-size: 1.2rem; font-weight: 700;">CHF ${product.price.toFixed(2)} / ${product.uom || 'pz'}</span></div>
                        <div style="margin-bottom: 0.8rem;"><strong>Costo:</strong> CHF ${product.cost.toFixed(2)} / ${product.uom || 'pz'}</div>
                        <div style="margin-bottom: 0.8rem;"><strong>Giacenza:</strong> <span style="color: ${product.stock > CONFIG.STOCK_THRESHOLDS.LOW ? '#27ae60' : product.stock > 0 ? '#f39c12' : '#e74c3c'}; font-weight: 600;">${Math.round(product.stock)}</span></div>
                        <div><strong>Giacenza virtuale:</strong> ${Math.round(product.virtualStock)}</div>
                    </div>
                </div>

                ${product.description ? `
                    <div style="background: #f3e5f5; padding: 1.5rem; border-radius: 15px; margin-bottom: 2rem;">
                        <h4 style="margin-bottom: 1rem; color: #8e44ad;">📝 Descrizione</h4>
                        <p style="line-height: 1.6;">${product.description}</p>
                    </div>
                ` : ''}

                ${product.badges.length > 0 ? `
                    <div style="background: #fff3cd; padding: 1.5rem; border-radius: 15px; margin-bottom: 2rem;">
                        <h4 style="margin-bottom: 1rem; color: #856404;">🏷️ Badge e Caratteristiche</h4>
                        <div style="display: flex; gap: 0.8rem; flex-wrap: wrap;">
                            ${product.badges.map(badge => {
                                const badgeInfo = {
                                    'trend': { text: '🔥 Prodotto di Tendenza', color: '#e74c3c' },
                                    'offer': { text: '💰 In Offerta Speciale', color: '#f39c12' },
                                    'bestseller': { text: '⭐ Best Seller', color: '#9b59b6' }
                                };
                                const info = badgeInfo[badge] || { text: badge, color: '#6c757d' };
                                return `<span style="background: ${info.color}; color: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem; font-weight: 600;">${info.text}</span>`;
                            }).join('')}
                        </div>
                    </div>
                ` : ''}

                ${appState.currentClient && product.lastPurchase ? `
                    <div style="background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%); padding: 1.5rem; border-radius: 15px; margin-bottom: 2rem;">
                        <h4 style="margin-bottom: 1rem; color: #1976d2;">📋 Cronologia Cliente</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; text-align: center;">
                            <div style="background: white; padding: 1rem; border-radius: 10px;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #27ae60;">${product.lastQuantity}</div>
                                <div style="font-size: 0.9rem; color: #666;">Quantità Media</div>
                            </div>
                            <div style="background: white; padding: 1rem; border-radius: 10px;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #3498db;">${product.totalOrders || 0}</div>
                                <div style="font-size: 0.9rem; color: #666;">Ordini Totali</div>
                            </div>
                            <div style="background: white; padding: 1rem; border-radius: 10px;">
                                <div style="font-size: 1rem; font-weight: 700; color: #9b59b6;">${product.lastPurchase}</div>
                                <div style="font-size: 0.9rem; color: #666;">Ultimo Acquisto</div>
                            </div>
                        </div>
                    </div>
                ` : ''}

                <div style="background: ${product.stock > 0 ? '#d4edda' : '#f8d7da'}; padding: 1.5rem; border-radius: 15px; margin-bottom: 2rem;">
                    <h4 style="margin-bottom: 1rem; color: ${product.stock > 0 ? '#155724' : '#721c24'};">
                        ${product.stock > 0 ? '✅ Stato Disponibilità' : '❌ Non Disponibile'}
                    </h4>
                    <p style="margin-bottom: 1rem; color: ${product.stock > 0 ? '#155724' : '#721c24'};">
                        ${product.stock > CONFIG.STOCK_THRESHOLDS.HIGH ?
                            '🟢 Ampia disponibilità in magazzino' :
                            product.stock > CONFIG.STOCK_THRESHOLDS.LOW ?
                                '🟡 Disponibilità limitata - ordina presto' :
                                product.stock > 0 ?
                                    '🟠 Ultime unità disponibili' :
                                    '🔴 Prodotto attualmente non disponibile'
                        }
                    </p>
                    ${product.stock <= CONFIG.STOCK_THRESHOLDS.LOW && product.stock > 0 ?
                        '<div style="font-size: 0.9rem; font-style: italic;">⚠️ Ti consigliamo di verificare la disponibilità prima di inserire ordini di grandi quantità.</div>' : ''
                    }
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    ${appState.currentClient ? `
                        <button class="action-btn btn-success" onclick="addToCart(${product.id}); closeModal();" style="flex: 1;">
                            🛒 Aggiungi al Carrello
                        </button>
                        <button class="action-btn btn-primary" onclick="askAIAboutProduct(${product.id}); closeModal();" style="flex: 1;">
                            🤖 Chiedi all'IA
                        </button>
                    ` : `
                        <button class="action-btn btn-warning" onclick="alert('Seleziona prima un cliente per aggiungere prodotti al carrello')" style="flex: 1;">
                            👤 Seleziona Cliente
                        </button>
                    `}
                </div>
            `;

            // Verifica che l'elemento modalContent esista prima di impostare il contenuto
            const modalContentElement = document.getElementById('modalContent');
            if (modalContentElement) {
                modalContentElement.innerHTML = productDetailsContent;
            }

            // Mostra il modal
            modal.style.display = 'flex';
            modal.classList.add('show');
        }

        function closeModal() {
            const modal = document.getElementById('productModal');
            if (modal) {
                modal.classList.remove('show');
                modal.style.display = 'none';
                modal.onclick = null; // Rimuovi event listener
                console.log('✅ Modal chiuso normalmente');
            }
        }

        function closeOrderModal() {
            document.getElementById('orderModal').classList.remove('show');
        }

        // ========================================
        // AI ASSISTANT
        // ========================================

        function toggleAI() {
            const panel = document.getElementById('aiPanel');
            panel.classList.toggle('show');

            if (panel.classList.contains('show')) {
                document.getElementById('aiInput').focus();
            }
        }

        async function callGeminiAPI(userMessage) {
            const systemContext = buildSystemContext();

            const prompt = `Sei un assistente AI esperto per un'app di vendita di prodotti per commercianti.

CONTESTO ATTUALE:
${systemContext}

ISTRUZIONI:
- Rispondi in italiano in modo professionale e utile
- Usa le informazioni del contesto per dare risposte precise
- Suggerisci azioni concrete quando possibile
- Se puoi filtrare/cercare prodotti, spiega come fare
- Sii conciso ma completo (max 3-4 frasi)

DOMANDA UTENTE: ${userMessage}

RISPOSTA:`;

            try {
                const response = await fetch(CONFIG.GEMINI_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-goog-api-key': CONFIG.GEMINI_API_KEY
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }],
                        generationConfig: {
                            maxOutputTokens: 300,
                            temperature: 0.7
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                    return data.candidates[0].content.parts[0].text;
                } else {
                    throw new Error('Risposta non valida dall\'API');
                }
            } catch (error) {
                console.error('Errore Gemini API:', error);
                return generateFallbackResponse(userMessage);
            }
        }

        function buildSystemContext() {
            let context = '';

            // Informazioni sul cliente attuale
            if (appState.currentClient) {
                context += `\nCLIENTE SELEZIONATO: ${appState.currentClient.name} (${appState.currentClient.address})`;
                const clientProducts = appState.products.filter(p => p.lastPurchase);
                if (clientProducts.length > 0) {
                    context += `\n- Ha acquistato ${clientProducts.length} prodotti diversi in passato`;
                }
            } else {
                context += '\nNESSUN CLIENTE SELEZIONATO - suggerisci di selezionarne uno per funzioni avanzate';
            }

            // Informazioni sui prodotti
            context += `\nPRODOTTI TOTALI: ${appState.products.length}`;
            context += `\nPRODOTTI FILTRATI CORRENTI: ${appState.filteredProducts.length}`;

            const offers = appState.products.filter(p => p.badges.includes('offer')).length;
            const trending = appState.products.filter(p => p.badges.includes('trend')).length;
            const available = appState.products.filter(p => p.stock > 0).length;

            context += `\n- ${offers} prodotti in offerta`;
            context += `\n- ${trending} prodotti di tendenza`;
            context += `\n- ${available} prodotti disponibili in stock`;

            // Informazioni sul carrello
            if (appState.currentOrder.length > 0) {
                const total = appState.currentOrder.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                context += `\nCARRELLO: ${appState.currentOrder.length} prodotti per CHF ${total.toFixed(2)}`;
            } else {
                context += '\nCARRELLO VUOTO';
            }

            // Connessione Odoo
            context += appState.isConnected ? '\nCONNESSO A ODOO' : '\nMODALITÀ DEMO (non connesso a Odoo)';

            return context;
        }

        function generateFallbackResponse(message) {
            const lowerMessage = message.toLowerCase();

            if (lowerMessage.includes('offert') || lowerMessage.includes('scont')) {
                const offersCount = appState.products.filter(p => p.badges.includes('offer')).length;
                return `🏷️ Attualmente abbiamo ${offersCount} prodotti in offerta. Usa il filtro "Offerte" per vederli tutti!`;
            }

            if (lowerMessage.includes('client') && !appState.currentClient) {
                return `👤 Prima seleziona un cliente dalla barra di ricerca in alto per accedere a funzioni avanzate come cronologia acquisti e ordini personalizzati.`;
            }

            if (lowerMessage.includes('stat') || lowerMessage.includes('cronolog')) {
                if (!appState.currentClient) {
                    return `📊 Per vedere le statistiche, seleziona prima un cliente dalla barra di ricerca.`;
                }
                return `📊 Clicca su "📊 Cronologia" per vedere le statistiche dettagliate di ${appState.currentClient.name}.`;
            }

            return `🤖 Posso aiutarti con prodotti, clienti, prezzi e ordini. Dimmi cosa ti serve specificatamente!`;
        }

        async function sendAIMessage(message = null) {
            const input = document.getElementById('aiInput');
            const chat = document.getElementById('aiChat');

            const messageText = message || input.value.trim();
            if (!messageText) return;

            // Clear input
            input.value = '';

            // Aggiungi messaggio utente
            const userMessage = document.createElement('div');
            userMessage.style.cssText = 'background: #e3f2fd; padding: 1rem; border-radius: 15px; margin-bottom: 1rem; border-left: 4px solid #1976d2;';
            userMessage.innerHTML = `<strong>Tu:</strong> ${messageText}`;
            chat.appendChild(userMessage);

            // Mostra indicator di caricamento
            const loadingMessage = document.createElement('div');
            loadingMessage.id = 'ai-loading';
            loadingMessage.style.cssText = 'background: #f3e5f5; padding: 1rem; border-radius: 15px; margin-bottom: 1rem; border-left: 4px solid #8e44ad;';
            loadingMessage.innerHTML = `<strong>🤖 Assistente:</strong> <span style="opacity: 0.7">⏳ Sto pensando...</span>`;
            chat.appendChild(loadingMessage);
            chat.scrollTop = chat.scrollHeight;

            try {
                const aiResponse = await callGeminiAPI(messageText);

                // Rimuovi loading e mostra risposta
                loadingMessage.remove();
                const aiMessage = document.createElement('div');
                aiMessage.style.cssText = 'background: #f3e5f5; padding: 1rem; border-radius: 15px; margin-bottom: 1rem; border-left: 4px solid #8e44ad;';
                aiMessage.innerHTML = `<strong>🤖 Assistente:</strong> ${aiResponse}`;
                chat.appendChild(aiMessage);

                // Save to history
                appState.aiHistory.push({ user: messageText, ai: aiResponse });
            } catch (error) {
                console.error('Errore AI:', error);
                loadingMessage.innerHTML = `<strong>🤖 Assistente:</strong> <span style="color: #e74c3c;">⚠️ Errore di connessione. Riprova tra poco.</span>`;
            }

            chat.scrollTop = chat.scrollHeight;
        }

        function generateAIResponse(message) {
            const lowerMessage = message.toLowerCase();

            if (lowerMessage.includes('offert') || lowerMessage.includes('scont')) {
                const offersCount = appState.products.filter(p => p.badges.includes('offer')).length;
                return `🏷️ Attualmente abbiamo <strong>${offersCount} prodotti in offerta</strong>. Vuoi che filtri solo quelli con sconti attivi?`;
            }

            if (lowerMessage.includes('trend') || lowerMessage.includes('vendut')) {
                const trendingCount = appState.products.filter(p => p.badges.includes('trend')).length;
                return `🔥 Ho trovato <strong>${trendingCount} prodotti di tendenza</strong> basati sulle vendite recenti. Posso mostrarti quelli più popolari nella categoria che ti interessa!`;
            }

            if (lowerMessage.includes('client') && appState.currentClient) {
                const purchasedCount = appState.products.filter(p => p.lastPurchase).length;
                return `👤 Il cliente <strong>${appState.currentClient.name}</strong> ha acquistato <strong>${purchasedCount} prodotti diversi</strong> in passato. Vuoi vedere la cronologia o creare un ordine basato sui suoi acquisti abituali?`;
            }

            if (lowerMessage.includes('alternativ') || lowerMessage.includes('sostitut')) {
                return `🔄 Per suggerirti alternative ho bisogno di sapere quale prodotto ti interessa. Puoi dirmi il nome o il codice del prodotto che stai cercando di sostituire?`;
            }

            if (lowerMessage.includes('prezzo') || lowerMessage.includes('cost')) {
                return `💰 Posso aiutarti con i prezzi! Dimmi il nome del prodotto e, se hai selezionato un cliente, ti mostrerò il prezzo specifico del suo listino.`;
            }

            if (lowerMessage.includes('giacenza') || lowerMessage.includes('disponib') || lowerMessage.includes('stock')) {
                const availableCount = appState.products.filter(p => p.stock > 0).length;
                return `📦 Al momento abbiamo <strong>${availableCount} prodotti disponibili</strong> in magazzino. Posso verificare la disponibilità di prodotti specifici se me li indichi!`;
            }

            if (lowerMessage.includes('crea') && lowerMessage.includes('ordin')) {
                if (!appState.currentClient) {
                    return `⚠️ Per creare un ordine devi prima selezionare un cliente. Usa la ricerca clienti nell'intestazione!`;
                }
                return `📝 Perfetto! Posso aiutarti a creare un ordine per <strong>${appState.currentClient.name}</strong>. Vuoi che aggiunga prodotti basandomi sulla cronologia acquisti o preferisci selezionarli manualmente?`;
            }

            if (lowerMessage.includes('cerca') || lowerMessage.includes('trova')) {
                return `🔍 Dimmi cosa stai cercando! Posso aiutarti a trovare prodotti per nome, codice, categoria o caratteristiche specifiche. Sono molto bravo anche con ricerche approssimative!`;
            }

            // Risposta generica
            return `🤖 Ho capito che ti serve aiuto con "${message}". Posso aiutarti a:
                    <br>• 🔍 Cercare prodotti specifici
                    <br>• 💰 Verificare prezzi e offerte
                    <br>• 📦 Controllare disponibilità
                    <br>• 👤 Gestire clienti e cronologie
                    <br>• 📋 Creare e gestire ordini
                    <br><br>Cosa posso fare per te?`;
        }

        function askAIAboutProduct(productId) {
            const product = appState.products.find(p => p.id === productId);
            if (!product) return;

            toggleAI();
            setTimeout(() => {
                sendAIMessage(`Dimmi tutto sul prodotto "${product.name}" - prezzo, disponibilità e suggerimenti`);
            }, 300);
        }

        // ========================================
        // FUNZIONI UTILITY
        // ========================================

        function refreshProducts() {
            showNotification('🔄 Aggiornamento in corso...', 'info');
            appState.products = [];
            appState.filteredProducts = [];
            appState.productsLoaded = 0;
            loadProducts();
        }

        function showNotification(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;

            document.body.appendChild(toast);

            setTimeout(() => toast.classList.add('show'), 100);

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 4000);

            console.log(`${type.toUpperCase()}: ${message}`);
        }

        // ========================================
        // KEYBOARD SHORTCUTS
        // ========================================

        document.addEventListener('keydown', function(e) {
            // ESC per chiudere modal con forza
            if (e.key === 'Escape') {
                e.preventDefault();
                forceCloseModal();
                closeOrderModal();
                if (document.getElementById('aiPanel').classList.contains('show')) {
                    toggleAI();
                }
            }

            // Ctrl/Cmd + K per aprire ricerca
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                document.getElementById('productSearch').focus();
            }

            // Ctrl/Cmd + / per aprire AI
            if ((e.ctrlKey || e.metaKey) && e.key === '/') {
                e.preventDefault();
                toggleAI();
            }
        });

        // ========================================
        // DEBUG E DEVELOPMENT
        // ========================================

        // Esponi funzioni per debug in console (namespace sicuro)
        if (!window.CatalogoVenditori) {
            window.CatalogoVenditori = {};
        }
        window.CatalogoVenditori.Debug = {
            state: appState,
            config: CONFIG,
            loadProducts,
            searchProducts: searchProductsInOdoo,
            rpc,
            searchRead,
            create,
            formatDateForOdoo,
            testDateFormat: function() {
                const now = new Date();
                console.log('🕐 Test formattazione data:');
                console.log('JavaScript Date:', now);
                console.log('ISO String:', now.toISOString());
                console.log('Formato Odoo:', formatDateForOdoo(now));
                return formatDateForOdoo(now);
            },
            testOrderFields: async function() {
                console.log('🔍 Test campi ordine disponibili...');
                try {
                    // Cerca un ordine esistente per vedere i campi disponibili
                    const orders = await searchRead('sale.order', [], [], 1);
                    if (orders.length > 0) {
                        console.log('📋 Campi ordine disponibili:', Object.keys(orders[0]));
                        const noteFields = Object.keys(orders[0]).filter(field =>
                            field.toLowerCase().includes('note') ||
                            field.toLowerCase().includes('internal')
                        );
                        console.log('📝 Campi che contengono "note" o "internal":', noteFields);

                        // Mostra anche tutti i campi x_ (custom)
                        const customFields = Object.keys(orders[0]).filter(field => field.startsWith('x_'));
                        console.log('🔧 Campi custom (x_):', customFields);
                    }
                } catch (error) {
                    console.error('❌ Errore test campi:', error);
                }
            },
            findNotesField: async function() {
                console.log('🕵️ Ricerca campo note specifico...');
                try {
                    // Prima verifica il modello sale.order
                    const modelInfo = await rpc('ir.model.fields', 'search_read',
                        [['model', '=', 'sale.order']],
                        ['name', 'field_description', 'ttype']
                    );

                    const noteFields = modelInfo.filter(field =>
                        field.name.toLowerCase().includes('note') ||
                        field.field_description.toLowerCase().includes('note') ||
                        field.field_description.toLowerCase().includes('internal')
                    );

                    console.log('📝 Campi note trovati nel modello:', noteFields);

                    // Cerca anche campi che potrebbero essere per note interne
                    const possibleFields = modelInfo.filter(field =>
                        field.name.includes('comment') ||
                        field.name.includes('narration') ||
                        field.name.includes('internal') ||
                        field.name.includes('remark') ||
                        field.name.startsWith('x_note') ||
                        field.name.startsWith('x_comment')
                    );

                    console.log('🔍 Altri possibili campi per note:', possibleFields);
                    return { noteFields, possibleFields };
                } catch (error) {
                    console.error('❌ Errore ricerca campi:', error);
                }
            },
            testWithDifferentFields: async function(testNote = 'Test da Catalogo App') {
                console.log('🧪 Test con campi diversi...');

                // Lista di possibili campi da testare
                const fieldsToTest = [
                    'note',
                    'comment',
                    'internal_note',
                    'x_note',
                    'x_internal_note',
                    'x_comment',
                    'narration',
                    'remark',
                    'client_order_ref',
                    'origin',
                    'reference'
                ];

                for (const fieldName of fieldsToTest) {
                    try {
                        console.log(`🔍 Test campo: ${fieldName}`);

                        // Prova a leggere un ordine con questo campo
                        const orders = await searchRead('sale.order', [], [fieldName], 1);
                        if (orders.length > 0 && orders[0].hasOwnProperty(fieldName)) {
                            console.log(`✅ Campo ${fieldName} trovato:`, orders[0][fieldName]);
                        } else {
                            console.log(`❌ Campo ${fieldName} non esiste`);
                        }
                    } catch (error) {
                        console.log(`❌ Campo ${fieldName} errore:`, error.message);
                    }
                }
            }
        };

        console.log('🚀 Catalogo Venditori App inizializzata');
        console.log('Debug disponibile in window.AppDebug');
    </script>