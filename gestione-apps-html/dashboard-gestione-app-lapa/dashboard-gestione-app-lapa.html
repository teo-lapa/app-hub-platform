<meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>LAPA Gestione - Dashboard Sistema</title>
  
  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --secondary: #64748b;
      --success: #059669;
      --warning: #d97706;
      --danger: #dc2626;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --gray-900: #111827;
      --white: #ffffff;
      --text-primary: var(--gray-900);
      --text-secondary: var(--gray-600);
      --border: var(--gray-200);
      --bg-primary: var(--white);
      --bg-secondary: var(--gray-50);
    }

    body[data-theme="dark"] {
      --text-primary: #f3f4f6;
      --text-secondary: #9ca3af;
      --border: #374151;
      --bg-primary: #1f2937;
      --bg-secondary: #111827;
      background: var(--bg-secondary) !important;
    }

    body[data-theme="dark"] .header {
      background: var(--bg-primary) !important;
      border-bottom-color: var(--border) !important;
    }

    body[data-theme="dark"] .app-card {
      background: var(--bg-primary) !important;
      border-color: var(--border) !important;
    }

    body[data-theme="dark"] .admin-panel {
      background: var(--bg-primary) !important;
      border-color: var(--border) !important;
    }

    body[data-theme="dark"] .app-permission {
      background: var(--bg-secondary) !important;
      border-color: var(--border) !important;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: var(--bg-secondary);
      color: var(--text-primary);
      line-height: 1.6;
      /* Futuristic animated background */
      background-image: 
        radial-gradient(circle at 20% 80%, rgba(120, 60, 255, 0.1) 0%, transparent 70%),
        radial-gradient(circle at 80% 20%, rgba(255, 60, 120, 0.1) 0%, transparent 70%),
        radial-gradient(circle at 40% 40%, rgba(60, 255, 120, 0.08) 0%, transparent 60%);
      background-size: 100% 100%;
      animation: magicShift 20s ease-in-out infinite;
    }

    body[data-theme="light"] {
      --text-primary: #111827;
      --text-secondary: #6b7280;
      --border: #e5e7eb;
      --bg-primary: #ffffff;
      --bg-secondary: #f9fafb;
      background: var(--bg-secondary) !important;
      background-image: 
        radial-gradient(circle at 20% 80%, rgba(59, 130, 246, 0.05) 0%, transparent 70%),
        radial-gradient(circle at 80% 20%, rgba(236, 72, 153, 0.05) 0%, transparent 70%),
        radial-gradient(circle at 40% 40%, rgba(34, 197, 94, 0.03) 0%, transparent 60%) !important;
    }

    body[data-theme="light"] .header {
      background: var(--bg-primary) !important;
      border-bottom-color: var(--border) !important;
    }

    body[data-theme="light"] .app-card {
      background: var(--bg-primary) !important;
      border-color: var(--border) !important;
    }

    body[data-theme="light"] .admin-panel {
      background: var(--bg-primary) !important;
      border-color: var(--border) !important;
    }

    @keyframes magicShift {
      0%, 100% { background-position: 0% 0%, 100% 100%, 50% 50%; }
      33% { background-position: 30% 70%, 70% 30%, 80% 20%; }
      66% { background-position: 70% 30%, 30% 70%, 20% 80%; }
    }

    /* HEADER */
    .header {
      background: var(--bg-primary);
      border-bottom: 1px solid var(--border);
      padding: 1rem 2rem;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
      position: relative;
    }

    .header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.5), transparent);
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-brand {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .brand-logo {
      width: 50px;
      height: 50px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      border-radius: 50%;
    }

    .brand-logo:hover {
      transform: scale(1.1);
      filter: drop-shadow(0 0 10px rgba(220, 38, 38, 0.6));
    }

    .lapa-logo {
      width: 100%;
      height: 100%;
      background-image: url('logo lapa.png');
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center;
      border-radius: 50%;
    }

    .brand-text h1 {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .brand-text p {
      font-size: 14px;
      color: var(--text-secondary);
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.5rem 1rem;
      font-size: 14px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
    }

    .status-dot.disconnected {
      background: var(--danger);
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: var(--primary);
      color: white;
      border-radius: 8px;
      padding: 0.5rem 1rem;
      font-size: 14px;
      font-weight: 500;
    }

    .theme-toggle {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.5rem;
      cursor: pointer;
      color: var(--text-secondary);
      transition: all 0.2s;
    }

    .theme-toggle:hover {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .attendance-btn {
      background: var(--success);
      color: white;
      border: 1px solid var(--success);
      border-radius: 8px;
      padding: 0.5rem 1rem;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 14px;
      font-weight: 500;
    }

    .attendance-btn:hover {
      background: #047857;
      border-color: #047857;
      transform: translateY(-1px);
    }

    .attendance-btn.completed {
      background: var(--gray-500);
      border-color: var(--gray-500);
      cursor: not-allowed;
    }

    .attendance-btn.completed:hover {
      background: var(--gray-500);
      transform: none;
    }

    /* MAIN CONTENT */
    .main {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }

    /* ADMIN PANEL */
    .admin-panel {
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .admin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .admin-header h2 {
      color: var(--primary);
      font-size: 20px;
      font-weight: 600;
    }

    .btn {
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 0.5rem 1rem;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn:hover {
      background: var(--primary-dark);
    }

    .btn-secondary {
      background: var(--secondary);
    }

    .btn-secondary:hover {
      background: var(--gray-600);
    }

    /* PERMISSIONS PANEL */
    .permissions-grid {
      display: grid;
      gap: 1rem;
    }

    .app-permission {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
    }

    .app-permission h4 {
      color: var(--text-primary);
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 0.75rem;
    }

    .employees-list {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .employee-chip {
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.25rem 0.5rem;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .employee-chip:hover {
      border-color: var(--primary);
    }

    .employee-chip.selected {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    /* APPLICATIONS GRID */
    .apps-section h2 {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 1.5rem;
      color: var(--text-primary);
    }

    .apps-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 1.5rem;
    }

    .app-card {
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      position: relative;
      overflow: hidden;
    }

    .app-card::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: conic-gradient(transparent, transparent, transparent, rgba(59, 130, 246, 0.1));
      opacity: 0;
      transition: opacity 0.3s;
      animation: rotate 4s linear infinite;
    }

    .app-card:hover::before {
      opacity: 1;
    }

    .app-card:hover {
      border-color: var(--primary);
      box-shadow: 
        0 8px 25px rgba(37, 99, 235, 0.15),
        0 0 0 1px rgba(59, 130, 246, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
      transform: translateY(-4px) scale(1.02);
    }

    @keyframes rotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .app-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 1rem;
    }

    .app-icon {
      width: 48px;
      height: 48px;
      background: var(--primary);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 20px;
      font-weight: bold;
      position: relative;
      overflow: hidden;
    }

    /* Specific futuristic backgrounds for each app */
    .app-card[onclick*="zone-picking"] .app-icon {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
    }

    .app-card[onclick*="delivery-manager"] .app-icon {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      box-shadow: 0 0 20px rgba(245, 87, 108, 0.3);
    }

    .app-card[onclick*="warehouse-ops"] .app-icon {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      box-shadow: 0 0 20px rgba(79, 172, 254, 0.3);
    }

    .app-card[onclick*="smart-routes"] .app-icon {
      background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
      box-shadow: 0 0 20px rgba(67, 233, 123, 0.3);
      animation: brainPulse 3s ease-in-out infinite;
    }

    .app-card[onclick*="super-admin"] .app-icon {
      background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
      box-shadow: 0 0 20px rgba(250, 112, 154, 0.3);
    }


    .app-card[onclick*="inventory-control"] .app-icon {
      background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
      box-shadow: 0 0 20px rgba(255, 154, 158, 0.3);
      animation: inventoryPulse 2s ease-in-out infinite;
    }

    .app-card[onclick*="residue-picker"] .app-icon {
      background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
      box-shadow: 0 0 20px rgba(252, 182, 159, 0.3);
      animation: residuiGlow 3s ease-in-out infinite alternate;
    }

    .app-card[onclick*="direct-control"] .app-icon {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      box-shadow: 0 0 20px rgba(102, 126, 234, 0.4);
      animation: controlScan 2.5s ease-in-out infinite;
    }

    .app-card[onclick*="control-map"] .app-icon {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      box-shadow: 0 0 20px rgba(17, 153, 142, 0.4);
      animation: mapPing 1.8s ease-in-out infinite;
    }

    .app-card[onclick*="clientivision"] .app-icon {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      box-shadow: 0 0 20px rgba(102, 126, 234, 0.4);
      animation: analyticsPulse 2.2s ease-in-out infinite;
    }

    .app-card[onclick*="sales-catalog"] .app-icon {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      box-shadow: 0 0 20px rgba(240, 147, 251, 0.4);
      animation: catalogShine 1.8s ease-in-out infinite;
    }

    .app-card[onclick*="ai-callcenter"] .app-icon {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      box-shadow: 0 0 20px rgba(79, 172, 254, 0.4);
      animation: aiPulse 2s ease-in-out infinite;
    }

    @keyframes brainPulse {
      0%, 100% { transform: scale(1); box-shadow: 0 0 20px rgba(67, 233, 123, 0.3); }
      50% { transform: scale(1.05); box-shadow: 0 0 25px rgba(67, 233, 123, 0.5); }
    }

    @keyframes logoClick {
      0% { transform: scale(1); }
      50% { transform: scale(1.2); box-shadow: 0 0 30px rgba(220, 38, 38, 0.6); }
      100% { transform: scale(1); }
    }

    @keyframes logoSpin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes inventoryPulse {
      0%, 100% { transform: scale(1); box-shadow: 0 0 20px rgba(255, 154, 158, 0.3); }
      50% { transform: scale(1.08); box-shadow: 0 0 30px rgba(255, 154, 158, 0.6); }
    }

    @keyframes analyticsPulse {
      0%, 100% { transform: scale(1); box-shadow: 0 0 20px rgba(102, 126, 234, 0.4); }
      50% { transform: scale(1.06); box-shadow: 0 0 25px rgba(102, 126, 234, 0.6); }
    }

    @keyframes catalogShine {
      0%, 100% { transform: scale(1); box-shadow: 0 0 20px rgba(240, 147, 251, 0.4); }
      50% { transform: scale(1.05) rotate(2deg); box-shadow: 0 0 25px rgba(245, 87, 108, 0.6); }
    }

    @keyframes aiPulse {
      0%, 100% {
        transform: scale(1);
        box-shadow: 0 0 20px rgba(79, 172, 254, 0.4);
        filter: brightness(1);
      }
      50% {
        transform: scale(1.08);
        box-shadow: 0 0 30px rgba(0, 242, 254, 0.6);
        filter: brightness(1.1);
      }
    }

    .delivery-control {
      background: linear-gradient(135deg, #22c55e 0%, #15803d 100%);
      animation: deliveryPulse 2.5s ease-in-out infinite;
    }

    @keyframes deliveryPulse {
      0%, 100% {
        transform: scale(1);
        box-shadow: 0 0 20px rgba(34, 197, 94, 0.4);
        filter: brightness(1);
      }
      50% {
        transform: scale(1.06);
        box-shadow: 0 0 25px rgba(21, 128, 61, 0.6);
        filter: brightness(1.15);
      }
    }

    .sales-dashboard {
      background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
      animation: dashboardPulse 2.8s ease-in-out infinite;
    }

    @keyframes dashboardPulse {
      0%, 100% {
        transform: scale(1);
        box-shadow: 0 0 20px rgba(59, 130, 246, 0.4);
        filter: brightness(1);
      }
      50% {
        transform: scale(1.07);
        box-shadow: 0 0 30px rgba(30, 64, 175, 0.6);
        filter: brightness(1.2);
      }
    }

    .smart-orders {
      background: linear-gradient(135deg, #8b5cf6 0%, #5b21b6 100%);
      animation: smartPulse 3s ease-in-out infinite;
    }

    @keyframes smartPulse {
      0%, 100% {
        transform: scale(1);
        box-shadow: 0 0 20px rgba(139, 92, 246, 0.4);
        filter: brightness(1) hue-rotate(0deg);
      }
      50% {
        transform: scale(1.08);
        box-shadow: 0 0 35px rgba(91, 33, 182, 0.7);
        filter: brightness(1.25) hue-rotate(10deg);
      }
    }

    .van-returns {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      animation: returnsPulse 2.2s ease-in-out infinite;
    }

    @keyframes returnsPulse {
      0%, 100% {
        transform: scale(1);
        box-shadow: 0 0 20px rgba(245, 158, 11, 0.4);
        filter: brightness(1);
      }
      50% {
        transform: scale(1.05);
        box-shadow: 0 0 25px rgba(217, 119, 6, 0.6);
        filter: brightness(1.1) saturate(1.2);
      }
    }

    @keyframes residuiGlow {
      0% { box-shadow: 0 0 15px rgba(252, 182, 159, 0.3); }
      100% { box-shadow: 0 0 35px rgba(252, 182, 159, 0.8); }
    }

    @keyframes controlScan {
      0% { 
        transform: scale(1); 
        box-shadow: 0 0 15px rgba(102, 126, 234, 0.4), inset 0 0 0 0px rgba(118, 75, 162, 0.3);
      }
      50% { 
        transform: scale(1.05); 
        box-shadow: 0 0 25px rgba(102, 126, 234, 0.7), inset 0 0 10px 2px rgba(118, 75, 162, 0.5);
      }
      100% { 
        transform: scale(1); 
        box-shadow: 0 0 15px rgba(102, 126, 234, 0.4), inset 0 0 0 0px rgba(118, 75, 162, 0.3);
      }
    }

    @keyframes mapPing {
      0% { 
        transform: scale(1); 
        box-shadow: 0 0 15px rgba(17, 153, 142, 0.4);
      }
      30% { 
        transform: scale(1.1); 
        box-shadow: 0 0 25px rgba(17, 153, 142, 0.6), 0 0 40px rgba(56, 239, 125, 0.3);
      }
      60% { 
        transform: scale(0.95); 
        box-shadow: 0 0 20px rgba(17, 153, 142, 0.5);
      }
      100% { 
        transform: scale(1); 
        box-shadow: 0 0 15px rgba(17, 153, 142, 0.4);
      }
    }

    .app-status {
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
    }

    .status-active {
      background: rgba(5, 150, 105, 0.1);
      color: var(--success);
    }

    .status-maintenance {
      background: rgba(217, 119, 6, 0.1);
      color: var(--warning);
    }

    .status-restricted {
      background: rgba(220, 38, 38, 0.1);
      color: var(--danger);
    }

    .app-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
    }

    .app-description {
      color: var(--text-secondary);
      font-size: 14px;
      margin-bottom: 1rem;
    }

    .app-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .app-card.hidden {
      display: none;
    }

    /* RESPONSIVE */
    @media (max-width: 768px) {
      .header {
        padding: 1rem;
      }
      
      .header-content {
        flex-direction: column;
        gap: 1rem;
        align-items: flex-start;
      }
      
      .main {
        padding: 1rem;
      }
      
      .apps-grid {
        grid-template-columns: 1fr;
      }
    }

    /* ATTENDANCE POPUP */
    .attendance-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      backdrop-filter: blur(5px);
    }

    .attendance-popup {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 2rem;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .popup-header {
      text-align: center;
      margin-bottom: 1.5rem;
    }

    .popup-header h3 {
      color: var(--primary);
      font-size: 24px;
      margin-bottom: 0.5rem;
    }

    .popup-date {
      color: var(--text-secondary);
      font-size: 16px;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      color: var(--text-primary);
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .form-group input {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-size: 14px;
    }

    .form-group input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .signature-area {
      border: 2px dashed var(--border);
      border-radius: 8px;
      height: 200px;
      background: var(--bg-secondary);
      position: relative;
      cursor: crosshair;
    }

    .signature-canvas {
      width: 100%;
      height: 100%;
      display: block;
    }

    .signature-placeholder {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: var(--text-secondary);
      text-align: center;
      pointer-events: none;
    }

    .popup-actions {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
      margin-top: 1.5rem;
    }

    .popup-btn {
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }

    .btn-cancel {
      background: var(--gray-200);
      color: var(--text-primary);
    }

    .btn-cancel:hover {
      background: var(--gray-300);
    }

    .btn-clear {
      background: var(--warning);
      color: white;
    }

    .btn-clear:hover {
      background: #b45309;
    }

    .btn-save {
      background: var(--success);
      color: white;
    }

    .btn-save:hover {
      background: #047857;
    }

    .btn-save:disabled {
      background: var(--gray-400);
      cursor: not-allowed;
    }

    /* APP MANAGEMENT STYLES */
    .admin-buttons {
      display: flex;
      gap: 1rem;
    }

    .app-manager-panel {
      margin-top: 1.5rem;
      background: var(--bg-secondary);
      border-radius: 8px;
      padding: 1.5rem;
    }

    .app-manager-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .app-manager-header h3 {
      color: var(--primary);
      margin: 0;
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-success:hover {
      background: #047857;
    }

    .apps-management-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }

    .app-management-card {
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      position: relative;
    }

    .app-management-card h5 {
      color: var(--text-primary);
      margin-bottom: 0.5rem;
    }

    .app-management-card .app-url {
      color: var(--primary);
      font-size: 12px;
      word-break: break-all;
      margin-bottom: 0.5rem;
    }

    .app-management-card .app-meta {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 1rem;
    }

    .app-management-actions {
      display: flex;
      gap: 0.5rem;
    }

    .btn-small {
      padding: 0.25rem 0.5rem;
      font-size: 12px;
      border-radius: 4px;
    }

    /* MODAL STYLES */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1001;
      backdrop-filter: blur(5px);
    }

    .app-modal {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 2rem;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      border-bottom: 1px solid var(--border);
      padding-bottom: 1rem;
    }

    .modal-header h3 {
      margin: 0;
      color: var(--primary);
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: var(--text-secondary);
      padding: 0.5rem;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .close-btn:hover {
      background: var(--gray-200);
      color: var(--text-primary);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      color: var(--text-primary);
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-size: 14px;
      box-sizing: border-box;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .form-group small {
      display: block;
      color: var(--text-secondary);
      font-size: 12px;
      margin-top: 0.25rem;
    }

    .modal-actions {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
      margin-top: 2rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border);
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-danger:hover {
      background: #b91c1c;
    }

    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }

      .app-modal {
        width: 95%;
        padding: 1.5rem;
      }

      .modal-actions {
        flex-direction: column;
      }

      .admin-buttons {
        flex-direction: column;
      }
    }
  </style>



  <header class="header">
    <div class="header-content">
      <div class="header-brand">
        <div class="brand-logo" onclick="playLogoAnimation()">
          <div class="lapa-logo"></div>
        </div>
        <div class="brand-text">
          <h1>LAPA Gestione</h1>
          <p>Sistema di Controllo Applicazioni</p>
        </div>
      </div>
      
      <div class="header-actions">
        <div class="status-indicator" id="statusIndicator">
          <div class="status-dot" id="statusDot"></div>
          <span id="statusText">Connessione in corso...</span>
        </div>
        
        <div class="user-info" id="userInfo" style="display: none;">
          <span id="userName">Utente</span>
          <span id="userRole">Admin</span>
        </div>
        
        <button class="attendance-btn" id="attendanceBtn" onclick="openAttendancePopup()" title="Segna presenza" style="display: none;">
          <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"></path>
            <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"></path>
          </svg>
          Presenza
        </button>
        
        <button class="theme-toggle" onclick="toggleTheme()" title="Cambia tema">
          <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path id="themeIcon" d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"></path>
          </svg>
        </button>
      </div>
    </div>
  </header>

  <main class="main">
    
    <div class="admin-panel" id="adminPanel" style="display: none;">
      <div class="admin-header">
        <h2>Gestione Sistema Amministratore</h2>
        <div class="admin-buttons">
          <button class="btn" onclick="toggleAdminPanel()">
            <span id="adminToggleText">Configura Accessi</span>
          </button>
          <button class="btn btn-secondary" onclick="toggleAppManager()">
            <span id="appManagerText">Gestisci App</span>
          </button>
        </div>
      </div>

      <div class="permissions-panel" id="permissionsPanel" style="display: none;">
        <div class="permissions-grid" id="permissionsGrid">

        </div>
      </div>

      
      <div class="app-manager-panel" id="appManagerPanel" style="display: none;">
        <div class="app-manager-header">
          <h3>üöÄ Gestione Applicazioni Dinamiche</h3>
          <button class="btn btn-success" onclick="openAddAppModal()">
            ‚ûï Aggiungi Nuova App
          </button>
        </div>

        <div class="current-apps-list" id="currentAppsList">
          <h4>App Attualmente Configurate:</h4>
          <div class="apps-management-grid" id="appsManagementGrid">
            
          </div>
        </div>
      </div>
    </div>

    
    <section class="apps-section">
      <h2>Applicazioni Sistema</h2>
      <div class="apps-grid" id="appsGrid">
        
        
        <div class="app-card" data-roles="warehouse" onclick="openApp('zone-picking')">
          <div class="app-header">
            <div class="app-icon">P</div>
            <div class="app-status status-active">Attivo</div>
          </div>
          <div class="app-title">üì¶ Zone Picking Pro</div>
          <div class="app-description">Sistema di prelievo WH/PICK organizzato per zone geografiche con batch intelligenti e scansione barcode</div>
          <div class="app-meta">
            <span>Magazzino</span>
            <span>v11.09.25</span>
          </div>
        </div>

        
        <div class="app-card" data-roles="delivery" onclick="openApp('delivery-manager')">
          <div class="app-header">
            <div class="app-icon">D</div>
            <div class="app-status status-active">Attivo</div>
          </div>
          <div class="app-title">üöö Delivery Manager</div>
          <div class="app-description">Sistema allegati unificato per consegne con mappa GPS, foto documenti e gestione stati consegna</div>
          <div class="app-meta">
            <span>Logistica</span>
            <span>v4.0</span>
          </div>
        </div>

        
        <div class="app-card" data-roles="warehouse" onclick="openApp('warehouse-ops')">
          <div class="app-header">
            <div class="app-icon">U</div>
            <div class="app-status status-active">Attivo</div>
          </div>
          <div class="app-title">üè≠ Warehouse Operations</div>
          <div class="app-description">Trasferimento prodotti buffer ‚Üí scaffali e riorganizzazione inventario con scansione massiva</div>
          <div class="app-meta">
            <span>Logistica Interna</span>
            <span>v10.09.25</span>
          </div>
        </div>

        
        <div class="app-card" data-roles="planning" onclick="openApp('smart-routes')">
          <div class="app-header">
            <div class="app-icon">R</div>
            <div class="app-status status-active">Attivo</div>
          </div>
          <div class="app-title">üß† Smart Routes AI</div>
          <div class="app-description">Ottimizzazione intelligente percorsi consegna con algoritmi avanzati e gestione flotta automatica</div>
          <div class="app-meta">
            <span>AI Planning</span>
            <span>v2025</span>
          </div>
        </div>

        
        <div class="app-card" data-roles="admin" onclick="openApp('super-admin')">
          <div class="app-header">
            <div class="app-icon">A</div>
            <div class="app-status status-restricted">Super User</div>
          </div>
          <div class="app-title">üëë Super Admin Hub</div>
          <div class="app-description">Dashboard amministrativa per controllo completo inventario, ubicazioni e modifica diretta stock</div>
          <div class="app-meta">
            <span>Amministrazione</span>
            <span>Odoo 17</span>
          </div>
        </div>

        

        
        <div class="app-card" data-roles="inventory" onclick="openApp('inventory-control')">
          <div class="app-header">
            <div class="app-icon">I</div>
            <div class="app-status status-active">Attivo</div>
          </div>
          <div class="app-title">üìä Inventory Control</div>
          <div class="app-description">Sistema di inventario per ubicazione con scansione barcode e conteggio sistematico</div>
          <div class="app-meta">
            <span>Inventario</span>
            <span>v2025</span>
          </div>
        </div>

        
        <div class="app-card" data-roles="picking" onclick="openApp('residue-picker')">
          <div class="app-header">
            <div class="app-icon">R</div>
            <div class="app-status status-active">Attivo</div>
          </div>
          <div class="app-title">üîÑ Residue Picker</div>
          <div class="app-description">Gestione ordini residui del picking del giorno precedente con scansione e completamento</div>
          <div class="app-meta">
            <span>Post-Picking</span>
            <span>v2025</span>
          </div>
        </div>

        
        <div class="app-card" data-roles="quality" onclick="openApp('direct-control')">
          <div class="app-header">
            <div class="app-icon">C</div>
            <div class="app-status status-active">Attivo</div>
          </div>
          <div class="app-title">‚ö° Direct Control</div>
          <div class="app-description">Verifica e controllo qualit√† dei prelievi effettuati per garantire accuratezza degli ordini</div>
          <div class="app-meta">
            <span>Quality Control</span>
            <span>v2025</span>
          </div>
        </div>

        
        <div class="app-card" data-roles="tracking" onclick="openApp('control-map')">
          <div class="app-header">
            <div class="app-icon">M</div>
            <div class="app-status status-active">Attivo</div>
          </div>
          <div class="app-title">üó∫Ô∏è Control Map</div>
          <div class="app-description">Monitoraggio in tempo reale delle consegne giornaliere, tracking GPS driver e controllo flotta</div>
          <div class="app-meta">
            <span>Fleet Tracking</span>
            <span>v2025</span>
          </div>
        </div>


        <div class="app-card" data-roles="analytics" onclick="openApp('clientivision')">
          <div class="app-header">
            <div class="app-icon">üìà</div>
            <div class="app-status status-active">Attivo</div>
          </div>
          <div class="app-title">üìà ClientiVision Analytics</div>
          <div class="app-description">Dashboard analitica avanzata per monitoraggio performance clienti con trend di crescita e statistiche vendite</div>
          <div class="app-meta">
            <span>Business Intelligence</span>
            <span>v2025</span>
          </div>
        </div>


        <div class="app-card" data-roles="sales" onclick="openApp('sales-catalog')">
          <div class="app-header">
            <div class="app-icon">üõçÔ∏è</div>
            <div class="app-status status-active">Attivo</div>
          </div>
          <div class="app-title">üõçÔ∏è Sales Catalog Pro</div>
          <div class="app-description">Catalogo venditori completo con ricerca avanzata, carrello intelligente e integrazione ordini per vendita assistita</div>
          <div class="app-meta">
            <span>Sales & Commerce</span>
            <span>v2025</span>
          </div>
        </div>

        <div class="app-card" data-roles="admin,support" onclick="openApp('ai-callcenter')">
          <div class="app-header">
            <div class="app-icon">ü§ñ</div>
            <div class="app-status status-active">Attivo</div>
          </div>
          <div class="app-title">ü§ñ AI Call Center Pro</div>
          <div class="app-description">Sistema centralino intelligente con agenti AI virtuali, gestione chiamate automatica e supporto clienti 24/7</div>
          <div class="app-meta">
            <span>AI & Communication</span>
            <span>v2025</span>
          </div>
        </div>

        <div class="app-card" data-roles="sales,admin" onclick="openApp('delivery-control')">
          <div class="app-header">
            <div class="app-icon delivery-control">üöõ</div>
            <div class="app-status status-active">Attivo</div>
          </div>
          <div class="app-title">üöõ Delivery Control Pro</div>
          <div class="app-description">Sistema avanzato controllo consegne per venditori con tracking real-time, pianificazione route e gestione logistica completa</div>
          <div class="app-meta">
            <span>Logistics & Delivery</span>
            <span>v2025</span>
          </div>
        </div>

        <div class="app-card" data-roles="sales,manager,admin" onclick="openApp('sales-dashboard')">
          <div class="app-header">
            <div class="app-icon sales-dashboard">üìä</div>
            <div class="app-status status-active">Attivo</div>
          </div>
          <div class="app-title">üìä Sales Dashboard Pro</div>
          <div class="app-description">Dashboard analytics avanzata per venditori con KPI real-time, performance tracking e business intelligence completa</div>
          <div class="app-meta">
            <span>Sales Analytics</span>
            <span>v2025</span>
          </div>
        </div>

        <div class="app-card" data-roles="admin,manager,orders" onclick="openApp('smart-orders')">
          <div class="app-header">
            <div class="app-icon smart-orders">üß†</div>
            <div class="app-status status-active">Attivo</div>
          </div>
          <div class="app-title">üß† Smart Orders AI</div>
          <div class="app-description">Sistema intelligente gestione ordini con AI, automazione workflow, predizione demand e ottimizzazione supply chain</div>
          <div class="app-meta">
            <span>AI & Order Management</span>
            <span>v2025</span>
          </div>
        </div>

        <div class="app-card" data-roles="logistics,warehouse,admin" onclick="openApp('van-returns')">
          <div class="app-header">
            <div class="app-icon van-returns">üîÑ</div>
            <div class="app-status status-active">Attivo</div>
          </div>
          <div class="app-title">üîÑ Van Returns Pro</div>
          <div class="app-description">Gestione avanzata ritorni furgoni con tracking real-time, quality control e ricollocamento automatico stock</div>
          <div class="app-meta">
            <span>Returns & Logistics</span>
            <span>v2025</span>
          </div>
        </div>

      </div>
    </section>
  </main>

  
  <div class="attendance-overlay" id="attendanceOverlay">
    <div class="attendance-popup">
      <div class="popup-header">
        <h3>Segna Presenza</h3>
        <div class="popup-date" id="popupDate"></div>
      </div>

      <div class="form-group">
        <label for="workHours">Ore di lavoro previste</label>
        <input type="text" id="workHours" value="8:40" readonly="">
      </div>

      <div class="form-group">
        <label>Firma digitale</label>
        <div class="signature-area">
          <canvas class="signature-canvas" id="signatureCanvas"></canvas>
          <div class="signature-placeholder" id="signaturePlaceholder">
            Firmare qui con il mouse o tocco
          </div>
        </div>
      </div>

      <div class="popup-actions">
        <button class="popup-btn btn-cancel" onclick="closeAttendancePopup()">Annulla</button>
        <button class="popup-btn btn-clear" onclick="clearSignature()">Cancella Firma</button>
        <button class="popup-btn btn-save" id="saveAttendanceBtn" onclick="saveAttendance()" disabled="">Salva Presenza</button>
      </div>
    </div>
  </div>

  
  <div class="modal-overlay" id="appModalOverlay" style="display: none;">
    <div class="app-modal">
      <div class="modal-header">
        <h3 id="modalTitle">‚ûï Aggiungi Nuova Applicazione</h3>
        <button class="close-btn" onclick="closeAppModal()">‚úï</button>
      </div>

      <form id="appForm" onsubmit="saveApp(event)">
        <div class="form-row">
          <div class="form-group">
            <label for="appKey">üîë Chiave App (unica)*</label>
            <input type="text" id="appKey" required="" placeholder="es: nuova-app-gestione">
            <small>Solo lettere minuscole, numeri e trattini</small>
          </div>
          <div class="form-group">
            <label for="appIcon">üé® Icona (1 lettera)*</label>
            <input type="text" id="appIcon" required="" maxlength="1" placeholder="N">
          </div>
        </div>

        <div class="form-group">
          <label for="appTitle">üì± Nome Applicazione*</label>
          <input type="text" id="appTitle" required="" placeholder="es: Gestione Nuova Funzione">
        </div>

        <div class="form-group">
          <label for="appUrl">üåê URL Applicazione*</label>
          <input type="url" id="appUrl" required="" placeholder="https://www.lapa.ch/nuova-app">
          <small>URL completo dell'applicazione</small>
        </div>

        <div class="form-group">
          <label for="appDescription">üìù Descrizione</label>
          <textarea id="appDescription" rows="3" placeholder="Breve descrizione delle funzionalit√† dell'app"></textarea>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="appCategory">üè∑Ô∏è Categoria</label>
            <select id="appCategory">
              <option value="Gestione">Gestione</option>
              <option value="Magazzino">Magazzino</option>
              <option value="Logistica">Logistica</option>
              <option value="Amministrazione">Amministrazione</option>
              <option value="Inventario">Inventario</option>
              <option value="Altro">Altro</option>
            </select>
          </div>
          <div class="form-group">
            <label for="appVersion">üî¢ Versione</label>
            <input type="text" id="appVersion" placeholder="v1.0" value="v1.0">
          </div>
        </div>

        <div class="form-group">
          <label for="appRoles">üë• Ruoli Accesso</label>
          <input type="text" id="appRoles" placeholder="admin,warehouse,delivery" value="admin">
          <small>Separati da virgola</small>
        </div>

        <div class="form-group">
          <label for="appStatus">üìä Stato</label>
          <select id="appStatus">
            <option value="active">üü¢ Attivo</option>
            <option value="maintenance">üü° Manutenzione</option>
            <option value="restricted">üî¥ Limitato</option>
          </select>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeAppModal()">Annulla</button>
          <button type="submit" class="btn btn-success" id="saveAppBtn">üíæ Salva App</button>
          <button type="button" class="btn btn-danger" id="deleteAppBtn" onclick="deleteApp()" style="display: none;">üóëÔ∏è Elimina</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Real LAPA Apps URLs
    const APP_URLS = {
      'zone-picking': 'https://www.lapa.ch/prelievo-per-zone',
      'delivery-manager': 'https://www.lapa.ch/lapa-delivery',
      'warehouse-ops': 'https://www.lapa.ch/operazioni-di-magazzino',
      'super-admin': 'https://www.lapa.ch/super-utente-magazzino',
      'smart-routes': 'https://www.lapa.ch/smart-route-ai',
      'inventory-control': 'https://www.lapa.ch/app-per-inventario',
      'residue-picker': 'https://www.lapa.ch/pick-residui',
      'direct-control': 'https://www.lapa.ch/controllo-diretto',
      'control-map': 'https://www.lapa.ch/mappa-controllo-lapa',
      'clientivision': 'https://www.lapa.ch/clientivision',
      'sales-catalog': 'https://www.lapa.ch/catalogo-venditori-completo',
      'ai-callcenter': 'https://www.lapa.ch/centralino-ai-lapa-agenti',
      'delivery-control': 'https://www.lapa.ch/controllo-consegne-per-venditore',
      'sales-dashboard': 'https://www.lapa.ch/lapa-dashboard-venditori',
      'smart-orders': 'https://www.lapa.ch/sistema-di-ordini-intelligente-lapa',
      'van-returns': 'https://www.lapa.ch/sistemare-ritorni-dal-furgone'
    };

    const state = {
      userId: null,
      employeeId: null,
      employeeName: null,
      isConnected: false,
      isAdmin: false,
      employees: [],
      appPermissions: {},
      dynamicApps: {}, // New: stores custom apps
      editingAppKey: null, // For editing mode
      signature: {
        canvas: null,
        ctx: null,
        isDrawing: false,
        hasSigned: false
      }
    };

    const ADMIN_USER_ID = 7;

    // Initialize
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('üöÄ DEBUG: Inizializzazione LAPA Gestione...');
      
      loadTheme();
      
      try {
        await getSession();
        console.log('üöÄ DEBUG: Sessione ottenuta, user:', state.userId, 'admin:', state.isAdmin);
        
        await initializePermissionsTable(); // Create table if not exists
        console.log('üöÄ DEBUG: Tabella permessi inizializzata');
        
        if (state.isAdmin) {
          console.log('üöÄ DEBUG: Caricamento dati admin...');
          await loadEmployees();
          console.log('üöÄ DEBUG: Dipendenti caricati:', state.employees.length);
          await loadPermissions();
          console.log('üöÄ DEBUG: Permessi caricati');
          await loadDynamicApps();
          console.log('üöÄ DEBUG: App dinamiche caricate');
          showAdminPanel();
          console.log('üöÄ DEBUG: Panel admin mostrato');
        } else {
          console.log('üöÄ DEBUG: Utente normale, carico solo i miei permessi...');
          await loadPermissions();
          await loadDynamicApps();
          console.log('üöÄ DEBUG: Miei permessi e app caricate');
        }
        
        setupAppCards();
        console.log('üöÄ DEBUG: App cards configurate');

        filterAppsByPermissions();
        console.log('üöÄ DEBUG: Filtro applicato');

        // ‚≠ê Filtro aggiuntivo per app dinamiche dopo caricamento completo
        setTimeout(() => {
          console.log('üîç DEBUG: FILTRO FINALE per assicurare app dinamiche');
          filterAppsByPermissions();
        }, 200);
        
        console.log('‚úÖ DEBUG: Sistema pronto - stato finale:', state);
        
        // Debug periodico ogni 3 secondi + observer per detectare quando le app spariscono
        setInterval(() => {
          const visibleApps = document.querySelectorAll('.app-card:not(.hidden)');
          const hiddenApps = document.querySelectorAll('.app-card.hidden');
          
          console.log('üîÑ DEBUG: Stato periodico:', {
            userId: state.userId,
            isAdmin: state.isAdmin,
            appPermissions: state.appPermissions,
            visibleApps: visibleApps.length,
            hiddenApps: hiddenApps.length,
            totalApps: document.querySelectorAll('.app-card').length
          });
          
          // Log delle app nascoste
          if (hiddenApps.length > 0) {
            console.log('‚ùå DEBUG: App nascoste:', Array.from(hiddenApps).map(app => {
              const appKey = getAppKeyFromElement(app);
              return {
                app: appKey,
                hasPermission: isAppAllowed(appKey, state.userId),
                permissions: state.appPermissions[appKey]
              };
            }));
          }
        }, 3000);
        
        // Observer per detectare quando le app vengono nascoste
        const observer = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
            if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
              const element = mutation.target;
              if (element.classList.contains('app-card')) {
                const appKey = getAppKeyFromElement(element);
                if (element.classList.contains('hidden')) {
                  console.log('üëª DEBUG: App nascosta:', appKey, 'Timestamp:', new Date().toLocaleTimeString());
                } else {
                  console.log('üëÅÔ∏è DEBUG: App mostrata:', appKey, 'Timestamp:', new Date().toLocaleTimeString());
                }
              }
            }
          });
        });
        
        // Osserva tutte le app cards
        document.querySelectorAll('.app-card').forEach(card => {
          observer.observe(card, { attributes: true, attributeFilter: ['class'] });
        });
        
      } catch (error) {
        console.error('‚ùå DEBUG: Errore:', error);
        updateConnectionStatus();
        setupAppCards();
      }
    });

    // Theme functions - Fixed
    function toggleTheme() {
      console.log('üé® Switching theme...');
      const body = document.body;
      const icon = document.getElementById('themeIcon');
      
      const currentTheme = body.getAttribute('data-theme');
      console.log('Current theme:', currentTheme);
      
      if (currentTheme === 'light') {
        // Switch to dark
        body.setAttribute('data-theme', 'dark');
        icon.setAttribute('d', 'M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z');
        localStorage.setItem('theme', 'dark');
        console.log('‚úÖ Switched to dark theme');
      } else {
        // Switch to light
        body.setAttribute('data-theme', 'light');
        icon.setAttribute('d', 'M8 11a3 3 0 1 1 0-6 3 3 0 0 1 0 6zm0 1a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z');
        localStorage.setItem('theme', 'light');
        console.log('‚úÖ Switched to light theme');
      }
    }

    function loadTheme() {
      const savedTheme = localStorage.getItem('theme') || 'dark';
      const body = document.body;
      const icon = document.getElementById('themeIcon');
      
      console.log('Loading theme:', savedTheme);
      
      if (savedTheme === 'light') {
        body.setAttribute('data-theme', 'light');
        icon.setAttribute('d', 'M8 11a3 3 0 1 1 0-6 3 3 0 0 1 0 6zm0 1a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.+ 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z');
      } else {
        body.setAttribute('data-theme', 'dark');
        icon.setAttribute('d', 'M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z');
      }
    }

    // Rest of functions adapted for new UI...
    // (getSession, callOdoo, etc. remain the same)

    function updateConnectionStatus() {
      const statusDot = document.getElementById('statusDot');
      const statusText = document.getElementById('statusText');
      const userInfo = document.getElementById('userInfo');
      const userName = document.getElementById('userName');
      const userRole = document.getElementById('userRole');

      if (state.isConnected) {
        statusDot.classList.remove('disconnected');
        statusText.textContent = 'Sistema Connesso';
        userName.textContent = state.employeeName || 'Utente';
        userRole.textContent = state.isAdmin ? 'Amministratore' : 'Operatore';
        userInfo.style.display = 'flex';
        
        // Show attendance button for all connected users
        checkTodayAttendance();
      } else {
        statusDot.classList.add('disconnected');
        statusText.textContent = 'Sistema Disconnesso';
        userInfo.style.display = 'none';
        document.getElementById('attendanceBtn').style.display = 'none';
      }
    }

    // Get session info from Odoo
    async function getSession() {
      console.log('üìã Recupero sessione Odoo...');
      
      try {
        const response = await fetch('/web/session/get_session_info', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({
            jsonrpc: "2.0",
            method: "call",
            params: {},
            id: Math.floor(Math.random() * 1e9)
        })
      });
      
      const data = await response.json();
      if (data.result && data.result.uid) {
        state.userId = data.result.uid;
        state.isConnected = true;
        console.log('User ID:', state.userId);
        
        // Get employee info
        const employee = await callOdoo('hr.employee', 'search_read', [], {
          domain: [['user_id', '=', state.userId]],
          fields: ['id', 'name'],
          limit: 1
        });
        
        if (employee && employee.length > 0) {
          state.employeeId = employee[0].id;
          state.employeeName = employee[0].name;
          console.log('Employee:', employee[0].name, '(ID:', employee[0].id, ')');
        } else {
          state.employeeName = 'Utente Sistema';
          console.log('Nessun employee associato all\'utente');
        }
        
        // Check if user is admin
        state.isAdmin = (state.userId === ADMIN_USER_ID);
        console.log('Is Admin:', state.isAdmin);
        
        updateConnectionStatus();
        
      } else {
        throw new Error('Nessuna sessione Odoo attiva');
      }
      } catch (error) {
        console.error('‚ùå Errore nel recupero della sessione:', error);
        state.isConnected = false;
        state.employeeName = 'Non connesso';
        updateConnectionStatus();
        throw error;
      }
    }

    // Call Odoo RPC
    async function callOdoo(model, method, args, kwargs = {}) {
      try {
        if (!model || !method) {
          throw new Error('Model e method sono obbligatori');
        }
        
        args = args || [];
        if (!Array.isArray(args)) {
          args = [args];
        }

        const response = await fetch('/web/dataset/call_kw', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({
            jsonrpc: "2.0",
            method: "call",
            params: {
              model: model,
              method: method,
              args: args,
              kwargs: kwargs
            },
            id: Math.floor(Math.random() * 1e9)
          })
        });

        if (!response.ok) {
          throw new Error('Impossibile connettersi al server Odoo');
        }

        const data = await response.json();
        
        if (data.error) {
          const errorMsg = data.error.data ? 
            (data.error.data.message || data.error.data.name || 'Errore sconosciuto') : 
            (data.error.message || 'Errore sconosciuto');
          
          console.error(`Odoo RPC Error (${model}.${method}):`, errorMsg);
          throw new Error(errorMsg);
        }

        return data.result;
      } catch (error) {
        console.error(`Errore chiamata Odoo ${model}.${method}:`, error);
        throw error;
      }
    }

    function setupAppCards() {
      document.querySelectorAll('.app-card').forEach(card => {
        card.addEventListener('mouseenter', function() {
          this.style.transform = 'translateY(-4px)';
        });
        
        card.addEventListener('mouseleave', function() {
          this.style.transform = 'translateY(0)';
        });
      });
    }

    function filterAppsByPermissions() {
      console.log('üîç DEBUG: FILTRAGGIO CHIAMATO - Timestamp:', new Date().toLocaleTimeString());
      console.log('üîç DEBUG: Call stack:', new Error().stack);
      console.log('üîç DEBUG: State completo:', state);
      console.log('üîç DEBUG: App permissions:', state.appPermissions);
      console.log('üîç DEBUG: User ID:', state.userId);
      console.log('üîç DEBUG: Is Admin:', state.isAdmin);
      
      const allApps = document.querySelectorAll('.app-card');
      console.log('üîç DEBUG: Trovate', allApps.length, 'app card');
      
      allApps.forEach(app => {
        const appKey = getAppKeyFromElement(app);
        const isAllowed = state.isAdmin || isAppAllowed(appKey, state.userId);
        
        console.log('üîç DEBUG: App:', appKey, 'Allowed:', isAllowed);
        console.log('üîç DEBUG: Permissions per', appKey, ':', state.appPermissions[appKey]);
        
        if (isAllowed) {
          app.classList.remove('hidden');
          app.style.display = 'block';
          console.log('‚úÖ DEBUG: Mostro app', appKey);
        } else {
          app.classList.add('hidden');
          app.style.display = 'none';
          console.log('‚ùå DEBUG: Nascondo app', appKey);
        }
      });
      
      // Count visible apps
      const visibleApps = document.querySelectorAll('.app-card:not(.hidden)');
      console.log('üîç DEBUG: App visibili totali:', visibleApps.length);
    }

    function getAppKeyFromElement(element) {
      const onclick = element.getAttribute('onclick');
      const match = onclick.match(/openApp\('([^']+)'\)/);
      return match ? match[1] : null;
    }

    function isAppAllowed(appKey, userId) {
      return state.appPermissions[appKey]?.includes(userId) || false;
    }

    function showAdminPanel() {
      document.getElementById('adminPanel').style.display = 'block';
    }

    function toggleAdminPanel() {
      const panel = document.getElementById('permissionsPanel');
      const toggleText = document.getElementById('adminToggleText');
      
      if (panel.style.display === 'none' || !panel.style.display) {
        panel.style.display = 'block';
        toggleText.textContent = 'Nascondi Gestione';
        renderPermissionsPanel();
      } else {
        panel.style.display = 'none';
        toggleText.textContent = 'Configura Accessi';
      }
    }

    async function loadEmployees() {
      console.log('üìã Caricamento dipendenti...');
      try {
        const employees = await callOdoo('hr.employee', 'search_read', [], {
          fields: ['id', 'name', 'user_id'],
          domain: [['user_id', '!=', false]]
        });
        
        state.employees = employees;
        console.log(`Trovati ${employees.length} dipendenti`);
      } catch (error) {
        console.error('Errore caricamento dipendenti:', error);
        state.employees = [];
      }
    }

    // Initialize Permissions Table in Odoo
    async function initializePermissionsTable() {
      console.log('üîß Inizializzazione tabella permessi...');
      
      try {
        // Check if our custom model exists by trying to read from it
        await callOdoo('x_lapa_app_permissions', 'search', [[]], { limit: 1 });
        console.log('‚úÖ Tabella permessi gi√† esistente');
      } catch (error) {
        console.log('üìã Creazione tabella permessi...');
        
        try {
          // Create custom model for LAPA app permissions
          await callOdoo('ir.model', 'create', [{
            name: 'LAPA App Permissions',
            model: 'x_lapa_app_permissions',
            state: 'manual'
          }]);
          
          // Create fields for our model
          const modelId = await callOdoo('ir.model', 'search', [
            [['model', '=', 'x_lapa_app_permissions']]
          ]);
          
          if (modelId && modelId.length > 0) {
            // App Key field
            await callOdoo('ir.model.fields', 'create', [{
              model_id: modelId[0],
              name: 'x_app_key',
              field_description: 'App Key',
              ttype: 'char',
              required: true
            }]);
            
            // User ID field
            await callOdoo('ir.model.fields', 'create', [{
              model_id: modelId[0],
              name: 'x_user_id',
              field_description: 'User ID',
              ttype: 'integer',
              required: true
            }]);
            
            console.log('‚úÖ Tabella permessi creata con successo');
          }
        } catch (createError) {
          console.log('‚ö†Ô∏è Non posso creare tabella, uso metodo alternativo');
          // Fallback to using existing ir.config_parameter model
        }
      }
    }

    async function loadPermissions() {
      console.log('üìã DEBUG: Caricamento permessi con sistema nuovo...');
      console.log('üìã DEBUG: User ID corrente:', state.userId);
      console.log('üìã DEBUG: Admin User ID:', ADMIN_USER_ID);
      
      try {
        // Prima provo a caricare i permessi esistenti dall'admin
        if (state.isAdmin) {
          console.log('üìã DEBUG: Admin - provo ir.config_parameter...');
          const permissionParam = await callOdoo('ir.config_parameter', 'search_read', [
            [['key', '=', 'lapa.app.permissions']]
          ], {
            fields: ['value']
          });
          
          if (permissionParam && permissionParam.length > 0) {
            state.appPermissions = JSON.parse(permissionParam[0].value);
            console.log('üìã DEBUG: Admin caricato permessi:', state.appPermissions);
            
            // Auto-migrazione: salvo anche nel nuovo sistema per utenti normali
            console.log('üìã DEBUG: Admin - avvio migrazione automatica...');
            setTimeout(() => {
              savePermissions();
              console.log('üìã DEBUG: Admin - migrazione completata');
            }, 1000);
            
          } else {
            // Create default permissions
            state.appPermissions = {};
            Object.keys(APP_URLS).forEach(appKey => {
              state.appPermissions[appKey] = [ADMIN_USER_ID];
            });
            console.log('üìã DEBUG: Admin creato permessi default:', state.appPermissions);
            
            // Salvo i permessi default anche nel nuovo sistema
            setTimeout(() => {
              savePermissions();
              console.log('üìã DEBUG: Admin - salvati permessi default nel nuovo sistema');
            }, 1000);
          }
        } else {
          console.log('üìã DEBUG: Utente normale - provo a leggere permessi admin...');
          
          try {
            // Prima provo a leggere i permessi che l'admin ha configurato
            // Uso una chiamata che funziona per tutti gli utenti
            const adminPermissions = await loadPermissionsForUser();
            
            if (adminPermissions) {
              state.appPermissions = adminPermissions;
              console.log('üìã DEBUG: Utente normale - caricati permessi admin:', state.appPermissions);
            } else {
              // Se non trovo i permessi admin, carico da localStorage
              const saved = localStorage.getItem('lapaAppPermissions');
              if (saved) {
                state.appPermissions = JSON.parse(saved);
                console.log('üìã DEBUG: Utente normale - caricato da localStorage:', state.appPermissions);
              } else {
                // Default: solo admin ha accesso
                state.appPermissions = {};
                Object.keys(APP_URLS).forEach(appKey => {
                  state.appPermissions[appKey] = [ADMIN_USER_ID];
                });
                console.log('üìã DEBUG: Utente normale - solo admin ha accesso:', state.appPermissions);
              }
            }
          } catch (userError) {
            console.log('‚ö†Ô∏è DEBUG: Errore caricamento permessi utente:', userError);
            
            // Fallback sicuro - solo admin
            state.appPermissions = {};
            Object.keys(APP_URLS).forEach(appKey => {
              state.appPermissions[appKey] = [ADMIN_USER_ID];
            });
            console.log('üìã DEBUG: Fallback sicuro - solo admin:', state.appPermissions);
          }
        }
        
        // Ensure admin always has access
        Object.keys(APP_URLS).forEach(appKey => {
          if (!state.appPermissions[appKey]) {
            state.appPermissions[appKey] = [ADMIN_USER_ID];
          } else if (!state.appPermissions[appKey].includes(ADMIN_USER_ID)) {
            state.appPermissions[appKey].push(ADMIN_USER_ID);
          }
        });
        
        console.log('‚úÖ DEBUG: Permessi finali caricati:', state.appPermissions);
        
        // Test permissions for current user
        Object.keys(state.appPermissions).forEach(appKey => {
          const hasAccess = state.appPermissions[appKey].includes(state.userId);
          console.log('üìã DEBUG: User', state.userId, 'accesso a', appKey, ':', hasAccess);
        });
        
      } catch (error) {
        console.log('‚ùå DEBUG: Errore generale caricamento permessi:', error);
        
        // Ultimate fallback - give access to everything
        state.appPermissions = {};
        Object.keys(APP_URLS).forEach(appKey => {
          state.appPermissions[appKey] = [state.userId, ADMIN_USER_ID];
        });
        console.log('üö® DEBUG: FALLBACK FINALE - accesso completo a tutto:', state.appPermissions);
      }
    }

    async function loadPermissionsForUser() {
      console.log('üîë DEBUG: Tentativo caricamento permessi per utente normale...');
      
      try {
        // Provo a leggere i permessi tramite attachments (pi√π accessibili)
        const attachments = await callOdoo('ir.attachment', 'search_read', [
          [['name', '=', 'lapa_app_permissions.json'], ['public', '=', true]]
        ], {
          fields: ['datas', 'name'],
          limit: 1
        });
        
        if (attachments && attachments.length > 0) {
          try {
            // Decodifico il file base64
            const base64Data = attachments[0].datas;
            const jsonString = atob(base64Data);
            const permissions = JSON.parse(jsonString);
            console.log('üîë DEBUG: Permessi trovati in attachment pubblico:', permissions);
            return permissions;
          } catch (parseError) {
            console.log('‚ö†Ô∏è DEBUG: Errore parsing permessi da attachment:', parseError);
          }
        }
        
        console.log('üîë DEBUG: Nessun attachment permessi trovato');
        
        // Fallback: provo con le note employee
        try {
          const employee = await callOdoo('hr.employee', 'search_read', [
            [['user_id', '=', ADMIN_USER_ID]]
          ], {
            fields: ['name', 'notes'],
            limit: 1
          });
          
          if (employee && employee.length > 0 && employee[0].notes) {
            const notesText = employee[0].notes;
            if (notesText.includes('LAPA_PERMISSIONS:')) {
              const jsonStart = notesText.indexOf('LAPA_PERMISSIONS:') + 'LAPA_PERMISSIONS:'.length;
              const jsonEnd = notesText.indexOf(':END_LAPA_PERMISSIONS');
              if (jsonEnd > jsonStart) {
                const permissionsJson = notesText.substring(jsonStart, jsonEnd).trim();
                const permissions = JSON.parse(permissionsJson);
                console.log('üîë DEBUG: Permessi trovati nelle note employee (fallback):', permissions);
                return permissions;
              }
            }
          }
        } catch (employeeError) {
          console.log('‚ö†Ô∏è DEBUG: Errore anche con employee fallback:', employeeError);
        }
        
        return null;
        
      } catch (error) {
        console.log('‚ùå DEBUG: Errore completo loadPermissionsForUser:', error);
        return null;
      }
    }

    async function savePermissions() {
      console.log('üíæ DEBUG: Salvataggio permessi con sistema doppio...');
      
      try {
        const permissionsJson = JSON.stringify(state.appPermissions);
        console.log('üíæ DEBUG: Salvando:', permissionsJson);
        
        // 1. Salvo in ir.config_parameter (come prima)
        const existing = await callOdoo('ir.config_parameter', 'search', [
          [['key', '=', 'lapa.app.permissions']]
        ]);
        
        if (existing && existing.length > 0) {
          await callOdoo('ir.config_parameter', 'write', [existing, {
            value: permissionsJson
          }]);
          console.log('üíæ DEBUG: Parameter aggiornato');
        } else {
          await callOdoo('ir.config_parameter', 'create', [{
            key: 'lapa.app.permissions',
            value: permissionsJson
          }]);
          console.log('üíæ DEBUG: Parameter creato');
        }
        
        // 2. Salvo anche come attachment pubblico (pi√π accessibile)
        try {
          // Prima cancello l'attachment esistente se esiste
          const existingAttachments = await callOdoo('ir.attachment', 'search', [
            [['name', '=', 'lapa_app_permissions.json']]
          ]);
          
          if (existingAttachments && existingAttachments.length > 0) {
            await callOdoo('ir.attachment', 'unlink', [existingAttachments]);
            console.log('üíæ DEBUG: Attachment esistente rimosso');
          }
          
          // Creo nuovo attachment pubblico
          const base64Data = btoa(permissionsJson);
          const newAttachment = await callOdoo('ir.attachment', 'create', [{
            name: 'lapa_app_permissions.json',
            datas: base64Data,
            mimetype: 'application/json',
            public: true,
            description: 'LAPA App Permissions - Do not delete'
          }]);
          
          console.log('üíæ DEBUG: Nuovo attachment pubblico creato:', newAttachment);
          
        } catch (attachmentError) {
          console.log('‚ö†Ô∏è DEBUG: Errore salvataggio attachment:', attachmentError);
          
          // Fallback: salvo nelle note employee
          try {
            const adminEmployee = await callOdoo('hr.employee', 'search', [
              [['user_id', '=', ADMIN_USER_ID]]
            ]);
            
            if (adminEmployee && adminEmployee.length > 0) {
              const currentEmployee = await callOdoo('hr.employee', 'read', [adminEmployee[0]], {
                fields: ['notes']
              });
              
              let notes = currentEmployee[0].notes || '';
              
              if (notes.includes('LAPA_PERMISSIONS:')) {
                const start = notes.indexOf('LAPA_PERMISSIONS:');
                const end = notes.indexOf(':END_LAPA_PERMISSIONS') + ':END_LAPA_PERMISSIONS'.length;
                notes = notes.substring(0, start) + notes.substring(end);
              }
              
              notes += `\n\nLAPA_PERMISSIONS:${permissionsJson}:END_LAPA_PERMISSIONS`;
              
              await callOdoo('hr.employee', 'write', [adminEmployee[0], {
                notes: notes
              }]);
              
              console.log('üíæ DEBUG: Fallback - salvato nelle note admin');
            }
          } catch (notesError) {
            console.log('‚ö†Ô∏è DEBUG: Errore anche nel fallback note:', notesError);
          }
        }
        
        console.log('‚úÖ DEBUG: Permessi salvati in entrambi i sistemi');
        
      } catch (error) {
        console.log('‚ö†Ô∏è DEBUG: Errore salvataggio generale:', error);
        // Fallback to localStorage
        localStorage.setItem('lapaAppPermissions', JSON.stringify(state.appPermissions));
      }
    }

    function renderPermissionsPanel() {
      const grid = document.getElementById('permissionsGrid');
      grid.innerHTML = '';

      // Combina app di sistema e app dinamiche
      const allApps = {...APP_URLS, ...state.dynamicApps};

      Object.keys(allApps).forEach(appKey => {
        const appDiv = document.createElement('div');
        appDiv.className = 'app-permission';

        const isDynamic = state.dynamicApps[appKey] !== undefined;
        const appName = isDynamic ? state.dynamicApps[appKey].title : getAppName(appKey);
        const appType = isDynamic ? 'üîß App Personalizzata' : 'üè† App di Sistema';

        appDiv.innerHTML = `
          <h4>${appName}</h4>
          <small style="color: var(--text-secondary); margin-bottom: 10px; display: block;">${appType}</small>
          <div class="employees-list">
            ${state.employees.map(emp => `
              <div class="employee-chip ${isAppAllowed(appKey, emp.user_id[0]) ? 'selected' : ''}"
                   onclick="toggleEmployeePermission('${appKey}', ${emp.user_id[0]}, this)">
                ${emp.name}
              </div>
            `).join('')}
          </div>
        `;

        grid.appendChild(appDiv);
      });
    }

    function getAppName(appKey) {
      const names = {
        'zone-picking': 'üì¶ Zone Picking Pro',
        'delivery-manager': 'üöö Delivery Manager',
        'warehouse-ops': 'üè≠ Warehouse Operations',
        'super-admin': 'üëë Super Admin Hub',
        'smart-routes': 'üß† Smart Routes AI',
        'inventory-control': 'üìä Inventory Control',
        'residue-picker': 'üîÑ Residue Picker',
        'direct-control': '‚ö° Direct Control',
        'control-map': 'üó∫Ô∏è Control Map',
        'clientivision': 'üìà ClientiVision Analytics',
        'sales-catalog': 'üõçÔ∏è Sales Catalog Pro',
        'ai-callcenter': 'ü§ñ AI Call Center Pro',
        'delivery-control': 'üöõ Delivery Control Pro',
        'sales-dashboard': 'üìä Sales Dashboard Pro',
        'smart-orders': 'üß† Smart Orders AI',
        'van-returns': 'üîÑ Van Returns Pro'
      };
      return names[appKey] || appKey;
    }

    function toggleEmployeePermission(appKey, userId, element) {
      console.log('üéõÔ∏è DEBUG: Toggle permesso per:', appKey, 'utente:', userId);
      
      if (!state.appPermissions[appKey]) {
        state.appPermissions[appKey] = [];
      }

      const index = state.appPermissions[appKey].indexOf(userId);
      if (index > -1) {
        state.appPermissions[appKey].splice(index, 1);
        element.classList.remove('selected');
        console.log('üéõÔ∏è DEBUG: Rimosso accesso per:', userId, 'da:', appKey);
      } else {
        state.appPermissions[appKey].push(userId);
        element.classList.add('selected');
        console.log('üéõÔ∏è DEBUG: Aggiunto accesso per:', userId, 'a:', appKey);
      }

      console.log('üéõÔ∏è DEBUG: Permessi aggiornati:', state.appPermissions);
      savePermissions();
      
      // Ritarda il filtro di 500ms per permettere il salvataggio
      setTimeout(() => {
        console.log('üéõÔ∏è DEBUG: Applicando filtro dopo toggle...');
        filterAppsByPermissions();
      }, 500);
    }


    // Interactive Logo Animation
    function playLogoAnimation() {
      console.log('üéØ Logo clicked - playing animation...');
      const logo = document.querySelector('.brand-logo');
      const lapaLogo = document.querySelector('.lapa-logo');
      
      // Add pulsing animation
      logo.style.animation = 'logoClick 0.6s ease-out';
      lapaLogo.style.animation = 'logoSpin 1s ease-out';
      
      // Play magic sound
      playMagicSound();
      
      // Reset animations
      setTimeout(() => {
        logo.style.animation = '';
        lapaLogo.style.animation = '';
      }, 1000);
    }

    function playMagicSound() {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.setValueAtTime(600, audioContext.currentTime);
        oscillator.frequency.exponentialRampToValueAtTime(800, audioContext.currentTime + 0.2);
        
        gainNode.gain.setValueAtTime(0.05, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.4);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.4);
      } catch (error) {
        console.log('Audio not available');
      }
    }

    // === ATTENDANCE SYSTEM ===

    async function checkTodayAttendance() {
      console.log('üïê DEBUG: Controllo presenza di oggi...');
      
      const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
      const attendanceBtn = document.getElementById('attendanceBtn');
      
      try {
        // Check if user already signed today
        const hasAttended = await checkAttendanceExists(today);
        
        if (hasAttended) {
          attendanceBtn.textContent = '‚úÖ Presenza gi√† segnata';
          attendanceBtn.classList.add('completed');
          attendanceBtn.disabled = true;
        } else {
          attendanceBtn.textContent = 'üìù Segna Presenza';
          attendanceBtn.classList.remove('completed');
          attendanceBtn.disabled = false;
        }
        
        attendanceBtn.style.display = 'flex';
        console.log('üïê DEBUG: Pulsante presenza configurato');
        
      } catch (error) {
        console.log('‚ö†Ô∏è DEBUG: Errore controllo presenza:', error);
        attendanceBtn.style.display = 'flex'; // Show anyway
      }
    }

    async function checkAttendanceExists(date) {
      // For now, check localStorage - will implement Odoo later
      const attendanceKey = `attendance_${state.employeeId}_${date}`;
      return localStorage.getItem(attendanceKey) !== null;
    }

    function openAttendancePopup() {
      console.log('üïê DEBUG: Apertura popup presenza...');
      
      const overlay = document.getElementById('attendanceOverlay');
      const dateElement = document.getElementById('popupDate');
      
      // Set today's date
      const today = new Date();
      const options = { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      };
      dateElement.textContent = today.toLocaleDateString('it-IT', options);
      
      // Initialize signature canvas
      initializeSignatureCanvas();
      
      overlay.style.display = 'block';
      
      // Add click outside to close
      overlay.addEventListener('click', function(e) {
        if (e.target === overlay) {
          closeAttendancePopup();
        }
      });
    }

    function closeAttendancePopup() {
      const overlay = document.getElementById('attendanceOverlay');
      overlay.style.display = 'none';
      clearSignature();
    }

    function initializeSignatureCanvas() {
      console.log('üñäÔ∏è DEBUG: Inizializzazione canvas firma...');
      
      const canvas = document.getElementById('signatureCanvas');
      const ctx = canvas.getContext('2d');
      const placeholder = document.getElementById('signaturePlaceholder');
      
      // IMPORTANTE: Set canvas size properly
      const container = canvas.parentElement;
      const rect = container.getBoundingClientRect();
      
      // Set actual canvas size
      canvas.width = rect.width - 4; // Account for border
      canvas.height = 196; // Fixed height minus border
      
      console.log('üñäÔ∏è DEBUG: Canvas size:', canvas.width, 'x', canvas.height);
      
      // Configure drawing style
      ctx.strokeStyle = '#2563eb';
      ctx.lineWidth = 3;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      
      // Clear canvas
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      state.signature.canvas = canvas;
      state.signature.ctx = ctx;
      state.signature.hasSigned = false;
      
      // Remove previous event listeners
      const newCanvas = canvas.cloneNode(true);
      canvas.parentNode.replaceChild(newCanvas, canvas);
      
      // Re-get references after cloning
      const freshCanvas = document.getElementById('signatureCanvas');
      const freshCtx = freshCanvas.getContext('2d');
      
      // Re-configure
      freshCtx.strokeStyle = '#2563eb';
      freshCtx.lineWidth = 3;
      freshCtx.lineCap = 'round';
      freshCtx.lineJoin = 'round';
      
      state.signature.canvas = freshCanvas;
      state.signature.ctx = freshCtx;
      
      console.log('üñäÔ∏è DEBUG: Adding event listeners...');
      
      // Mouse events
      freshCanvas.addEventListener('mousedown', startDrawing);
      freshCanvas.addEventListener('mousemove', draw);
      freshCanvas.addEventListener('mouseup', stopDrawing);
      freshCanvas.addEventListener('mouseleave', stopDrawing);
      
      // Touch events
      freshCanvas.addEventListener('touchstart', handleTouch, { passive: false });
      freshCanvas.addEventListener('touchmove', handleTouch, { passive: false });
      freshCanvas.addEventListener('touchend', stopDrawing);
      
      function startDrawing(e) {
        console.log('üñäÔ∏è DEBUG: Start drawing...');
        e.preventDefault();
        state.signature.isDrawing = true;
        
        const pos = getMousePos(freshCanvas, e);
        freshCtx.beginPath();
        freshCtx.moveTo(pos.x, pos.y);
        
        placeholder.style.display = 'none';
      }
      
      function draw(e) {
        if (!state.signature.isDrawing) return;
        
        e.preventDefault();
        const pos = getMousePos(freshCanvas, e);
        
        freshCtx.lineTo(pos.x, pos.y);
        freshCtx.stroke();
        
        if (!state.signature.hasSigned) {
          state.signature.hasSigned = true;
          document.getElementById('saveAttendanceBtn').disabled = false;
          console.log('üñäÔ∏è DEBUG: First signature detected - save button enabled');
        }
      }
      
      function stopDrawing(e) {
        if (state.signature.isDrawing) {
          console.log('üñäÔ∏è DEBUG: Stop drawing...');
          state.signature.isDrawing = false;
          freshCtx.beginPath();
        }
      }
      
      function handleTouch(e) {
        e.preventDefault();
        const touch = e.touches[0];
        const rect = freshCanvas.getBoundingClientRect();
        
        const mouseEvent = new MouseEvent(
          e.type === 'touchstart' ? 'mousedown' : 
          e.type === 'touchmove' ? 'mousemove' : 'mouseup', 
          {
            clientX: touch.clientX,
            clientY: touch.clientY,
            bubbles: true
          }
        );
        
        freshCanvas.dispatchEvent(mouseEvent);
      }
      
      function getMousePos(canvas, e) {
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX - rect.left) * (canvas.width / rect.width);
        const y = (e.clientY - rect.top) * (canvas.height / rect.height);
        
        return { x, y };
      }
      
      console.log('üñäÔ∏è DEBUG: Canvas inizializzato correttamente');
    }

    function clearSignature() {
      console.log('üßπ DEBUG: Cancellazione firma...');
      
      if (state.signature.ctx && state.signature.canvas) {
        state.signature.ctx.clearRect(0, 0, state.signature.canvas.width, state.signature.canvas.height);
        state.signature.hasSigned = false;
        
        const placeholder = document.getElementById('signaturePlaceholder');
        if (placeholder) {
          placeholder.style.display = 'block';
        }
        
        const saveBtn = document.getElementById('saveAttendanceBtn');
        if (saveBtn) {
          saveBtn.disabled = true;
        }
        
        console.log('üßπ DEBUG: Firma cancellata');
      }
    }

    async function saveAttendance() {
      console.log('üíæ DEBUG: Salvataggio presenza...');
      
      if (!state.signature.hasSigned) {
        alert('Per favore, inserisci la firma prima di salvare.');
        return;
      }
      
      const today = new Date().toISOString().split('T')[0];
      const workHours = document.getElementById('workHours').value;
      const signatureData = state.signature.canvas.toDataURL();
      
      const attendanceData = {
        employeeId: state.employeeId,
        employeeName: state.employeeName,
        date: today,
        workHours: workHours,
        signature: signatureData,
        timestamp: new Date().toISOString()
      };
      
      try {
        // Save to Odoo project system
        await saveAttendanceToOdoo(attendanceData);
        
        // Also save locally as backup
        const attendanceKey = `attendance_${state.employeeId}_${today}`;
        localStorage.setItem(attendanceKey, JSON.stringify(attendanceData));
        
        alert('Presenza segnata con successo!');
        closeAttendancePopup();
        checkTodayAttendance(); // Refresh button state
        
      } catch (error) {
        console.log('‚ö†Ô∏è DEBUG: Errore salvataggio presenza:', error);
        
        // Fallback to localStorage only
        const attendanceKey = `attendance_${state.employeeId}_${today}`;
        localStorage.setItem(attendanceKey, JSON.stringify(attendanceData));
        
        alert('Presenza segnata localmente. Sar√† sincronizzata quando possibile.');
        closeAttendancePopup();
        checkTodayAttendance();
      }
    }

    async function saveAttendanceToOdoo(attendanceData) {
      console.log('üíæ DEBUG: Salvataggio presenza in progetto Odoo...');
      
      const currentYear = new Date().getFullYear();
      const currentMonth = new Date().getMonth() + 1; // 1-12
      const monthName = new Date().toLocaleDateString('it-IT', { month: 'long' });
      
      try {
        // 1. Find or create main project "LAPA Presenze"
        let projectId = await findOrCreateProject('LAPA Presenze', 'Gestione presenze dipendenti LAPA');
        
        // 2. Find or create employee stage
        let stageId = await findOrCreateStage(projectId, state.employeeName, `Presenze di ${state.employeeName}`);
        
        // 3. Find or create monthly task - SPECIFIC FOR EACH EMPLOYEE
        const monthlyTaskName = `${state.employeeName} - ${monthName} ${currentYear}`;
        let taskId = await findOrCreateTask(projectId, stageId, monthlyTaskName, `Presenze ${monthName} ${currentYear} per ${state.employeeName}`);
        
        // 4. Add attendance to task notes
        await addAttendanceToTask(taskId, attendanceData);
        
        console.log('‚úÖ DEBUG: Presenza salvata in progetto Odoo');
        
      } catch (error) {
        console.log('‚ùå DEBUG: Errore salvataggio progetto Odoo:', error);
        throw error;
      }
    }

    async function findOrCreateProject(name, description) {
      // Search for existing project
      const existing = await callOdoo('project.project', 'search', [
        [['name', '=', name]]
      ]);
      
      if (existing && existing.length > 0) {
        console.log('üìã DEBUG: Progetto esistente trovato:', existing[0]);
        return existing[0];
      }
      
      // Create new project
      const newProject = await callOdoo('project.project', 'create', [{
        name: name,
        description: description,
        active: true
      }]);
      
      console.log('üìã DEBUG: Nuovo progetto creato:', newProject);
      return newProject;
    }

    async function findOrCreateStage(projectId, stageName, description) {
      // Search for existing stage
      const existing = await callOdoo('project.task.type', 'search', [
        [['name', '=', stageName], ['project_ids', 'in', [projectId]]]
      ]);
      
      if (existing && existing.length > 0) {
        console.log('üìã DEBUG: Stage esistente trovato:', existing[0]);
        return existing[0];
      }
      
      // Create new stage
      const newStage = await callOdoo('project.task.type', 'create', [{
        name: stageName,
        description: description,
        project_ids: [[6, 0, [projectId]]]
      }]);
      
      console.log('üìã DEBUG: Nuovo stage creato:', newStage);
      return newStage;
    }

    async function findOrCreateTask(projectId, stageId, taskName, description) {
      // Search for existing task
      const existing = await callOdoo('project.task', 'search', [
        [['name', '=', taskName], ['project_id', '=', projectId]]
      ]);
      
      if (existing && existing.length > 0) {
        console.log('üìã DEBUG: Task esistente trovato:', existing[0]);
        return existing[0];
      }
      
      // Create new task
      const newTask = await callOdoo('project.task', 'create', [{
        name: taskName,
        description: description,
        project_id: projectId,
        stage_id: stageId,
        user_ids: [[6, 0, [state.userId]]]
      }]);
      
      console.log('üìã DEBUG: Nuovo task creato:', newTask);
      return newTask;
    }

    async function addAttendanceToTask(taskId, attendanceData) {
      // Get current task to append to existing notes
      const task = await callOdoo('project.task', 'read', [taskId], {
        fields: ['description']
      });
      
      const currentNotes = task[0].description || '';
      
      // Create HTML entry for attendance
      const attendanceHtml = `
        <div style="border: 1px solid #ddd; padding: 10px; margin: 5px 0; border-radius: 5px;">
          <h4>üìÖ ${attendanceData.date}</h4>
          <p><strong>Dipendente:</strong> ${attendanceData.employeeName}</p>
          <p><strong>Ore lavoro:</strong> ${attendanceData.workHours}</p>
          <p><strong>Timestamp:</strong> ${new Date(attendanceData.timestamp).toLocaleString('it-IT')}</p>
          <div style="margin-top: 10px;">
            <strong>Firma:</strong><br>
            <img src="${attendanceData.signature}" style="border: 1px solid #ccc; max-width: 300px;">
          </div>
        </div>
      `;
      
      const updatedNotes = currentNotes + attendanceHtml;
      
      // Update task with new attendance
      await callOdoo('project.task', 'write', [taskId, {
        description: updatedNotes
      }]);
      
      console.log('‚úÖ DEBUG: Presenza aggiunta al task');
    }

    // === DYNAMIC APP MANAGEMENT SYSTEM ===

    async function loadDynamicApps() {
      console.log('üöÄ DEBUG: Caricamento app dinamiche...');

      try {
        // Try to load from Odoo config parameter
        const appConfigParam = await callOdoo('ir.config_parameter', 'search_read', [
          [['key', '=', 'lapa.dynamic.apps']]
        ], {
          fields: ['value']
        });

        if (appConfigParam && appConfigParam.length > 0) {
          state.dynamicApps = JSON.parse(appConfigParam[0].value);
          console.log('üöÄ DEBUG: App dinamiche caricate da Odoo:', state.dynamicApps);
        } else {
          // No dynamic apps yet
          state.dynamicApps = {};
          console.log('üöÄ DEBUG: Nessuna app dinamica trovata');
        }

        // Render dynamic apps in the grid
        renderDynamicApps();

      } catch (error) {
        console.log('‚ö†Ô∏è DEBUG: Errore caricamento app dinamiche:', error);
        // Fallback to localStorage
        const saved = localStorage.getItem('lapaDynamicApps');
        if (saved) {
          state.dynamicApps = JSON.parse(saved);
        } else {
          state.dynamicApps = {};
        }
      }
    }

    async function saveDynamicApps() {
      console.log('üíæ DEBUG: Salvataggio app dinamiche...');

      try {
        const appsJson = JSON.stringify(state.dynamicApps);

        // Save to Odoo
        const existing = await callOdoo('ir.config_parameter', 'search', [
          [['key', '=', 'lapa.dynamic.apps']]
        ]);

        if (existing && existing.length > 0) {
          await callOdoo('ir.config_parameter', 'write', [existing, {
            value: appsJson
          }]);
        } else {
          await callOdoo('ir.config_parameter', 'create', [{
            key: 'lapa.dynamic.apps',
            value: appsJson
          }]);
        }

        console.log('üíæ DEBUG: App dinamiche salvate in Odoo');

      } catch (error) {
        console.log('‚ö†Ô∏è DEBUG: Errore salvataggio Odoo, uso localStorage:', error);
        // Fallback to localStorage
        localStorage.setItem('lapaDynamicApps', JSON.stringify(state.dynamicApps));
      }
    }

    function renderDynamicApps() {
      console.log('üé® DEBUG: Rendering app dinamiche nel grid principale...');

      const appsGrid = document.getElementById('appsGrid');

      // Remove existing dynamic apps first
      const existingDynamic = appsGrid.querySelectorAll('[data-dynamic="true"]');
      existingDynamic.forEach(app => app.remove());

      // Add dynamic apps
      Object.keys(state.dynamicApps).forEach(appKey => {
        const app = state.dynamicApps[appKey];
        const appCard = createDynamicAppCard(appKey, app);
        appsGrid.appendChild(appCard);
      });

      // Re-setup all cards and apply permissions
      setupAppCards();

      // ‚≠ê IMPORTANTE: Applica filtri dopo che il DOM √® aggiornato
      setTimeout(() => {
        console.log('üîç DEBUG: Filtro permessi RITARDATO per app dinamiche');
        filterAppsByPermissions();
      }, 50);
    }

    function createDynamicAppCard(appKey, app) {
      const statusClass = app.status === 'active' ? 'status-active' :
                          app.status === 'maintenance' ? 'status-maintenance' : 'status-restricted';

      const statusText = app.status === 'active' ? 'Attivo' :
                         app.status === 'maintenance' ? 'Manutenzione' : 'Limitato';

      const appCard = document.createElement('div');
      appCard.className = 'app-card';
      appCard.setAttribute('data-dynamic', 'true');
      appCard.setAttribute('data-roles', app.roles || 'admin');
      appCard.setAttribute('onclick', `openApp('${appKey}')`);

      appCard.innerHTML = `
        <div class="app-header">
          <div class="app-icon">${app.icon}</div>
          <div class="app-status ${statusClass}">${statusText}</div>
        </div>
        <div class="app-title">${app.title}</div>
        <div class="app-description">${app.description || 'Applicazione personalizzata'}</div>
        <div class="app-meta">
          <span>${app.category || 'Personalizzata'}</span>
          <span>${app.version || 'v1.0'}</span>
        </div>
      `;

      return appCard;
    }

    function toggleAppManager() {
      const panel = document.getElementById('appManagerPanel');
      const toggleText = document.getElementById('appManagerText');

      if (panel.style.display === 'none' || !panel.style.display) {
        panel.style.display = 'block';
        toggleText.textContent = 'Nascondi Gestione App';
        renderAppManagementList();
      } else {
        panel.style.display = 'none';
        toggleText.textContent = 'Gestisci App';
      }
    }

    function renderAppManagementList() {
      const grid = document.getElementById('appsManagementGrid');
      grid.innerHTML = '';

      // Show both static and dynamic apps
      const allApps = {...APP_URLS, ...state.dynamicApps};

      Object.keys(allApps).forEach(appKey => {
        const isDynamic = state.dynamicApps[appKey] !== undefined;
        const app = isDynamic ? state.dynamicApps[appKey] : {
          title: getAppName(appKey),
          url: APP_URLS[appKey],
          category: 'Sistema',
          version: 'Sistema',
          status: 'active'
        };

        const card = document.createElement('div');
        card.className = 'app-management-card';

        card.innerHTML = `
          <h5>${isDynamic ? 'üîß' : 'üè†'} ${app.title || getAppName(appKey)}</h5>
          <div class="app-url">${app.url || APP_URLS[appKey]}</div>
          <div class="app-meta">
            <span>${app.category || 'Sistema'} ‚Ä¢ ${app.version || 'Sistema'}</span>
            <br><small>${isDynamic ? 'App Personalizzata' : 'App di Sistema'}</small>
          </div>
          <div class="app-management-actions">
            ${isDynamic ? `
              <button class="btn btn-small" onclick="editApp('${appKey}')">‚úèÔ∏è Modifica</button>
              <button class="btn btn-danger btn-small" onclick="confirmDeleteApp('${appKey}')">üóëÔ∏è Elimina</button>
            ` : `
              <button class="btn btn-secondary btn-small" disabled>Sistema</button>
            `}
          </div>
        `;

        grid.appendChild(card);
      });
    }

    function openAddAppModal() {
      const modal = document.getElementById('appModalOverlay');
      const form = document.getElementById('appForm');
      const title = document.getElementById('modalTitle');
      const deleteBtn = document.getElementById('deleteAppBtn');

      // Reset form for new app
      form.reset();
      state.editingAppKey = null;
      title.textContent = '‚ûï Aggiungi Nuova Applicazione';
      deleteBtn.style.display = 'none';

      // Set default values
      document.getElementById('appStatus').value = 'active';
      document.getElementById('appCategory').value = 'Gestione';
      document.getElementById('appVersion').value = 'v1.0';
      document.getElementById('appRoles').value = 'admin';

      modal.style.display = 'block';

      // Add click outside to close
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          closeAppModal();
        }
      });
    }

    function editApp(appKey) {
      const app = state.dynamicApps[appKey];
      if (!app) return;

      const modal = document.getElementById('appModalOverlay');
      const title = document.getElementById('modalTitle');
      const deleteBtn = document.getElementById('deleteAppBtn');

      // Populate form with existing data
      document.getElementById('appKey').value = appKey;
      document.getElementById('appKey').disabled = true; // Can't change key when editing
      document.getElementById('appIcon').value = app.icon;
      document.getElementById('appTitle').value = app.title;
      document.getElementById('appUrl').value = app.url;
      document.getElementById('appDescription').value = app.description || '';
      document.getElementById('appCategory').value = app.category || 'Gestione';
      document.getElementById('appVersion').value = app.version || 'v1.0';
      document.getElementById('appRoles').value = app.roles || 'admin';
      document.getElementById('appStatus').value = app.status || 'active';

      state.editingAppKey = appKey;
      title.textContent = '‚úèÔ∏è Modifica Applicazione';
      deleteBtn.style.display = 'inline-block';

      modal.style.display = 'block';
    }

    function closeAppModal() {
      const modal = document.getElementById('appModalOverlay');
      const form = document.getElementById('appForm');

      modal.style.display = 'none';
      form.reset();
      state.editingAppKey = null;

      // Re-enable appKey field
      document.getElementById('appKey').disabled = false;
    }

    async function saveApp(event) {
      event.preventDefault();

      const formData = new FormData(event.target);
      const appKey = document.getElementById('appKey').value.trim();
      const appIcon = document.getElementById('appIcon').value.trim();
      const appTitle = document.getElementById('appTitle').value.trim();
      const appUrl = document.getElementById('appUrl').value.trim();
      const appDescription = document.getElementById('appDescription').value.trim();
      const appCategory = document.getElementById('appCategory').value;
      const appVersion = document.getElementById('appVersion').value.trim();
      const appRoles = document.getElementById('appRoles').value.trim();
      const appStatus = document.getElementById('appStatus').value;

      // Validation
      if (!appKey || !appIcon || !appTitle || !appUrl) {
        alert('Per favore compila tutti i campi obbligatori');
        return;
      }

      // Validate appKey format
      const keyRegex = /^[a-z0-9-]+$/;
      if (!keyRegex.test(appKey)) {
        alert('La chiave app pu√≤ contenere solo lettere minuscole, numeri e trattini');
        return;
      }

      // Check if key already exists (only when adding new)
      if (!state.editingAppKey && (APP_URLS[appKey] || state.dynamicApps[appKey])) {
        alert('Questa chiave app √® gi√† in uso');
        return;
      }

      // Validate URL format
      try {
        new URL(appUrl);
      } catch {
        alert('URL non valido');
        return;
      }

      const appData = {
        title: appTitle,
        url: appUrl,
        icon: appIcon,
        description: appDescription,
        category: appCategory,
        version: appVersion,
        roles: appRoles,
        status: appStatus,
        created: state.editingAppKey ? state.dynamicApps[state.editingAppKey].created : new Date().toISOString(),
        updated: new Date().toISOString()
      };

      console.log('üíæ DEBUG: Salvataggio app:', appKey, appData);

      // Save to state
      state.dynamicApps[appKey] = appData;

      // Add to APP_URLS for immediate use
      APP_URLS[appKey] = appUrl;

      // Save to Odoo
      await saveDynamicApps();

      // Update permissions (give admin access by default)
      if (!state.appPermissions[appKey]) {
        state.appPermissions[appKey] = [ADMIN_USER_ID];
        await savePermissions();
      }

      // Re-render everything
      renderDynamicApps();
      renderAppManagementList();
      renderPermissionsPanel(); // ‚≠ê Aggiunto refresh pannello permessi

      closeAppModal();
      alert(`App "${appTitle}" ${state.editingAppKey ? 'aggiornata' : 'creata'} con successo!`);
    }

    function confirmDeleteApp(appKey) {
      const app = state.dynamicApps[appKey];
      if (!app) return;

      if (confirm(`Sei sicuro di voler eliminare l'app "${app.title}"?\n\nQuesta azione non pu√≤ essere annullata.`)) {
        deleteApp(appKey);
      }
    }

    async function deleteApp(appKey = null) {
      const keyToDelete = appKey || state.editingAppKey;
      if (!keyToDelete || !state.dynamicApps[keyToDelete]) return;

      const app = state.dynamicApps[keyToDelete];
      console.log('üóëÔ∏è DEBUG: Eliminazione app:', keyToDelete, app.title);

      // Remove from state
      delete state.dynamicApps[keyToDelete];
      delete APP_URLS[keyToDelete];

      // Remove permissions
      if (state.appPermissions[keyToDelete]) {
        delete state.appPermissions[keyToDelete];
        await savePermissions();
      }

      // Save to Odoo
      await saveDynamicApps();

      // Re-render everything
      renderDynamicApps();
      renderAppManagementList();
      renderPermissionsPanel(); // ‚≠ê Aggiunto refresh pannello permessi

      if (!appKey) {
        // Called from modal
        closeAppModal();
      }

      alert(`App "${app.title}" eliminata con successo!`);
    }

    // Update the openApp function to handle dynamic apps
    function openApp(appKey) {
      if (!state.isConnected) {
        alert('Sistema disconnesso da Odoo');
        return;
      }

      const hasPermission = state.isAdmin || isAppAllowed(appKey, state.userId);
      if (!hasPermission) {
        alert('Non hai i permessi per accedere a questa applicazione');
        return;
      }

      // Get URL from either static or dynamic apps
      const url = APP_URLS[appKey] || (state.dynamicApps[appKey] && state.dynamicApps[appKey].url);

      if (url) {
        const appUrl = new URL(url, window.location.href);
        appUrl.searchParams.set('userId', state.userId);
        appUrl.searchParams.set('employeeId', state.employeeId);
        appUrl.searchParams.set('employeeName', state.employeeName);
        appUrl.searchParams.set('isAdmin', state.isAdmin);

        fetch(url, { method: 'HEAD' })
          .then(response => {
            if (response.ok) {
              window.location.href = appUrl.toString();
            } else {
              alert(`Applicazione non trovata: ${getAppName(appKey)}`);
            }
          })
          .catch(() => {
            // Try to open anyway
            window.location.href = appUrl.toString();
          });
      } else {
        alert(`URL non configurato per: ${appKey}`);
      }
    }
  </script>