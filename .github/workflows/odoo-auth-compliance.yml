name: üîí ODOO Auth Compliance Check

on:
  pull_request:
    branches: [main, master]
  push:
    branches: [main, master]

jobs:
  compliance-check:
    name: Verifica Conformit√† ODOO_AUTH_SYSTEM.md
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v3

      - name: üîç Cerca credenziali hardcoded
        run: |
          echo "üîê Cercando credenziali hardcoded..."

          # Lista pattern pericolosi
          FOUND_ISSUES=0

          if grep -r "paul@lapa.ch" --include="*.ts" --include="*.tsx" .; then
            echo "‚ùå ERRORE: Trovata credenziale paul@lapa.ch"
            FOUND_ISSUES=1
          fi

          if grep -r "lapa201180" --include="*.ts" --include="*.tsx" .; then
            echo "‚ùå ERRORE: Trovata password lapa201180"
            FOUND_ISSUES=1
          fi

          if grep -r "FALLBACK_LOGIN\|FALLBACK_PASSWORD" --include="*.ts" .; then
            echo "‚ùå ERRORE: Trovato fallback di autenticazione"
            FOUND_ISSUES=1
          fi

          if [ $FOUND_ISSUES -eq 1 ]; then
            echo ""
            echo "üö® COMPLIANCE CHECK FALLITO"
            echo "Vedi: ODOO_AUTH_SYSTEM.md per le regole"
            exit 1
          fi

          echo "‚úÖ Nessuna credenziale hardcoded trovata"

      - name: üîç Verifica uso di odoo-client.ts deprecato
        run: |
          echo "üîç Verificando uso di odoo-client.ts..."

          # Cerca import di odoo-client in file API
          if grep -r "from '@/lib/odoo-client'" app/api/ --include="*.ts" 2>/dev/null | grep -v "test"; then
            echo "‚ùå ERRORE: Alcuni file API usano ancora odoo-client.ts DEPRECATO"
            echo "Usa invece: import { getOdooSession, callOdoo } from '@/lib/odoo-auth'"
            exit 1
          fi

          echo "‚úÖ Nessun uso di odoo-client.ts trovato"

      - name: üîç Verifica che API controllino cookie
        run: |
          echo "üîç Verificando gestione cookie nelle API..."

          # Trova nuove API route
          NEW_ROUTES=$(find app/api -name "route.ts" -type f)
          FOUND_ISSUES=0

          for file in $NEW_ROUTES; do
            # Salta file di test
            if [[ $file == *"test"* ]]; then
              continue
            fi

            # Verifica che usino getOdooSession
            if ! grep -q "getOdooSession" "$file"; then
              echo "‚ö†Ô∏è  WARNING: $file potrebbe non usare getOdooSession"
              # Non blocchiamo, solo warning
            fi

            # Verifica gestione 401
            if ! grep -q "401" "$file"; then
              echo "‚ö†Ô∏è  WARNING: $file potrebbe non gestire 401 Unauthorized"
            fi
          done

          echo "‚úÖ Verifica API completata"

      - name: ‚úÖ Riepilogo Compliance
        if: success()
        run: |
          echo ""
          echo "üéâ ‚úÖ COMPLIANCE CHECK PASSATO"
          echo ""
          echo "Il codice rispetta ODOO_AUTH_SYSTEM.md:"
          echo "  ‚úÖ Nessuna credenziale hardcoded"
          echo "  ‚úÖ Nessun uso di odoo-client.ts deprecato"
          echo "  ‚úÖ API conformi alle regole di autenticazione"
          echo ""
